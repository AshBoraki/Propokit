
<!-- saved from url=(0168)https://firebasestorage.googleapis.com/v0/b/denali-tech-f22e8.appspot.com/o/public%2Fpages%2Fcover-page-modals.html?alt=media&token=d246f8d0-caf1-4e9e-bce2-5884239ca2ce -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"></head><body><!-- ========================================================
     BEAUTIFUL QR CODE MODAL - Step-by-Step Design
     ======================================================== -->
<div class="modal fade" id="qrModal" tabindex="-1" role="dialog" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Enhanced Header with Progress Indicator -->
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-qrcode"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="qrModalLabel">
              <span class="title-main">QR Code Generator</span>
              <span class="title-subtitle">Create QR codes for easy access</span>
            </h5>
          </div>
        </div>

        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Beautiful Step Counter (like Customer Info Modal) -->
      <div class="progress-steps">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">Choose</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">Configure</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">Preview</div>
        </div>
      </div>

      <div class="modal-body">
        <form id="qr-form">
          <!-- Step 1: Select QR Code Types -->
          <div class="form-step active" id="qr-step-1">
            <div class="step-header">
              <h6><i class="fas fa-list-check"></i> Choose QR Code Types</h6>
              <p>Select up to 2 QR codes</p>
            </div>

            <!-- Existing QR Codes Section -->
            <div class="existing-qr-section" id="existingQrSection">
              <div class="existing-qr-header">
                <h6><i class="fas fa-check-circle text-success"></i> Current QR Codes on Your Page</h6>
                <p>These QR codes are already active on your proposal</p>
              </div>
              <div class="existing-qr-list" id="existingQrList">
                <!-- Existing QR codes will be populated here -->
              </div>
            </div>

            <div class="qr-types-grid">
              <!-- Website QR Option -->
              <div class="qr-type-card" data-type="website">
                <div class="card-header">
                  <div class="type-icon website-icon">
                    <i class="fas fa-globe"></i>
                  </div>
                  <div class="type-info">
                    <h6>Website QR Code</h6>
                    <p>Link to your company website</p>
                  </div>
                  <div class="type-toggle">
                    <input type="checkbox" id="websiteCheckbox" class="qr-checkbox" checked>
                    <label for="websiteCheckbox" class="toggle-switch"></label>
                  </div>
                </div>
                <div class="card-preview">
                  <i class="fas fa-eye"></i> Scan to visit website
                </div>
              </div>

              <!-- PDF Download Option -->
              <div class="qr-type-card" data-type="pdf">
                <div class="card-header">
                  <div class="type-icon pdf-icon">
                    <i class="fas fa-file-pdf"></i>
                  </div>
                  <div class="type-info">
                    <h6>PDF Download QR</h6>
                    <p>Direct link to proposal PDF</p>
                  </div>
                  <div class="type-toggle">
                    <input type="checkbox" id="pdfCheckbox" class="qr-checkbox">
                    <label for="pdfCheckbox" class="toggle-switch"></label>
                  </div>
                </div>
                <div class="card-preview">
                  <i class="fas fa-download"></i> Scan to download PDF
                </div>
              </div>

              <!-- Custom Link Option -->
              <div class="qr-type-card" data-type="custom">
                <div class="card-header">
                  <div class="type-icon custom-icon">
                    <i class="fas fa-link"></i>
                  </div>
                  <div class="type-info">
                    <h6>Custom Link QR</h6>
                    <p>Any custom URL you want</p>
                  </div>
                  <div class="type-toggle">
                    <input type="checkbox" id="customCheckbox" class="qr-checkbox">
                    <label for="customCheckbox" class="toggle-switch"></label>
                  </div>
                </div>
                <div class="card-preview">
                  <i class="fas fa-external-link-alt"></i> Portfolio, social media, etc.
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Configure URLs -->
          <div class="form-step" id="qr-step-2">
            <div class="step-header">
              <h6><i class="fas fa-cog"></i> Configure Your Links</h6>
              <p>Enter URLs for selected QR codes</p>
            </div>

            <div class="url-configuration">
              <!-- Website URL Configuration -->
              <div class="url-config-section" id="website-config">
                <div class="config-header">
                  <div class="config-icon website-icon">
                    <i class="fas fa-globe"></i>
                  </div>
                  <div class="config-title">
                    <h6>Website QR Code</h6>
                    <p>Enter website URL</p>
                  </div>
                </div>
                <div class="url-input-group">
                  <label for="websiteUrlInput" class="input-label">
                    <i class="fas fa-link"></i> Website URL
                  </label>
                  <input type="url" class="form-control qr-input" id="websiteUrlInput"
                         placeholder="https://www.yourcompany.com" value="https://www.denalitechs.com">
                  <div class="input-help">
                    <i class="fas fa-info-circle"></i>
                    Include https://
                  </div>
                </div>
              </div>

              <!-- PDF URL Configuration -->
              <div class="url-config-section" id="pdf-config">
                <div class="config-header">
                  <div class="config-icon pdf-icon">
                    <i class="fas fa-file-pdf"></i>
                  </div>
                  <div class="config-title">
                    <h6>PDF Download QR</h6>
                    <p>Enter PDF link</p>
                  </div>
                </div>
                <div class="url-input-group">
                  <label for="pdfUrlInput" class="input-label">
                    <i class="fas fa-file-pdf"></i> PDF URL
                  </label>
                  <input type="url" class="form-control qr-input" id="pdfUrlInput"
                         placeholder="https://drive.google.com/... or direct PDF link">
                  <div class="input-help">
                    <i class="fas fa-lightbulb"></i>
                    Google Drive, Dropbox, or direct PDF URL
                  </div>
                </div>
              </div>

              <!-- Custom URL Configuration -->
              <div class="url-config-section" id="custom-config">
                <div class="config-header">
                  <div class="config-icon custom-icon">
                    <i class="fas fa-link"></i>
                  </div>
                  <div class="config-title">
                    <h6>Custom Link QR</h6>
                    <p>Create QR for any link</p>
                  </div>
                </div>
                <div class="url-input-group">
                  <label for="customLabelInput" class="input-label">
                    <i class="fas fa-tag"></i> Label
                  </label>
                  <input type="text" class="form-control qr-input" id="customLabelInput"
                         placeholder="e.g., Portfolio, Instagram, Contact Form" value="Custom Link">
                  <div class="input-help">
                    <i class="fas fa-info-circle"></i>
                    Label appears next to QR code
                  </div>
                </div>
                <div class="url-input-group">
                  <label for="customUrlInput" class="input-label">
                    <i class="fas fa-external-link-alt"></i> Custom URL
                  </label>
                  <input type="url" class="form-control qr-input" id="customUrlInput"
                         placeholder="https://www.instagram.com/yourcompany">
                  <div class="input-help">
                    <i class="fas fa-lightbulb"></i>
                    Website, social media, or online resource
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Preview -->
          <div class="form-step" id="qr-step-3">
            <div class="step-header">
              <h6><i class="fas fa-eye"></i> Preview Your QR Codes</h6>
              <p>Review before adding to proposal</p>
            </div>

            <div class="qr-preview-grid" id="qr-preview-container">
              <!-- QR previews will be generated here -->
            </div>

            <div class="preview-actions">
              <div class="preview-info">
                <i class="fas fa-info-circle"></i>
                <span id="qr-count-text">No QR codes selected</span>
              </div>
              <div class="preview-controls">
                <button type="button" class="btn btn-outline-danger btn-sm" id="clearAllQrBtn">
                  <i class="fas fa-trash-alt"></i> Clear All QR Codes
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer qr-modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-outline-primary" id="prevQrStepBtn">
          <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button type="button" class="btn btn-primary" id="nextQrStepBtn">
          Next <i class="fas fa-arrow-right"></i>
        </button>
        <button type="button" class="btn btn-success" id="generateQR">
          <i class="fas fa-qrcode"></i> Generate QR Codes
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Beautiful QR Modal functionality with step-by-step navigation
  $(document).ready(function() {
    let currentQrStep = 1;
    const totalQrSteps = 3;

    // Check QR code library availability
    function checkQrLibraryAvailability() {
      console.log('Checking QR code library availability...');
      if (typeof QRCode !== 'undefined') {
        console.log('QRCode library found:', typeof QRCode);
        if (QRCode.prototype && typeof QRCode.prototype.makeCode === 'function') {
          console.log('Using davidshimjs-qrcodejs library');
        } else {
          console.log('Using qrcode-generator library');
        }
      } else if (typeof qrcode !== 'undefined') {
        console.log('qrcode library found:', typeof qrcode);
      } else {
        console.error('No QR code library found!');
      }
    }

    // Check libraries when modal is ready
    checkQrLibraryAvailability();

  // QR Modal Step Navigation Functions
  function showQrStep(stepNumber) {
    // Store the step number
    currentQrStep = stepNumber;

    // Hide all steps
    $('.form-step').removeClass('active');
    $('.step').removeClass('active completed');

    // Show current step
    $(`#qr-step-${stepNumber}`).addClass('active');

    // Update progress bar with proper state preservation
    for (let i = 1; i <= totalQrSteps; i++) {
      const stepElement = $(`.step[data-step="${i}"]`);
      if (i < stepNumber) {
        stepElement.addClass('completed');
      } else if (i === stepNumber) {
        stepElement.addClass('active');
      } else {
        stepElement.removeClass('active completed');
      }
    }

    updateQrNavigationButtons();
  }

  function updateQrNavigationButtons() {
    // Show/hide navigation buttons
    if (currentQrStep === 1) {
      $('#prevQrStepBtn').hide();
      $('#nextQrStepBtn').show();
      $('#generateQR').hide();
    } else if (currentQrStep === totalQrSteps) {
      $('#prevQrStepBtn').show();
      $('#nextQrStepBtn').hide();
      $('#generateQR').show();
    } else {
      $('#prevQrStepBtn').show();
      $('#nextQrStepBtn').show();
      $('#generateQR').hide();
    }
  }

  function validateQrCurrentStep() {
    if (currentQrStep === 1) {
      // Check if at least one QR type is selected
      const websiteChecked = $('#websiteCheckbox').is(':checked');
      const pdfChecked = $('#pdfCheckbox').is(':checked');
      const customChecked = $('#customCheckbox').is(':checked');

      if (!websiteChecked && !pdfChecked && !customChecked) {
        alert('Please select at least one QR code type.');
        return false;
      }
      return true;
    }

    if (currentQrStep === 2) {
      // Validate URLs for selected types
      const websiteChecked = $('#websiteCheckbox').is(':checked');
      const pdfChecked = $('#pdfCheckbox').is(':checked');
      const customChecked = $('#customCheckbox').is(':checked');

      if (websiteChecked && !$('#websiteUrlInput').val().trim()) {
        alert('Please enter a website URL.');
        $('#websiteUrlInput').focus();
        return false;
      }

      if (pdfChecked && !$('#pdfUrlInput').val().trim()) {
        alert('Please enter a PDF URL.');
        $('#pdfUrlInput').focus();
        return false;
      }

      if (customChecked) {
        if (!$('#customUrlInput').val().trim()) {
          alert('Please enter a custom URL.');
          $('#customUrlInput').focus();
          return false;
        }
        if (!$('#customLabelInput').val().trim()) {
          alert('Please enter a label for the custom QR code.');
          $('#customLabelInput').focus();
          return false;
        }
      }
      return true;
    }

    return true;
  }

  // Step Navigation Event Handlers
  $('#nextQrStepBtn').click(function() {
    if (!validateQrCurrentStep()) return;

    if (currentQrStep === 1) {
      updateConfigurationStep();
    } else if (currentQrStep === 2) {
      generateQrPreview();
    }

    if (currentQrStep < totalQrSteps) {
      showQrStep(currentQrStep + 1);
    }
  });

  $('#prevQrStepBtn').click(function() {
    if (currentQrStep > 1) {
      showQrStep(currentQrStep - 1);
    }
  });

  // Handle QR type selection
  $(document).on('click', '.qr-type-card', function(e) {
    // Don't trigger if clicking on the toggle switch itself
    if ($(e.target).closest('.type-toggle').length) return;

    const checkbox = $(this).find('.qr-checkbox');
    checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
  });

  // Handle checkbox changes - step-aware action with 2-QR-code limit
  $(document).on('change', '.qr-checkbox', function() {
    const card = $(this).closest('.qr-type-card');
    const type = card.data('type');
    const isChecked = $(this).is(':checked');
    const checkboxId = $(this).attr('id');

    console.log(`Step ${currentQrStep}: Slider ${checkboxId} changed to: ${isChecked ? 'ON' : 'OFF'}`);

    // Check if trying to select more than 2 QR codes
    if (isChecked) {
      const currentlyChecked = $('.qr-checkbox:checked').length;
      if (currentlyChecked > 2) {
        // Prevent selection - uncheck this checkbox
        $(this).prop('checked', false);
        console.log(`Cannot select more than 2 QR codes. ${type} QR code selection blocked.`);

        // Show user feedback
        showQrLimitMessage();
        return;
      }

      card.addClass('selected');
      console.log(`Selected ${type} QR code for creation`);
    } else {
      card.removeClass('selected');
      console.log(`Deselected ${type} QR code`);

      // If we're past step 1 and user deselects, immediately remove from Firebase
      if (currentQrStep > 1 && window.qrCodesRef && window.currentFirebaseUID) {
        removeQrCodeFromFirebase(type);
      }
    }

    updateTypeCount();

    // Update configuration step if we're on step 1 or 2
    if (currentQrStep <= 2) {
      updateConfigurationStep();
    }

    // Update preview if we're on step 3
    if (currentQrStep === 3) {
      generateQrPreview();
    }

    saveToggleStates(); // Save state whenever toggle changes
  });

  // Handle toggle switch clicks
  $(document).on('click', '.toggle-switch', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const checkbox = $(this).prev('.qr-checkbox');
    checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
  });

  // Handle URL input changes - step-aware saving
  $(document).on('input', '#websiteUrlInput', function() {
    const url = $(this).val().trim();
    console.log(`Step ${currentQrStep}: Website URL changed:`, url);

    // Auto-save if we're on step 2 or 3 and checkbox is checked
    if (currentQrStep >= 2 && $('#websiteCheckbox').is(':checked') && url && window.qrCodesRef) {
      console.log('Auto-saving website URL to Firebase');
      saveQrCodeToFirebase('website', url);
    }

    // Update preview if we're on step 3
    if (currentQrStep === 3) {
      generateQrPreview();
    }
  });

  $(document).on('input', '#pdfUrlInput', function() {
    const url = $(this).val().trim();
    console.log(`Step ${currentQrStep}: PDF URL changed:`, url);

    // Auto-save if we're on step 2 or 3 and checkbox is checked
    if (currentQrStep >= 2 && $('#pdfCheckbox').is(':checked') && url && window.qrCodesRef) {
      console.log('Auto-saving PDF URL to Firebase');
      saveQrCodeToFirebase('pdf', url);
    }

    // Update preview if we're on step 3
    if (currentQrStep === 3) {
      generateQrPreview();
    }
  });

  $(document).on('input', '#customUrlInput', function() {
    const url = $(this).val().trim();
    console.log(`Step ${currentQrStep}: Custom URL changed:`, url);

    // Auto-save if we're on step 2 or 3 and checkbox is checked
    if (currentQrStep >= 2 && $('#customCheckbox').is(':checked') && url && window.qrCodesRef) {
      console.log('Auto-saving custom URL to Firebase');
      saveQrCodeToFirebase('custom', url);
    }

    // Update preview if we're on step 3
    if (currentQrStep === 3) {
      generateQrPreview();
    }
  });

  // Handle Clear All QR Codes button
  $('#clearAllQrBtn').click(function() {
    console.log('Clearing all QR codes');

    // Uncheck all checkboxes
    $('.qr-checkbox').prop('checked', false).trigger('change');

    // Clear all Firebase data
    if (window.qrCodesRef && window.currentFirebaseUID) {
      const clearData = {
        showWebsiteQr: false,
        showPdfQr: false,
        showCustomQr: false,
        websiteUrl: '',
        pdfUrl: '',
        customUrl: '',
        customLabel: 'Custom Link'
      };

      window.qrCodesRef.update(clearData).then(() => {
        console.log('All QR codes cleared from Firebase');
      }).catch((error) => {
        console.error('Error clearing QR codes:', error);
      });
    }

    // Clear preview container
    $('#qr-preview-container').empty();
    $('#qr-count-text').text('No QR codes selected');
    $('#clearAllQrBtn').hide();

    // Clear URL inputs
    $('#websiteUrlInput, #pdfUrlInput, #customUrlInput').val('');
    $('#customLabelInput').val('Custom Link');

    // Go back to step 1
    showQrStep(1);
  });

  function updateTypeCount() {
    const selectedCount = $('.qr-checkbox:checked').length;
    let countText;

    if (selectedCount === 0) {
      countText = 'No QR codes selected';
    } else if (selectedCount === 1) {
      countText = '1 QR code selected';
    } else if (selectedCount === 2) {
      countText = '2 QR codes selected (maximum reached)';
    } else {
      countText = `${selectedCount} QR codes selected`;
    }

    $('#qr-count-text').text(countText);

    // Update visual feedback for maximum selection
    if (selectedCount >= 2) {
      $('.qr-type-card:not(.selected)').addClass('max-reached');
    } else {
      $('.qr-type-card').removeClass('max-reached');
    }
  }

  function showQrLimitMessage() {
    // Create a temporary notification message
    const message = $('<div class="qr-limit-message">')
      .html('<i class="fas fa-info-circle"></i> Maximum 2 QR codes allowed at once')
      .css({
        position: 'fixed',
        top: '20px',
        right: '20px',
        background: 'linear-gradient(135deg, #ff6b6b, #ee5a24)',
        color: 'white',
        padding: '12px 20px',
        borderRadius: '8px',
        boxShadow: '0 4px 15px rgba(0,0,0,0.2)',
        zIndex: '10000',
        fontSize: '14px',
        fontWeight: '500',
        animation: 'slideInRight 0.3s ease'
      });

    // Add to page
    $('body').append(message);

    // Remove after 3 seconds
    setTimeout(() => {
      message.fadeOut(300, function() {
        $(this).remove();
      });
    }, 3000);
  }

  function updateConfigurationStep() {
    // Show/hide configuration sections based on selected types
    const websiteChecked = $('#websiteCheckbox').is(':checked');
    const pdfChecked = $('#pdfCheckbox').is(':checked');
    const customChecked = $('#customCheckbox').is(':checked');

    console.log('Configuration update:', { websiteChecked, pdfChecked, customChecked });

    // Show/hide config sections with animation
    if (websiteChecked) {
      $('#website-config').slideDown(200);
    } else {
      $('#website-config').slideUp(200);
    }

    if (pdfChecked) {
      $('#pdf-config').slideDown(200);
    } else {
      $('#pdf-config').slideUp(200);
    }

    if (customChecked) {
      $('#custom-config').slideDown(200);
    } else {
      $('#custom-config').slideUp(200);
    }
  }

  function generateQrPreview() {
    console.log('Generating QR preview...');
    const container = $('#qr-preview-container');
    container.empty();

    const websiteChecked = $('#websiteCheckbox').is(':checked');
    const pdfChecked = $('#pdfCheckbox').is(':checked');
    const customChecked = $('#customCheckbox').is(':checked');

    console.log('QR checkboxes state:', { websiteChecked, pdfChecked, customChecked });

    let previewCount = 0;

    if (websiteChecked && $('#websiteUrlInput').val().trim()) {
      const websiteUrl = $('#websiteUrlInput').val().trim();
      console.log('Creating website QR preview for:', websiteUrl);
      const previewCard = createQrPreviewCard('Website QR Code', websiteUrl, 'website-icon');
      container.append(previewCard);
      previewCount++;
    }

    if (pdfChecked && $('#pdfUrlInput').val().trim()) {
      const pdfUrl = $('#pdfUrlInput').val().trim();
      console.log('Creating PDF QR preview for:', pdfUrl);
      const previewCard = createQrPreviewCard('PDF Download QR', pdfUrl, 'pdf-icon');
      container.append(previewCard);
      previewCount++;
    }

    if (customChecked && $('#customUrlInput').val().trim()) {
      const customUrl = $('#customUrlInput').val().trim();
      const customLabel = $('#customLabelInput').val().trim() || 'Custom Link';
      console.log('Creating custom QR preview for:', customUrl, 'with label:', customLabel);
      const previewCard = createQrPreviewCard(customLabel, customUrl, 'custom-icon');
      container.append(previewCard);
      previewCount++;
    }

    console.log(`Generated ${previewCount} QR preview cards`);

    // Update count text
    const countText = previewCount === 0 ? 'No QR codes to generate' :
                     previewCount === 1 ? '1 QR code ready to generate' :
                     `${previewCount} QR codes ready to generate`;
    $('#qr-count-text').text(countText);

    // Show/hide Clear All button
    if (previewCount > 0) {
      $('#clearAllQrBtn').show();
    } else {
      $('#clearAllQrBtn').hide();
    }
  }

  function createQrPreviewCard(title, url, iconClass) {
    const previewId = 'preview-qr-' + Date.now() + Math.random().toString(36).substr(2, 9);

    // Determine QR type from title
    let qrType = 'custom';
    if (title.includes('Website')) qrType = 'website';
    else if (title.includes('PDF')) qrType = 'pdf';

    // Create the card HTML
    const cardHtml = `
      <div class="qr-preview-card" data-qr-type="${qrType}">
        <div class="preview-qr-container">
          <div class="qr-code-preview" id="${previewId}"></div>
        </div>
        <h6>${title}</h6>
        <p>${url}</p>
      </div>
    `;

    // Generate actual QR code after adding to DOM
    setTimeout(() => {
      try {
        const element = document.getElementById(previewId);
        if (!element) {
          console.error(`Element with ID ${previewId} not found`);
          return;
        }

        // Clear any existing content
        element.innerHTML = '';

        if (typeof QRCode !== 'undefined') {
          console.log(`Generating QR preview for ${title}:`, url);

          // Check which QRCode library is available and use the correct API
          try {
            // Try the davidshimjs-qrcodejs library first (more common)
            if (QRCode.prototype && typeof QRCode.prototype.makeCode === 'function') {
              new QRCode(element, {
                text: url,
                width: 80,
                height: 80,
                colorDark: '#000000',
                colorLight: '#ffffff'
              });
            } else {
              // Fallback to qrcode-generator library
              const qr = qrcode(0, 'M');
              qr.addData(url);
              qr.make();
              element.innerHTML = qr.createImgTag(4, 4);
            }

            console.log(`QR preview generated successfully for ${title}`);
          } catch (qrError) {
            console.error(`QR generation error for ${title}:`, qrError);
            // Fallback to icon display
            element.innerHTML = `
              <div class="type-icon ${iconClass}">
                <i class="fas ${getIconForType(iconClass)}"></i>
              </div>
            `;
          }
        } else {
          console.warn('QRCode library not loaded, showing fallback icon');
          // Fallback if QRCode library not loaded
          element.innerHTML = `
            <div class="type-icon ${iconClass}">
              <i class="fas ${getIconForType(iconClass)}"></i>
            </div>
          `;
        }
      } catch (error) {
        console.error(`Error generating QR preview for ${title}:`, error);
        // Fallback display
        const element = document.getElementById(previewId);
        if (element) {
          element.innerHTML = `
            <div class="type-icon ${iconClass}">
              <i class="fas ${getIconForType(iconClass)}"></i>
            </div>
          `;
        }
      }
    }, 150); // Increased timeout for better DOM readiness

    return cardHtml;
  }

  function getIconForType(iconClass) {
    switch(iconClass) {
      case 'website-icon': return 'fa-globe';
      case 'pdf-icon': return 'fa-file-pdf';
      case 'custom-icon': return 'fa-link';
      default: return 'fa-qrcode';
    }
  }

  // Helper function to get URL for QR type
  function getUrlForType(type) {
    switch(type) {
      case 'website': return $('#websiteUrlInput').val().trim();
      case 'pdf': return $('#pdfUrlInput').val().trim();
      case 'custom': return $('#customUrlInput').val().trim();
      default: return '';
    }
  }

  // Immediately save single QR code to Firebase
  function saveQrCodeToFirebase(type, url) {
    if (!window.qrCodesRef || !url) return;

    console.log(`Saving ${type} QR code to Firebase:`, url);

    const updateData = {};
    switch(type) {
      case 'website':
        updateData.websiteUrl = url;
        updateData.showWebsiteQr = true;
        break;
      case 'pdf':
        updateData.pdfUrl = url;
        updateData.showPdfQr = true;
        break;
      case 'custom':
        updateData.customUrl = url;
        updateData.customLabel = $('#customLabelInput').val().trim() || 'Custom Link';
        updateData.showCustomQr = true;
        break;
    }

    window.qrCodesRef.update(updateData).then(() => {
      console.log(`${type} QR code saved successfully`);
    }).catch((error) => {
      console.error(`Error saving ${type} QR code:`, error);
    });
  }

  // Immediately remove single QR code from Firebase
  function removeQrCodeFromFirebase(type) {
    if (!window.qrCodesRef) return;

    console.log(`Removing ${type} QR code from Firebase`);

    const updateData = {};
    switch(type) {
      case 'website':
        updateData.showWebsiteQr = false;
        break;
      case 'pdf':
        updateData.showPdfQr = false;
        break;
      case 'custom':
        updateData.showCustomQr = false;
        break;
    }

    window.qrCodesRef.update(updateData).then(() => {
      console.log(`${type} QR code removed successfully`);
    }).catch((error) => {
      console.error(`Error removing ${type} QR code:`, error);
    });
  }

  // Populate existing QR codes section
  function populateExistingQrCodes(data = {}) {
    const existingQrList = $('#existingQrList');
    const existingQrSection = $('#existingQrSection');
    existingQrList.empty();

    let hasExistingQr = false;

    // Check for website QR
    if (data.showWebsiteQr && data.websiteUrl) {
      hasExistingQr = true;
      const websiteItem = createExistingQrItem('website', 'Website QR Code', data.websiteUrl, 'website-icon', 'fas fa-globe');
      existingQrList.append(websiteItem);
    }

    // Check for PDF QR
    if (data.showPdfQr && data.pdfUrl) {
      hasExistingQr = true;
      const pdfItem = createExistingQrItem('pdf', 'PDF Download QR', data.pdfUrl, 'pdf-icon', 'fas fa-file-pdf');
      existingQrList.append(pdfItem);
    }

    // Check for custom QR
    if (data.showCustomQr && data.customUrl) {
      hasExistingQr = true;
      const customLabel = data.customLabel || 'Custom Link';
      const customItem = createExistingQrItem('custom', customLabel, data.customUrl, 'custom-icon', 'fas fa-link');
      existingQrList.append(customItem);
    }

    // Show/hide the existing QR section
    if (hasExistingQr) {
      existingQrSection.show();
    } else {
      existingQrSection.hide();
    }
  }

  // Create existing QR item HTML
  function createExistingQrItem(type, title, url, iconClass, iconName) {
    return `
      <div class="existing-qr-item" data-qr-type="${type}">
        <div class="existing-qr-info">
          <div class="existing-qr-icon ${iconClass}">
            <i class="${iconName}"></i>
          </div>
          <div class="existing-qr-details">
            <h6>${title}</h6>
            <p>${url}</p>
          </div>
        </div>
        <button class="existing-qr-remove" data-qr-type="${type}" title="Remove ${title}">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
  }

  // Handle existing QR remove button clicks
  $(document).on('click', '.existing-qr-remove', function(e) {
    e.preventDefault();
    e.stopPropagation();

    const qrType = $(this).data('qr-type');
    const qrItem = $(this).closest('.existing-qr-item');
    const qrTitle = qrItem.find('.existing-qr-details h6').text();

    console.log(`Removing existing ${qrType} QR code`);

    // Uncheck the corresponding checkbox
    $(`#${qrType}Checkbox`).prop('checked', false);

    // Remove from Firebase immediately
    if (window.qrCodesRef && window.currentFirebaseUID) {
      removeQrCodeFromFirebase(qrType);
    }

    // Remove the item with animation
    qrItem.fadeOut(300, function() {
      $(this).remove();
      // Check if any existing QR codes remain
      if ($('.existing-qr-item').length === 0) {
        $('#existingQrSection').hide();
      }
    });

    // Update the checkboxes and save states
    saveToggleStates();
    updateTypeCount();
  });

  // Save toggle states to session storage
  function saveToggleStates() {
    const toggleStates = {
      website: $('#websiteCheckbox').prop('checked'),
      pdf: $('#pdfCheckbox').prop('checked'),
      custom: $('#customCheckbox').prop('checked')
    };
    sessionStorage.setItem('qrModalToggleStates', JSON.stringify(toggleStates));
    console.log('Toggle states saved:', toggleStates);
  }

  // Restore toggle states from session storage
  function restoreToggleStates() {
    try {
      const savedStates = sessionStorage.getItem('qrModalToggleStates');
      console.log('Restoring toggle states:', savedStates);
      if (savedStates) {
        const toggleStates = JSON.parse(savedStates);

        // Set checkboxes
        $('#websiteCheckbox').prop('checked', toggleStates.website || false);
        $('#pdfCheckbox').prop('checked', toggleStates.pdf || false);
        $('#customCheckbox').prop('checked', toggleStates.custom || false);

        // Update card visual states
        $('.qr-checkbox').each(function() {
          const card = $(this).closest('.qr-type-card');
          const isChecked = $(this).is(':checked');
          console.log(`Checkbox ${$(this).attr('id')}: ${isChecked}`);
          if (isChecked) {
            card.addClass('selected');
          } else {
            card.removeClass('selected');
          }
        });

        // Update configuration sections visibility
        updateConfigurationStep();
        updateTypeCount();
        console.log('Toggle states restored successfully');
      }
    } catch (error) {
      console.log('No saved toggle states found:', error);
    }
  }

  // Initialize modal when shown
  $('#qrModal').on('shown.bs.modal', function() {
    try {
      // Always start at step 1 when reopening modal
      showQrStep(1);
      updateTypeCount();

      // Check if we have Firebase data first, then restore states
      if (window.qrCodesRef && window.currentFirebaseUID) {
        window.qrCodesRef.once('value', function(snapshot) {
          try {
            const data = snapshot.val();
            if (data) {
              console.log('Loading Firebase data:', data);
              // Populate form with existing data
              $('#websiteUrlInput').val(data.websiteUrl || '');
              $('#pdfUrlInput').val(data.pdfUrl || '');
              $('#customUrlInput').val(data.customUrl || '');
              $('#customLabelInput').val(data.customLabel || 'Custom Link');

              // Set checkbox states from Firebase - if QR was created, show it as checked
              const websiteQrExists = data.showWebsiteQr === true && data.websiteUrl && data.websiteUrl.trim() !== '';
              const pdfQrExists = data.showPdfQr === true && data.pdfUrl && data.pdfUrl.trim() !== '';
              const customQrExists = data.showCustomQr === true && data.customUrl && data.customUrl.trim() !== '';

              console.log('QR existence check:', {
                websiteQrExists,
                pdfQrExists,
                customQrExists,
                rawData: {
                  showWebsiteQr: data.showWebsiteQr,
                  showPdfQr: data.showPdfQr,
                  showCustomQr: data.showCustomQr,
                  websiteUrl: data.websiteUrl,
                  pdfUrl: data.pdfUrl,
                  customUrl: data.customUrl
                }
              });

              $('#websiteCheckbox').prop('checked', websiteQrExists);
              $('#pdfCheckbox').prop('checked', pdfQrExists);
              $('#customCheckbox').prop('checked', customQrExists);

              console.log('QR Data Analysis:', {
                websiteQrExists,
                pdfQrExists,
                customQrExists,
                checkboxStates: {
                  website: $('#websiteCheckbox').is(':checked'),
                  pdf: $('#pdfCheckbox').is(':checked'),
                  custom: $('#customCheckbox').is(':checked')
                }
              });

              // Update UI properly
              setTimeout(() => {
                $('.qr-checkbox').each(function() {
                  const card = $(this).closest('.qr-type-card');
                  if ($(this).is(':checked')) {
                    card.addClass('selected');
                  } else {
                    card.removeClass('selected');
                  }
                });
                updateTypeCount();
                updateConfigurationStep();
                populateExistingQrCodes(data); // Show existing QR codes
                saveToggleStates(); // Save Firebase state to session
                console.log('Firebase data loaded, UI updated, and states saved to session');
              }, 100);
            } else {
              console.log('No Firebase data found - checking sessionStorage');
              // No Firebase data, use sessionStorage
              const savedStates = sessionStorage.getItem('qrModalToggleStates');
              if (savedStates) {
                console.log('Found sessionStorage data, restoring...');
                restoreToggleStates();
              } else {
                console.log('No saved states found - starting fresh');
                // First time user - no states to restore
                updateTypeCount();
              }
            }
          } catch (error) {
            console.error('Error loading QR data:', error);
          }
        });
      } else {
        console.log('No Firebase, using sessionStorage and localStorage');
        // If no Firebase, use sessionStorage first, then try localStorage
        restoreToggleStates();

        try {
          const savedQrData = sessionStorage.getItem('qrCodesData');
          if (savedQrData) {
            const data = JSON.parse(savedQrData);
            $('#websiteUrlInput').val(data.websiteUrl || '');
            $('#pdfUrlInput').val(data.pdfUrl || '');
            $('#customUrlInput').val(data.customUrl || '');
            $('#customLabelInput').val(data.customLabel || 'Custom Link');

            // Only update URL inputs, not checkbox states (use sessionStorage for that)
            console.log('Loaded localStorage URLs');
          }
        } catch (error) {
          console.error('Error loading localStorage QR data:', error);
        }
      }
    } catch (error) {
      console.error('Error initializing QR modal:', error);
    }
  });

  // Enhanced generateQR button with loading state and Firebase integration
  $('#generateQR').click(function() {
    if (!validateQrCurrentStep()) return;

    const $btn = $(this);
    const originalText = $btn.html();

    // Show loading state
    $btn.html('<i class="fas fa-spinner fa-spin"></i> Generating...').prop('disabled', true);

    // Validate at least one QR code is selected
    const websiteChecked = $('#websiteCheckbox').is(':checked');
    const pdfChecked = $('#pdfCheckbox').is(':checked');
    const customChecked = $('#customCheckbox').is(':checked');

    if (!websiteChecked && !pdfChecked && !customChecked) {
      alert('Please select at least one QR code type to generate.');
      $btn.html(originalText).prop('disabled', false);
      return;
    }

    // Validate URLs for checked items
    const websiteUrl = $('#websiteUrlInput').val().trim();
    const pdfUrl = $('#pdfUrlInput').val().trim();
    const customUrl = $('#customUrlInput').val().trim();

    if (websiteChecked && !websiteUrl) {
      alert('Please enter a website URL or uncheck the website option.');
      $('#websiteUrlInput').focus();
      $btn.html(originalText).prop('disabled', false);
      return;
    }

    if (pdfChecked && !pdfUrl) {
      alert('Please enter a PDF URL or uncheck the PDF option.');
      $('#pdfUrlInput').focus();
      $btn.html(originalText).prop('disabled', false);
      return;
    }

    if (customChecked && !customUrl) {
      alert('Please enter a custom link URL or uncheck the custom option.');
      $('#customUrlInput').focus();
      $btn.html(originalText).prop('disabled', false);
      return;
    }

    // Create a complete data object, including the checkbox states
    const qrData = {
      websiteUrl: websiteUrl,
      pdfUrl: pdfUrl,
      customUrl: customUrl,
      customLabel: $('#customLabelInput').val().trim() || 'Custom Link',
      showWebsiteQr: websiteChecked && websiteUrl,
      showPdfQr: pdfChecked && pdfUrl,
      showCustomQr: customChecked && customUrl
    };

    // If Firebase is available, save to Firebase
    if (window.qrCodesRef && window.currentFirebaseUID) {
      window.qrCodesRef.set(qrData).then(() => {
        // Success state
        $btn.html('<i class="fas fa-check"></i> Success!').addClass('btn-success');

        // Close modal after success
        setTimeout(() => {
          $('#qrModal').modal('hide');
          $btn.html(originalText).prop('disabled', false).removeClass('btn-success');
        }, 1000);
      }).catch((error) => {
        console.error('Error saving QR codes to Firebase:', error);
        alert('Error saving QR codes. Please try again.');
        $btn.html(originalText).prop('disabled', false);
      });
    } else {
      // If no Firebase login, save to sessionStorage and generate QR codes directly
      sessionStorage.setItem('qrCodesData', JSON.stringify(qrData));
      if (typeof generatePageQRCodes === 'function') {
        generatePageQRCodes(qrData);
      }

      // Success state
      $btn.html('<i class="fas fa-check"></i> Success!').addClass('btn-success');

      // Show success message
      const qrCount = [qrData.showWebsiteQr, qrData.showPdfQr, qrData.showCustomQr].filter(Boolean).length;

      setTimeout(() => {
        $('#qrModal').modal('hide');
        $btn.html(originalText).prop('disabled', false).removeClass('btn-success');
        alert(`✅ ${qrCount} QR code(s) added to your proposal! They will appear on the cover page.`);
      }, 1000);
    }
  });

  // Reset modal state when closed
  $('#qrModal').on('hidden.bs.modal', function() {
    console.log('QR Modal closed - preserving QR states');
    // Clear the step from session storage so it always starts at step 1
    sessionStorage.removeItem('qrModalCurrentStep');

    // Clear URL inputs and preview but KEEP toggle states if we have Firebase data
    $('#websiteUrlInput, #pdfUrlInput, #customUrlInput').val('');
    $('#qr-preview-container').empty();

    // Make sure button is reset
    $('#generateQR').html('<i class="fas fa-qrcode"></i> Generate QR Codes').prop('disabled', false).removeClass('btn-success');

    // Don't clear toggle states - they should persist based on Firebase data
  });
});
</script>


<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-trash-alt"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title">
              <span class="title-main">Confirm Delete</span>
              <span class="title-subtitle">This action cannot be undone</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="delete-message">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Are you sure you want to delete this image? This action cannot be undone.</p>
      </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          <i class="fas fa-trash-alt"></i> Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title">
              <span class="title-main">Rename Image</span>
              <span class="title-subtitle">Enter a new name for your image</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="newNameInput">
            <i class="fas fa-image"></i>
            New Image Name
          </label>
          <input type="text" class="form-control" id="newNameInput"
                 placeholder="Enter new name">
          <div class="input-focus-border"></div>
      </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-primary" id="confirmRename">
          <i class="fas fa-save"></i> Rename
        </button>
      </div>
    </div>
  </div>
</div>
<!-- End Combined Modal -->

  <!-- ========== MODAL: Edit Company Info ========== -->
  <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="header-text">
              <h5 class="modal-title" id="infoModalLabel">
                <span class="title-main">Company Information</span>
                <span class="title-subtitle">Edit your company details for the cover page</span>
              </h5>
            </div>
          </div>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body company-modal-body">
          <form id="companyInfoForm">
            <!-- Company Name -->
            <div class="company-field">
              <div class="field-icon">
                <i class="fas fa-building"></i>
              </div>
              <div class="field-content">
                <label for="companyName" class="company-label">Company Name</label>
                <input type="text"
                       class="company-input"
                       id="companyName"
                       value="Denali Tech"
                       placeholder="Enter your company name"
                       required>
              </div>
            </div>

            <!-- Company Address -->
            <div class="company-field">
              <div class="field-icon">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="field-content">
                <label for="companyAddress" class="company-label">Company Address</label>
                <input type="text"
                       class="company-input"
                       id="companyAddress"
                       value="800 W Central Rd Suite 130, Mt Prospect, IL 60056"
                       placeholder="Enter your company address"
                       required>
              </div>
            </div>

            <!-- Phone Number -->
            <div class="company-field">
              <div class="field-icon">
                <i class="fas fa-phone"></i>
              </div>
              <div class="field-content">
                <label for="companyPhone" class="company-label">Phone Number</label>
                <input type="tel"
                       class="company-input"
                       id="companyPhone"
                       value="(312) 500-3053"
                       placeholder="(123) 456-7890"
                       required>
              </div>
            </div>

            <!-- Email Address -->
            <div class="company-field">
              <div class="field-icon">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="field-content">
                <label for="companyEmail" class="company-label">Email Address</label>
                <input type="email"
                       class="company-input"
                       id="companyEmail"
                       value="AshBoraki@DenaliTechs.com"
                       placeholder="your@email.com"
                       required>
              </div>
            </div>

            <!-- Website -->
            <div class="company-field">
              <div class="field-icon">
                <i class="fas fa-globe"></i>
              </div>
              <div class="field-content">
                <label for="companyWebsite" class="company-label">Website</label>
                <input type="url"
                       class="company-input"
                       id="companyWebsite"
                       value="www.DenaliTechs.com"
                       placeholder="www.yourcompany.com"
                       required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer company-modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="saveChangesBtn">
            <i class="fas fa-save"></i> Save Company Info
          </button>
        </div>
      </div>
    </div>
  </div>
   <!-- ========================================================
     COMBINED SINGLE MODAL: Image Selection + Cropping (Improved Replacement)
     ======================================================== -->
<div class="modal fade" id="combinedImageModal" tabindex="-1" role="dialog" aria-labelledby="combinedImageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-image"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="combinedImageModalLabel">
              <span class="title-main">Image Manager</span>
              <span class="title-subtitle">Select, upload, and crop your images</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="image-manager-container">
        <!-- Left Column: Upload + Image List -->
          <div class="image-sidebar">
            <!-- Upload Section -->
            <div class="upload-section">
              <label for="combinedUploadInput" class="upload-btn">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Upload New Image</span>
                <small>Click to browse or drag & drop</small>
            </label>
              <input type="file" id="combinedUploadInput" accept="image/*">
          </div>

            <!-- Search Section -->
            <div class="search-section">
              <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="combinedImageSearchInput" class="search-input" placeholder="Search your images...">
          </div>
            </div>

            <!-- Image List -->
            <div class="image-list-container">
              <div id="combinedImageList" class="image-grid">
                <!-- Images will be loaded here -->
              </div>
              <div id="combinedImageListStatus" class="status-message">
                <div class="empty-state">
                  <i class="fas fa-images"></i>
                  <h4>No Images Yet</h4>
                  <p>Upload your first image to get started!</p>
                </div>
              </div>
            </div>

          <!-- Progress Bar -->
            <div id="progressContainer" class="progress-container">
            <div class="progress">
              <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
              <p id="progressText" class="progress-text">Uploading...</p>
          </div>
        </div>
        <!-- Right Column: Crop Container + Controls -->
          <div class="crop-section">
            <!-- Canvas Container -->
            <div class="crop-container">
              <div class="canvas-wrapper">
                <canvas id="combinedCanvas"></canvas>
                <div id="cropGrid" class="crop-grid">
                  <div id="gridLines" class="grid-lines">
                    <div class="grid-line horizontal"></div>
                    <div class="grid-line horizontal"></div>
                    <div class="grid-line vertical"></div>
                    <div class="grid-line vertical"></div>
            </div>
          </div>
                <div class="canvas-overlay">
                  <div class="overlay-message">
                    <i class="fas fa-image"></i>
                    <h4>Select an Image</h4>
                    <p>Choose from your gallery or upload a new image to start editing</p>
          </div>
                </div>
              </div>
            </div>

            <!-- Simplified Crop Controls -->
          <div class="crop-controls">
              <div class="control-group">
                <h6 class="control-title">
                  <i class="fas fa-arrows-alt"></i>
                  Movement
                </h6>
                <div class="control-buttons move-buttons">
                  <button type="button" id="combinedMoveUpBtn" class="control-btn" disabled>
                    <i class="fas fa-chevron-up"></i>
                  </button>
                  <button type="button" id="combinedMoveDownBtn" class="control-btn" disabled>
                    <i class="fas fa-chevron-down"></i>
                  </button>
                  <button type="button" id="combinedMoveLeftBtn" class="control-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <button type="button" id="combinedMoveRightBtn" class="control-btn" disabled>
                    <i class="fas fa-chevron-right"></i>
                  </button>
              </div>
            </div>

              <div class="control-group">
                <h6 class="control-title">
                  <i class="fas fa-search-plus"></i>
                  Zoom
                </h6>
                <div class="zoom-controls">
                  <button type="button" id="combinedZoomOutBtn" class="control-btn" disabled>
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="range" id="combinedZoomSlider" min="0.1" max="2" step="0.01" value="1" disabled>
                  <button type="button" id="combinedZoomInBtn" class="control-btn" disabled>
                    <i class="fas fa-plus"></i>
                  </button>
              </div>
            </div>

              <div class="control-group">
                <h6 class="control-title">
                  <i class="fas fa-redo"></i>
                  Rotate
                </h6>
                <div class="rotate-controls">
                  <button type="button" id="combinedRotateLeftBtn" class="control-btn" disabled>
                    <i class="fas fa-undo"></i>
                  </button>
                  <button type="button" id="combinedRotateRightBtn" class="control-btn" disabled>
                    <i class="fas fa-redo"></i>
                  </button>
              </div>
            </div>
          </div>

            <!-- Status -->
            <div class="crop-status">
              <div class="status-content">
                <span id="cropStatusText" class="status-text">Move, zoom, or rotate your image, then click "Set as Cover"</span>
                <span id="cropLoadingSpinner" class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i>
                </span>
          </div>
        </div>
      </div>
        </div>
        </div>
              <div class="modal-footer image-modal-footer">
          <div class="footer-left">
            <button type="button" id="combinedResetBtn" class="btn btn-outline-secondary" disabled>
              <i class="fas fa-undo"></i> Reset Crop
            </button>
          </div>
          <div class="footer-right">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              <i class="fas fa-times"></i> Close
            </button>
            <button type="button" id="combinedSetCoverBtn" class="btn btn-primary" disabled>
              <i class="fas fa-check"></i> Set as Cover
            </button>
          </div>
      </div>
    </div>
  </div>
</div>



<!-- ========================================================
     IMPROVED CUSTOMER INFO MODAL - Customer-Focused Design
     ======================================================== -->
   <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Enhanced Header with Progress Indicator -->
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="myModalLabel">
              <span class="title-main">Customer Info</span>
              <span class="title-subtitle">Enter customer details</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
          </button>
        </div>

      <div class="modal-body">


        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Customer</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Phone/Email</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Proposal</div>
          </div>
        </div>

        <form id="proposal-form" class="customer-form">
          <!-- Step 1: Basic Information -->
          <div class="form-step active" data-step="1">
            <div class="step-header">
              <h6><i class="fas fa-user"></i> Customer Information</h6>
            </div>



            <div class="contact-option step1-customer-field">
              <div class="option-header">
                <label for="customerNameInput" class="option-label">
                  <i class="fas fa-user-tag"></i>
                  <span>Customer's Full Name</span>
                  <span class="required">*</span>
                </label>
              </div>
              <div class="option-description">
                Customer name for the proposal
              </div>
              <div class="form-group customer-form-group">
                <input type="text" class="form-control customer-input" id="customerNameInput"
                       placeholder="Enter customer's full name" required>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-user-check"></i>
                  This will appear as the main customer name on the cover page
                </small>
              </div>
            </div>

            <div class="contact-option step1-address-field">
              <div class="option-header">
                <input type="checkbox" id="selectAddress" name="contact" value="Address"
                       onclick="toggleContact('address')" checked>
                <label for="selectAddress" class="option-label">
                  <i class="fas fa-map-marker-alt"></i>
                  <span>Include Address</span>
                </label>
              </div>
              <div class="option-description">
                Include address on cover page
              </div>
              <div class="form-group customer-form-group" id="addressInputGroup">
                <input type="text" class="form-control customer-input" id="customerAddressInput"
                       placeholder="Enter complete address (street, city, state, zip)">
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-info-circle"></i>
                  Address autocomplete available - start typing to see suggestions
                </small>
              </div>
            </div>


          </div>

          <!-- Step 2: Contact Information -->
          <div class="form-step" data-step="2">
            <div class="step-header">
              <h6><i class="fas fa-address-book"></i> Contact Options</h6>
            </div>

            <div class="contact-options">
              <div class="contact-option">
                <div class="option-header">
                  <input type="checkbox" id="selectPhone" name="contact" value="Phone"
                         onclick="toggleContact('phone')" checked>
                  <label for="selectPhone" class="option-label">
                    <i class="fas fa-phone"></i>
                    <span>Include Phone Number</span>
                  </label>
                </div>
                <div class="option-description">
                  Include phone on cover page
                </div>
                <div class="form-group customer-form-group" id="phoneInputGroup">
                  <input type="text" class="form-control customer-input" id="customerPhoneInput"
                         placeholder="(123) 456-7890">
                  <div class="input-focus-border"></div>
                  <small class="form-text">
                    <i class="fas fa-check-circle"></i>
                    Format will be automatically applied
                  </small>
                </div>
              </div>

              <div class="contact-option">
                <div class="option-header">
                  <input type="checkbox" id="selectEmail" name="contact" value="Email"
                         onclick="toggleContact('email')">
                  <label for="selectEmail" class="option-label">
                    <i class="fas fa-envelope"></i>
                    <span>Include Email Address</span>
                  </label>
                </div>
                <div class="option-description">
                  Include email on cover page
                </div>
                <div class="form-group customer-form-group" id="emailInputGroup">
                  <input type="email" class="form-control customer-input" id="customerEmailInput"
                         placeholder="customer@email.com">
                  <div class="input-focus-border"></div>
                  <small class="form-text">
                    <i class="fas fa-shield-alt"></i>
                    Email will be displayed securely
                  </small>
                </div>
              </div>


            </div>
          </div>

          <!-- Step 3: Proposal Details -->
          <div class="form-step" data-step="3">
            <div class="step-header">
              <h6><i class="fas fa-file-contract"></i> Proposal Details</h6>
            </div>

            <div class="contact-option step3-proposal-field">
              <div class="option-header">
                <label for="proposalInfoInput" class="option-label">
                  <i class="fas fa-info-circle"></i>
                  <span>Proposal Description</span>
                </label>
              </div>
              <div class="option-description">
                Add context about what this proposal covers
              </div>
              <div class="form-group customer-form-group">
                <textarea class="form-control customer-input" id="proposalInfoInput" rows="3"
                          placeholder="Brief description of the proposal or project scope"></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-lightbulb"></i>
                  Optional: This helps provide context for the proposal
                </small>
              </div>
            </div>

            <div class="contact-option step3-date-field">
              <div class="option-header">
                <label for="proposalDateInput" class="option-label">
                  <i class="fas fa-calendar-alt"></i>
                  <span>Proposal Date</span>
                  <span class="required">*</span>
                </label>
              </div>
              <div class="option-description">
                Set the date for when this proposal is prepared
              </div>
              <div class="form-group customer-form-group">
                <input type="date" class="form-control customer-input" id="proposalDateInput" required>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-clock"></i>
                  Today's date will be used if not specified
                </small>
              </div>
            </div>
            </div>
          </form>
        </div>

      <!-- Enhanced Footer with Navigation -->
      <div class="modal-footer customer-modal-footer">
        <div class="footer-left">
          <button type="button" class="btn btn-outline-secondary" id="prevStepBtn">
            <i class="fas fa-arrow-left"></i> Previous
          </button>
        </div>

        <div class="footer-center">
          <!-- Step indicator removed for cleaner look -->
        </div>

        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="nextStepBtn">
            Next <i class="fas fa-arrow-right"></i>
          </button>
          <button type="button" class="btn btn-success" id="submitBtn">
            <i class="fas fa-check"></i> Save Customer Info
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================================================
     CUSTOMER MODAL STYLES - Enhanced CSS
     ======================================================== -->
<style>
.customer-info-modal {
  border-radius: 20px;
  border: none;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.12), 0 8px 32px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  backdrop-filter: blur(10px);
  height: auto;
}

.customer-modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 18px 28px;
  position: relative;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
}

.customer-modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
  z-index: 1;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
  z-index: 2;
}

.header-icon {
  font-size: 24px;
  opacity: 0.9;
}

.header-text {
  flex: 1;
}

.title-main {
  display: block;
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 4px;
}

.title-subtitle {
  display: block;
  font-size: 14px;
  opacity: 0.8;
  font-weight: 400;
}

.customer-close {
  position: relative;
  z-index: 2;
  color: white;
  opacity: 0.8;
  font-size: 24px;
  transition: opacity 0.2s;
}

.customer-close:hover {
  opacity: 1;
}

.customer-modal-body {
  padding: 20px 24px;
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  height: auto;
  overflow: visible;
}



/* Progress Steps - Beautiful Step Counter (like Customer Info Modal) */
.progress-steps {
  display: flex;
  justify-content: space-between;
  margin: 16px 24px 20px 24px;
  position: relative;
  padding: 16px 24px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.progress-steps::before {
  content: '';
  position: absolute;
  top: 22px;
  left: 50px;
  right: 50px;
  height: 2px;
  background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 100%);
  border-radius: 1px;
  z-index: 1;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 2;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: white;
  border: 2px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 8px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

.step.active .step-number {
  background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
  border-color: #667eea;
  color: white;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.step.completed .step-number {
  background: #10b981;
  border-color: #10b981;
  color: white;
}

.step-label {
  font-size: 11px;
  font-weight: 500;
  color: #64748b;
  text-align: center;
  transition: color 0.3s ease;
}

.step.active .step-label {
  color: #667eea;
  font-weight: 600;
}

.step.completed .step-label {
  color: #10b981;
}

/* Form Steps */
.form-step {
  display: none;
  /* animation: fadeInUp 0.4s ease; */
}

.form-step.active {
  display: block;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.step-header {
  margin-bottom: 8px;
  text-align: center;
  padding: 6px 0;
  background: #f8fafc;
  border-radius: 4px;
  border: 1px solid #e2e8f0;
}

.step-header h6 {
  font-size: 16px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.step-header p {
  color: #6b7280;
  margin: 0;
  font-size: 13px;
  line-height: 1.3;
}

/* Compact Form Layout */
.form-row {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.customer-form-group {
  flex: 1;
  position: relative;
}

.customer-form-group.full-width {
  flex: 1 1 100%;
}

.customer-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 6px;
  font-size: 13px;
}

.customer-label i {
  color: #667eea;
  width: 16px;
}

.required {
  color: #ef4444;
  font-weight: 600;
}

.customer-input {
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 14px;
  transition: all 0.2s ease;
  background: white;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.customer-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  outline: none;
  transform: none;
}

.input-focus-border {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 2px;
  background: #667eea;
  transition: width 0.3s ease;
}

.customer-input:focus + .input-focus-border {
  width: 100%;
}

.form-text {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
  font-size: 11px;
  color: #6b7280;
}

.form-text i {
  width: 14px;
}

/* Ultra-Compact Contact Options */
.contact-options {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 6px;
}



/* Ultra-Compact Field Styling - All Steps */
.step1-customer-field,
.step1-address-field,
.step3-proposal-field,
.step3-date-field {
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 10px;
  background: #ffffff;
  transition: all 0.2s ease;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
  margin-bottom: 6px;
}

.step1-customer-field:hover,
.step1-address-field:hover,
.step3-proposal-field:hover,
.step3-date-field:hover {
  border-color: #667eea;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
  transform: none;
}

.step1-customer-field .option-header,
.step1-address-field .option-header,
.step3-proposal-field .option-header,
.step3-date-field .option-header {
  margin-bottom: 4px;
}

.step1-customer-field .option-description,
.step1-address-field .option-description,
.step3-proposal-field .option-description,
.step3-date-field .option-description {
  margin-bottom: 6px;
  margin-left: 0;
  color: #64748b;
  font-size: 12px;
  line-height: 1.2;
}

.contact-option {
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  background: #ffffff;
  transition: all 0.2s ease;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
}

.contact-option:hover {
  border-color: #667eea;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
  transform: none;
}

.option-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.option-header input[type="checkbox"] {
  width: 20px;
  height: 20px;
  accent-color: #667eea;
}

.option-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #374151;
  cursor: pointer;
  font-size: 16px;
}

.option-label i {
  color: #667eea;
  width: 18px;
}

.option-description {
  color: #6b7280;
  font-size: 13px;
  margin-bottom: 12px;
  margin-left: 28px;
}

/* Footer */
.customer-modal-footer {
  background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
  border-top: 1px solid rgba(229, 231, 235, 0.6);
  padding: 18px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
}

.footer-left, .footer-center, .footer-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.step-indicator {
  font-size: 14px;
  color: #6b7280;
  font-weight: 500;
}

.btn {
  padding: 12px 24px;
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.btn-outline-secondary {
  border: 2px solid #6b7280;
  color: #6b7280;
  background: transparent;
}

.btn-outline-secondary:hover {
  background: #6b7280;
  color: white;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5a67d8;
  transform: translateY(-1px);
}

.btn-success {
  background: #10b981;
  color: white;
}

.btn-success:hover {
  background: #059669;
  transform: translateY(-1px);
}

/* Responsive Design */
@media (max-width: 768px) {
  .customer-modal-header {
    padding: 20px;
  }

  .customer-modal-body {
    padding: 20px;
  }

  .customer-modal-footer {
    padding: 20px;
    flex-direction: column;
    gap: 16px;
  }

  .form-row {
    flex-direction: column;
    gap: 16px;
  }

  .progress-steps {
    margin-bottom: 30px;
  }

  .step-label {
    font-size: 11px;
  }
}

/* Loading States */
.customer-input:disabled {
  background: #f9fafb;
  cursor: not-allowed;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Success Animation */
@keyframes successPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.success-animation {
  animation: successPulse 0.6s ease;
}

/* ========================================================
     IMAGE MODAL STYLES - Optimized & Modern Design
     ======================================================== */
.image-modal-content {
  border-radius: 30px;
  border: 2px solid rgba(52, 152, 219, 0.2);
  box-shadow: 0 25px 80px rgba(44, 62, 80, 0.15), 0 12px 40px rgba(52, 152, 219, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1);
  overflow: hidden;
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  background: rgba(255, 255, 255, 0.98);
  animation: modalSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  transform: scale(1.02);
  height: 80vh;
  max-height: 750px;
  min-height: 600px;
  display: flex;
  flex-direction: column;
}

.image-modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 18px 28px;
  position: relative;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
}

.image-modal-header .header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
  z-index: 2;
}

.image-modal-header .header-icon {
  font-size: 24px;
  opacity: 0.9;
}

.image-modal-header .header-text {
  flex: 1;
}

.image-modal-header .title-main {
  display: block;
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 4px;
}

.image-modal-header .title-subtitle {
  display: block;
  font-size: 14px;
  opacity: 0.8;
  font-weight: 400;
}

.image-close {
  position: relative;
  z-index: 2;
  color: white;
  opacity: 0.8;
  font-size: 24px;
  transition: opacity 0.2s;
}

.image-close:hover {
  opacity: 1;
}

.image-modal-body {
  padding: 20px;
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  flex: 1;
  overflow: hidden;
}

.image-manager-container {
  display: flex;
  gap: 16px;
  height: 100%;
  min-height: 542px;
  max-height: 542px;
}

.image-modal-body {
  padding: 12px !important;
  flex: 1 !important;
  overflow: hidden !important;
  min-height: 500px !important;
  max-height: none !important;
}

/* Left Sidebar */
.image-sidebar {
  width: 300px;
  background: white;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
}

.upload-section {
  border-bottom: 1px solid #e0e4e8;
  padding-bottom: 8px;
  margin-bottom: 8px;
}

.upload-btn {
  background: linear-gradient(45deg, #667eea, #5a67d8);
  color: white;
  width: 100%;
  padding: 10px 12px;
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  font-weight: 500;
  font-size: 13px;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.upload-btn span {
  display: inline;
  font-size: 12px;
}

.upload-btn small {
  display: block;
  font-size: 10px;
  opacity: 0.8;
  margin-top: 2px;
}

.upload-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.upload-btn input[type="file"] {
  display: none;
}

.search-section {
  margin-bottom: 8px;
}

.search-wrapper {
  position: relative;
}

.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
  font-size: 14px;
}

.search-input {
  width: 100%;
  padding: 8px 10px 8px 32px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 13px;
  transition: all 0.3s ease;
}

.search-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  outline: none;
}

.image-list-container {
  flex: 1;
  overflow-y: auto;
  min-height: 380px;
  max-height: 380px;

}

#combinedImageList {
  margin-bottom: 16px;
}

#combinedImageListStatus {
  text-align: center;
  font-weight: 500;
  padding: 12px;
  color: #6b7280;
  font-size: 13px;
}

.progress-container {
  display: none;
  margin-top: 16px;
}

.progress {
  height: 6px;
  border-radius: 3px;
  background: #e5e7eb;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #5a67d8);
  transition: width 0.3s ease;
}

.progress-text {
  text-align: center;
  margin-top: 8px;
  font-size: 12px;
  color: #6b7280;
}

/* Right Crop Section */
.crop-section {
  flex: 1;
  background: white;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  width: 100%;
  padding-bottom: 16px;
}

.crop-container {
  position: relative;
  width: 100%;
  height: 280px;
  background:
    linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
    linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
    linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
  background-size: 16px 16px;
  background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
  margin: 0;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.06);
  display: flex;
  align-items: center;
  justify-content: center;
}

#combinedCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  cursor: grab;
  object-fit: cover;
  display: block;
}

#combinedCanvas:active {
  cursor: grabbing;
}

.canvas-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

#cropGrid {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 10;
}

#gridLines {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #667eea;
  background: transparent;
  opacity: 0.6;
  pointer-events: none;
}

.grid-line {
  position: absolute;
  background: #667eea;
  opacity: 0.6;
  pointer-events: none;
}

.grid-line.horizontal {
  width: 100%;
  height: 2px;
  left: 0;
}

.grid-line.vertical {
  height: 100%;
  width: 2px;
  top: 0;
}

/* Crop Controls */
.crop-controls {
  display: flex;
  gap: 12px;
  padding: 10px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  margin-bottom: 0;
}

.control-group h6 {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.control-group h6 i {
  color: #667eea;
  width: 16px;
}

.move-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

.control-btn {
  padding: 6px 10px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  background: white;
  color: #374151;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.control-btn:hover:not(:disabled) {
  border-color: #667eea;
  background: #667eea;
  color: white;
  transform: translateY(-1px);
}

.control-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.zoom-controls,
.rotate-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

#combinedZoomSlider,
#combinedRotateSlider {
  flex: 1;
  accent-color: #667eea;
  height: 6px;
  border-radius: 3px;
  background: #e5e7eb;
  outline: none;
  -webkit-appearance: none;
}



#combinedZoomSlider::-webkit-slider-thumb,
#combinedRotateSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #667eea;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
  transition: all 0.2s ease;
}

#combinedZoomSlider::-webkit-slider-thumb:hover,
#combinedRotateSlider::-webkit-slider-thumb:hover {
  background: #5a6fd8;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.crop-status {
  text-align: center;
  font-weight: 500;
  padding: 12px;
  background: rgba(102, 126, 234, 0.05);
  border-radius: 12px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  margin-bottom: 16px;
  border-bottom-left-radius: 16px;
  border-bottom-right-radius: 16px;
}

#cropStatusText {
  color: #374151;
  font-size: 14px;
}

.loading-spinner {
  display: none;
  margin-left: 8px;
  color: #667eea;
}

/* Footer */
.image-modal-footer {
  background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
  border-top: 1px solid rgba(229, 231, 235, 0.6);
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  margin-top: auto;
}

.footer-left,
.footer-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.footer-left {
  flex: 1;
}

.footer-right {
  flex: 0 0 auto;
}

/* Responsive Design */
@media (max-width: 768px) {
  .image-modal-body {
    flex-direction: column;
    height: auto;
  }

  .image-sidebar {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid #e0e4e8;
  }

  .crop-controls {
    grid-template-columns: 1fr;
  }
}

/* ========================================================
     IMPROVED IMAGE MANAGER STYLES
     ======================================================== */

/* Upload Section Improvements */
.upload-section {
  margin-bottom: 0;
}

.upload-btn {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
  padding: 10px 14px !important;
  border: 2px dashed #cbd5e1 !important;
  border-radius: 8px !important;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
  color: #64748b !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  text-align: center !important;
  font-weight: 500 !important;
  position: relative !important;
  overflow: hidden !important;
}

.upload-btn:hover {
  border-color: #667eea !important;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  color: white !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2) !important;
}

.upload-btn i {
  font-size: 16px !important;
  opacity: 0.8 !important;
  transition: all 0.3s ease !important;
}

.upload-btn:hover i {
  opacity: 1 !important;
  transform: scale(1.1) !important;
}

.upload-btn span {
  font-size: 14px !important;
  font-weight: 600 !important;
}

.upload-btn small {
  display: none !important;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #6b7280;
}

.empty-state i {
  font-size: 48px;
  color: #cbd5e1;
  margin-bottom: 16px;
}

.empty-state h4 {
  font-size: 18px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 14px;
  margin: 0;
}

/* Image Grid */
.image-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  max-height: 450px;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 6px;
  width: 100%;
  max-width: 260px;
}

/* Custom Scrollbar for Image Grid */
.image-grid::-webkit-scrollbar {
  width: 6px;
}

.image-grid::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

.image-grid::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.image-grid::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Image Thumbnail Styling */
.image-grid img {
  width: 240px !important;
  height: auto !important;
  max-height: 120px !important;
  object-fit: contain !important;
  border-radius: 10px !important;
  border: 2px solid #e5e7eb !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
  margin: 0 auto;
  display: block !important;
}

.image-grid img:hover {
  border-color: #667eea !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2) !important;
}

.image-grid img.selected {
  border-color: #667eea !important;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2) !important;
}

/* Image Item Container */
.image-item {
  position: relative !important;
  width: 100% !important;
  height: 120px !important;
  border-radius: 10px !important;
  overflow: hidden !important;
}

.image-item img {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  border-radius: 10px !important;
}

/* Image Action Buttons */
.image-actions {
  position: absolute !important;
  top: 6px !important;
  right: 6px !important;
  display: flex !important;
  gap: 4px !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease !important;
  z-index: 15 !important;
}

.image-item:hover .image-actions {
  opacity: 1 !important;
}

.image-action-btn {
  width: 28px !important;
  height: 28px !important;
  border-radius: 6px !important;
  border: none !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  font-size: 12px !important;
}

.image-delete-btn {
  background: rgba(239, 68, 68, 0.9) !important;
  color: white !important;
}

.image-delete-btn:hover {
  background: #dc2626 !important;
  transform: scale(1.1) !important;
}

.image-rename-btn {
  background: rgba(251, 146, 60, 0.9) !important;
  color: white !important;
}

.image-rename-btn:hover {
  background: #ea580c !important;
  transform: scale(1.1) !important;
}

/* Style for actual buttons on uploaded images */
.btn-action {
  width: 26px !important;
  height: 26px !important;
  padding: 0 !important;
  font-size: 11px !important;
  border-radius: 6px !important;
  margin: 0 !important;
  border: 2px solid rgba(255, 255, 255, 0.9) !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  backdrop-filter: blur(4px) !important;
  -webkit-backdrop-filter: blur(4px) !important;
}

/* Gallery item positioning */
.gallery-item {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  padding: 8px !important;
  margin-bottom: 8px !important;
  border-radius: 12px !important;
  background: #ffffff !important;
  min-height: 140px !important;
  justify-content: center !important;
}

/* Action buttons positioning */
.action-buttons {
  position: absolute !important;
  bottom: 30px !important;
  left: 8px !important;
  display: flex !important;
  gap: 4px !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease !important;
  z-index: 1000 !important;
}

.gallery-item:hover .action-buttons {
  opacity: 1 !important;
}

.gallery-item:hover {
  background: #f8fafc !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
}

.gallery-item.selected {
  background: #f0f7ff !important;
  border: 2px solid #667eea !important;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
}

/* Gallery name styling */
.gallery-name {
  margin-top: 8px !important;
  font-size: 12px !important;
  font-weight: 500 !important;
  color: #374151 !important;
  text-align: center !important;
  max-width: 220px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  line-height: 1.3 !important;
}

.btn-delete,
.btn-action.btn-delete {
  background: #df2b2b !important;
  color: white !important;
  border: none !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  font-size: 10px !important;
  cursor: pointer !important;
  font-weight: 500 !important;
  min-width: 30px !important;
  text-align: center !important;
  transition: all 0.2s ease !important;
}

.btn-delete:hover,
.btn-action.btn-delete:hover {
  background: #c12525 !important;
  transform: scale(1.05) !important;
}

.btn-rename,
.btn-action.btn-rename {
  background: #dc7b07 !important;
  color: white !important;
  border: none !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  font-size: 10px !important;
  cursor: pointer !important;
  font-weight: 500 !important;
  min-width: 30px !important;
  text-align: center !important;
  transition: all 0.2s ease !important;
}

.btn-rename:hover,
.btn-action.btn-rename:hover {
  background: #b8690a !important;
  transform: scale(1.05) !important;
}

/* Canvas Overlay */
.canvas-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.canvas-overlay.show {
  display: flex;
  background: rgba(248, 250, 252, 0.9);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}

.overlay-message {
  text-align: center;
  color: #6b7280;
}

.overlay-message i {
  font-size: 48px;
  color: #cbd5e1;
  margin-bottom: 16px;
}

.overlay-message h4 {
  font-size: 18px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.overlay-message p {
  font-size: 14px;
  margin: 0;
}

/* ========================================================
     COMPACT CROP CONTROLS
     ======================================================== */

.control-group {
  flex: 1;
  text-align: center;
}

.control-title {
  font-size: 12px !important;
  font-weight: 600 !important;
  color: #374151 !important;
  margin-bottom: 8px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 6px !important;
}

.control-title i {
  color: #667eea !important;
  font-size: 14px !important;
}

.control-buttons {
  display: flex !important;
  gap: 4px !important;
  justify-content: center !important;
}

.move-buttons {
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 4px !important;
  max-width: 80px !important;
  margin: 0 auto !important;
}

.zoom-controls,
.rotate-controls {
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
  justify-content: center !important;
}

.control-btn {
  padding: 6px 10px !important;
  border: 2px solid #e5e7eb !important;
  border-radius: 6px !important;
  background: white !important;
  color: #6b7280 !important;
  font-size: 12px !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  min-width: 32px !important;
}

.control-btn:hover:not(:disabled) {
  border-color: #667eea !important;
  background: #667eea !important;
  color: white !important;
}

.control-btn:disabled {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
}

input[type="range"] {
  width: 80px !important;
  height: 6px !important;
  border-radius: 3px !important;
  background: #e5e7eb !important;
  outline: none !important;
  -webkit-appearance: none !important;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none !important;
  appearance: none !important;
  width: 16px !important;
  height: 16px !important;
  border-radius: 50% !important;
  background: #667eea !important;
  cursor: pointer !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}

/* ========================================================
     IMAGE MODAL FOOTER BUTTON IMPROVEMENTS
     ======================================================== */

.image-modal-footer .btn {
  padding: 10px 20px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  font-size: 14px !important;
  transition: all 0.3s ease !important;
  border: 2px solid transparent !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
}

.image-modal-footer .btn-outline-secondary {
  background: white !important;
  border-color: #e5e7eb !important;
  color: #6b7280 !important;
}

.image-modal-footer .btn-outline-secondary:hover:not(:disabled) {
  background: #f3f4f6 !important;
  border-color: #d1d5db !important;
  color: #374151 !important;
  transform: translateY(-1px) !important;
}

.image-modal-footer .btn-secondary {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
  border-color: #6b7280 !important;
  color: white !important;
}

.image-modal-footer .btn-secondary:hover {
  background: linear-gradient(135deg, #4b5563 0%, #374151 100%) !important;
  border-color: #4b5563 !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3) !important;
}

.image-modal-footer .btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  border-color: #667eea !important;
  color: white !important;
}

.image-modal-footer .btn-primary:hover:not(:disabled) {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
  border-color: #5a6fd8 !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
}

.image-modal-footer .btn:disabled {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  transform: none !important;
}

/* ========================================================
     MODAL Z-INDEX FIXES - DELETE/RENAME OVER IMAGE MODAL
     ======================================================== */

#deleteModal {
  z-index: 1060 !important;
}

#renameModal {
  z-index: 1060 !important;
}

#combinedImageModal {
  z-index: 1050 !important;
}

/* ========================================================
     QR MODAL STYLES - Matching Customer Info Modal Style
     ======================================================== */
.qr-modal-content {
  border-radius: 30px;
  border: 2px solid rgba(52, 152, 219, 0.2);
  box-shadow: 0 25px 80px rgba(44, 62, 80, 0.15), 0 12px 40px rgba(52, 152, 219, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1);
  overflow: hidden;
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  background: rgba(255, 255, 255, 0.98);
  animation: modalSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  transform: scale(1.05);
}

.qr-modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 18px 28px;
  position: relative;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
}

.qr-modal-header .header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
  z-index: 2;
}

.qr-modal-header .header-icon {
  font-size: 24px;
  opacity: 0.9;
}

.qr-modal-header .header-text {
  flex: 1;
}

.qr-modal-header .title-main {
  display: block;
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 4px;
}

.qr-modal-header .title-subtitle {
  display: block;
  font-size: 14px;
  opacity: 0.8;
  font-weight: 400;
}

.qr-close {
  position: relative;
  z-index: 2;
  color: white;
  opacity: 0.8;
  font-size: 24px;
  transition: opacity 0.2s;
}

.qr-close:hover {
  opacity: 1;
}

.qr-modal-body {
  padding: 12px 18px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.qr-options {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.qr-option {
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 14px;
  background: white;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.qr-option:hover {
  border-color: #667eea;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.1);
  transform: translateY(-1px);
}

.option-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.qr-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #667eea;
}

.option-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #374151;
  cursor: pointer;
  font-size: 16px;
}

.option-label i {
  color: #667eea;
  width: 18px;
}

.option-description {
  color: #6b7280;
  font-size: 13px;
  margin-bottom: 12px;
  margin-left: 28px;
}

.url-input-group {
  margin-left: 28px;
}

.qr-input {
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 12px 16px;
  font-size: 14px;
  transition: all 0.3s ease;
  background: white;
  margin-bottom: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
}

.qr-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  outline: none;
  transform: translateY(-1px);
}

.form-text {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #6b7280;
}

.form-text i {
  width: 14px;
  color: #667eea;
}

.qr-modal-footer {
  background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
  border-top: 1px solid rgba(226, 232, 240, 0.6);
  padding: 18px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
}

.qr-modal-footer .btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.qr-modal-footer .btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.qr-modal-footer .btn-primary:hover {
  background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
}

/* Company modal styles moved to: ../styles/pages/cover-page/company-info-modal.css */

/* Fancy Animations */
@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes gradientShift {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

/* ========================================================
     DELETE MODAL STYLES - Matching Design System
     ======================================================== */
.delete-modal-content {
  border-radius: 30px;
  border: 2px solid rgba(52, 152, 219, 0.2);
  box-shadow: 0 25px 80px rgba(44, 62, 80, 0.15), 0 12px 40px rgba(52, 152, 219, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1);
  overflow: hidden;
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  background: rgba(255, 255, 255, 0.98);
  animation: modalSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  transform: scale(1.05);
}

.delete-modal-header {
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  color: white;
  border: none;
  padding: 30px 40px;
  position: relative;
  box-shadow: 0 8px 32px rgba(44, 62, 80, 0.3);
  background-size: 300% 300%;
  animation: gradientShift 3s ease infinite;
  border-bottom: 3px solid rgba(255, 255, 255, 0.3);
}

.delete-modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%);
  z-index: 1;
}

.delete-close {
  position: relative;
  z-index: 2;
  color: white;
  opacity: 0.8;
  font-size: 24px;
  transition: opacity 0.2s;
}

.delete-close:hover {
  opacity: 1;
}

.delete-modal-body {
  padding: 20px 24px;
  background: linear-gradient(180deg, #ffffff 0%, #fef2f2 100%);
  text-align: center;
}

.delete-message {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.delete-message i {
  font-size: 48px;
  color: #ef4444;
  opacity: 0.8;
}

.delete-message p {
  font-size: 16px;
  color: #374151;
  margin: 0;
  line-height: 1.5;
}

.delete-modal-footer {
  background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
  border-top: 1px solid rgba(226, 232, 240, 0.6);
  padding: 18px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
  border-radius: 0 0 20px 20px;
}

.delete-modal-footer .btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.delete-modal-footer .btn-danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
}

.delete-modal-footer .btn-danger:hover {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}

/* ========================================================
     RENAME MODAL STYLES - Matching Design System
     ======================================================== */
.rename-modal-content {
  border-radius: 30px;
  border: 2px solid rgba(52, 152, 219, 0.2);
  box-shadow: 0 25px 80px rgba(44, 62, 80, 0.15), 0 12px 40px rgba(52, 152, 219, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1);
  overflow: hidden;
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  background: rgba(255, 255, 255, 0.98);
  animation: modalSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  transform: scale(1.05);
}

.rename-modal-header {
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  color: white;
  border: none;
  padding: 30px 40px;
  position: relative;
  box-shadow: 0 8px 32px rgba(44, 62, 80, 0.3);
  background-size: 300% 300%;
  animation: gradientShift 3s ease infinite;
  border-bottom: 3px solid rgba(255, 255, 255, 0.3);
}

.rename-modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.9) 100%);
  z-index: 1;
}

.rename-close {
  position: relative;
  z-index: 2;
  color: white;
  opacity: 0.8;
  font-size: 24px;
  transition: opacity 0.2s;
}

.rename-close:hover {
  opacity: 1;
}

.rename-modal-body {
  padding: 20px 24px;
  background: linear-gradient(180deg, #ffffff 0%, #fffbeb 100%);
}

.rename-form-group {
  background: white;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
  position: relative;
}

.rename-form-group:hover {
  border-color: #f59e0b;
  box-shadow: 0 6px 24px rgba(245, 158, 11, 0.1);
  transform: translateY(-2px);
}

.rename-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 12px;
  font-size: 14px;
}

.rename-label i {
  color: #f59e0b;
  width: 16px;
}

.rename-input {
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 12px 16px;
  font-size: 14px;
  transition: all 0.3s ease;
  background: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
  position: relative;
  width: 100%;
}

.rename-input:focus {
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
  outline: none;
  transform: translateY(-1px);
}

.rename-input:focus + .input-focus-border {
  width: 100%;
}

.rename-modal-footer {
  background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
  border-top: 1px solid rgba(226, 232, 240, 0.6);
  padding: 18px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
  border-radius: 0 0 20px 20px;
}

.rename-modal-footer .btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.rename-modal-footer .btn-primary {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.rename-modal-footer .btn-primary:hover {
  background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
}

/* QR Limit Message Animation */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* QR Type Card Max Reached State */
.qr-type-card.max-reached {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: #dee2e6;
  background: #f8f9fa;
}

.qr-type-card.max-reached:hover {
  transform: none;
  border-color: #dee2e6;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.qr-type-card.max-reached .type-toggle {
  pointer-events: none;
}

.qr-type-card.max-reached .toggle-switch {
  background-color: #dee2e6;
  cursor: not-allowed;
}
</style>

<!-- ========================================================
     CUSTOMER MODAL JAVASCRIPT - Enhanced Functionality
     ======================================================== -->
<script>
$(document).ready(function() {
  let currentStep = 1;
  const totalSteps = 3;

  // Initialize step navigation
  function updateStepNavigation() {
    $('#currentStep').text(currentStep);
    $('#totalSteps').text(totalSteps);

    // Update progress steps
    $('.step').removeClass('active completed');
    for (let i = 1; i <= totalSteps; i++) {
      if (i < currentStep) {
        $(`.step[data-step="${i}"]`).addClass('completed');
      } else if (i === currentStep) {
        $(`.step[data-step="${i}"]`).addClass('active');
      }
    }

    // Show/hide navigation buttons
    if (currentStep === 1) {
      $('#prevStepBtn').hide();
      $('#nextStepBtn').show();
      $('#submitBtn').hide();
    } else if (currentStep === totalSteps) {
      $('#prevStepBtn').show();
      $('#nextStepBtn').hide();
      $('#submitBtn').show();
    } else {
      $('#prevStepBtn').show();
      $('#nextStepBtn').show();
      $('#submitBtn').hide();
    }
  }

  // Show specific step
  function showStep(stepNumber) {
    console.log('📋 Showing step:', stepNumber, 'from step:', currentStep);
    $('.form-step').removeClass('active');
    $(`.form-step[data-step="${stepNumber}"]`).addClass('active');
    currentStep = stepNumber;
    updateStepNavigation();
    console.log('✅ Step', stepNumber, 'is now active');
  }

  // Navigation button handlers
  $('#nextStepBtn').click(function() {
    console.log('🔄 Next button clicked, current step:', currentStep);
    
    if (validateCurrentStep()) {
      console.log('✅ Validation passed, moving to next step');
      if (currentStep < totalSteps) {
        showStep(currentStep + 1);
        console.log('➡️ Moved to step:', currentStep);
      } else {
        console.log('⚠️ Already at last step');
      }
    } else {
      console.log('❌ Validation failed, staying on current step');
    }
  });

  $('#prevStepBtn').click(function() {
    if (currentStep > 1) {
      showStep(currentStep - 1);
    }
  });

  // Step validation
  function validateCurrentStep() {
    let isValid = true;
    let firstInvalidField = null;
    const currentStepEl = $(`.form-step[data-step="${currentStep}"]`);

    // Validate required fields in current step
    currentStepEl.find('input[required], textarea[required]').each(function() {
      if (!$(this).val().trim()) {
        isValid = false;
        $(this).addClass('is-invalid');
        // Store first invalid field but don't focus yet
        if (!firstInvalidField) {
          firstInvalidField = $(this);
        }
      } else {
        $(this).removeClass('is-invalid');
      }
    });

    // Special validation for contact options
    if (currentStep === 2) {
      const phoneChecked = $('#selectPhone').is(':checked');
      const emailChecked = $('#selectEmail').is(':checked');

      // Only validate phone if checkbox is checked
      if (phoneChecked) {
        if (!$('#customerPhoneInput').val().trim()) {
          isValid = false;
          $('#customerPhoneInput').addClass('is-invalid');
          if (!firstInvalidField) {
            firstInvalidField = $('#customerPhoneInput');
          }
        } else {
          $('#customerPhoneInput').removeClass('is-invalid');
        }
      }

      // Only validate email if checkbox is checked
      if (emailChecked) {
        if (!$('#customerEmailInput').val().trim()) {
          isValid = false;
          $('#customerEmailInput').addClass('is-invalid');
          if (!firstInvalidField) {
            firstInvalidField = $('#customerEmailInput');
          }
        } else {
          $('#customerEmailInput').removeClass('is-invalid');
        }
      }
    }

    if (!isValid) {
      showValidationError();
      // Focus on first invalid field after a short delay to prevent interference
      if (firstInvalidField) {
        setTimeout(() => {
          firstInvalidField.focus();
        }, 100);
      }
    }

    return isValid;
  }

  function showValidationError() {
    // Create and show a toast notification
    const toast = $(`
      <div class="validation-toast">
        <i class="fas fa-exclamation-triangle"></i>
        Please complete all required fields before continuing.
      </div>
    `);

    $('body').append(toast);

    setTimeout(() => {
      toast.fadeOut(() => toast.remove());
    }, 4000);
  }



  // Enhanced contact toggle with smooth animations
  window.toggleContact = function(type) {
    if (type === 'phone') {
      const isChecked = $('#selectPhone').is(':checked');
      $('#phoneInputGroup').slideToggle(300);
      $('#phoneParent').toggle(isChecked);

      if (!isChecked) {
        $('#customerPhoneInput').val('').removeClass('is-invalid');
        $('#customerPhone').text('');
      }
    } else if (type === 'email') {
      const isChecked = $('#selectEmail').is(':checked');
      $('#emailInputGroup').slideToggle(300);
      $('#emailParent').toggle(isChecked);

      if (!isChecked) {
        $('#customerEmailInput').val('').removeClass('is-invalid');
        $('#customerEmail').text('');
      }
    } else if (type === 'address') {
      const isChecked = $('#selectAddress').is(':checked');
      $('#addressInputGroup').slideToggle(300);
      $('#addressParent').toggle(isChecked);

      if (!isChecked) {
        $('#customerAddressInput').val('').removeClass('is-invalid');
        $('#customerAddress').text('');
      }
    }
  };

  // Enhanced submit button with loading state and REAL Firebase save
  $('#submitBtn').click(function() {
    if (!validateCurrentStep()) return;

    const $btn = $(this);
    const originalText = $btn.html();

    // Show loading state
    $btn.html('<i class="fas fa-spinner fa-spin"></i> Saving...').prop('disabled', true);

    // REAL Firebase save operation
    if (!window.proposalDataRef || !window.currentFirebaseUID) {
      alert("Please log in first.");
      $btn.html(originalText).prop('disabled', false);
      return;
    }

    try {
      const dateObj = new Date($('#proposalDateInput').val() + "T00:00:00");
      window.proposalDataRef.set({
        name: $('#customerNameInput').val(),
        address: $('#customerAddressInput').val(),
        phone: $('#customerPhoneInput').val(),
        email: $('#customerEmailInput').val(),
        proposalInfo: $('#proposalInfoInput').val(),
        proposalDate: window.formatDate(dateObj),
        showPhone: $('#selectPhone').is(':checked'),
        showEmail: $('#selectEmail').is(':checked'),
        showAddress: $('#selectAddress').is(':checked')
      }).then(() => {
        // Success state
        $btn.html('<i class="fas fa-check"></i> Success!').addClass('btn-success');

        // Close modal after success
        setTimeout(() => {
          $('#myModal').modal('hide');
          $btn.html(originalText).prop('disabled', false).removeClass('btn-success');
        }, 1000);
      }).catch((error) => {
        console.error('Error saving to Firebase:', error);
        alert('Error saving customer info. Please try again.');
        $btn.html(originalText).prop('disabled', false);
      });
    } catch (error) {
      console.error('Error in submit:', error);
      alert('Error saving customer info. Please try again.');
      $btn.html(originalText).prop('disabled', false);
    }
  });

  // Initialize modal
  $('#myModal').on('shown.bs.modal', function() {
    showStep(1);

    // Set today's date as default
    if (!$('#proposalDateInput').val()) {
      const today = new Date().toISOString().split('T')[0];
      $('#proposalDateInput').val(today);
    }

    // Initialize contact field visibility
    $('#phoneInputGroup').toggle($('#selectPhone').is(':checked'));
    $('#phoneParent').toggle($('#selectPhone').is(':checked'));
    $('#emailInputGroup').toggle($('#selectEmail').is(':checked'));
    $('#emailParent').toggle($('#selectEmail').is(':checked'));
    $('#addressInputGroup').toggle($('#selectAddress').is(':checked'));
    $('#addressParent').toggle($('#selectAddress').is(':checked'));
  });

  // Reset modal state when closed
  $('#myModal').on('hidden.bs.modal', function() {
    showStep(1);
    $('#proposal-form')[0].reset();
    $('.form-step').removeClass('active');
    $('.step').removeClass('active completed');
  });

  // Enhanced input focus effects
  $('.customer-input').on('focus', function() {
    $(this).closest('.customer-form-group').addClass('focused');
  });

  $('.customer-input').on('blur', function() {
    $(this).closest('.customer-form-group').removeClass('focused');
  });

  // Auto-format phone number
  $('#customerPhoneInput').on('input', function() {
    let value = $(this).val().replace(/\D/g, '');
    if (value.length >= 6) {
      value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
    } else if (value.length >= 3) {
      value = value.replace(/(\d{3})(\d{0,3})/, '($1) $2');
    }
    $(this).val(value);
  });

  // Add CSS animations
  $('<style>')
    .prop('type', 'text/css')
    .html(`
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .customer-form-group.focused .customer-label {
        color: #667eea;
      }

      .customer-input.is-invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      }
    `)
    .appendTo('head');
});
