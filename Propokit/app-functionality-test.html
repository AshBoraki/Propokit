<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Functionality Test - Propokit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3367d6; }
        button.success { background: #10b981; }
        button.danger { background: #ef4444; }
        button.warning { background: #f59e0b; }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .feature-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #fafafa;
        }
        .feature-card h4 {
            margin-top: 0;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-indicator.online { background: #10b981; }
        .status-indicator.offline { background: #ef4444; }
        .status-indicator.warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Propokit App Functionality Test</h1>
        <p>This test checks all the core functionality of your Propokit application.</p>
        
        <div class="test-section">
            <h3>Authentication Status</h3>
            <div id="auth-status" class="data-display">
                Checking authentication...
            </div>
            <button onclick="checkAuthStatus()">Refresh Auth Status</button>
        </div>
        
        <div class="test-section">
            <h3>Firebase Services Test</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>Authentication</h4>
                    <div id="auth-test-results"></div>
                    <button onclick="testAuthService()">Test Auth</button>
                </div>
                <div class="feature-card">
                    <h4>Database</h4>
                    <div id="db-test-results"></div>
                    <button onclick="testDatabaseService()">Test Database</button>
                </div>
                <div class="feature-card">
                    <h4>Storage</h4>
                    <div id="storage-test-results"></div>
                    <button onclick="testStorageService()">Test Storage</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>App Data Flow Test</h3>
            <div id="data-flow-results"></div>
            <button onclick="testDataFlow()">Test Data Flow</button>
            <button onclick="testUIDConsistency()">Test UID Consistency</button>
            <button onclick="testFirebaseRefs()">Test Firebase Refs</button>
        </div>
        
        <div class="test-section">
            <h3>User Data Test</h3>
            <div id="user-data-results"></div>
            <button onclick="testUserData()">Test User Data</button>
            <button onclick="testCompanyInfo()">Test Company Info</button>
            <button onclick="testProposalData()">Test Proposal Data</button>
        </div>
        
        <div class="test-section">
            <h3>App Integration Test</h3>
            <div id="integration-results"></div>
            <button onclick="testAppIntegration()">Test App Integration</button>
            <button onclick="testLocalStorage()">Test LocalStorage</button>
            <button onclick="testGlobalVariables()">Test Global Variables</button>
        </div>
        
        <div class="test-section">
            <h3>Real App Test</h3>
            <div id="real-app-results"></div>
            <button onclick="testRealApp()" class="success">Test Real App</button>
            <button onclick="openMainApp()" class="success">Open Main App</button>
            <button onclick="openLoginPage()" class="warning">Open Login Page</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="js/shared/firebase-config.js"></script>

    <script>
        function addResult(section, message, type = 'info') {
            const results = document.getElementById(section + '-results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(`[${section.toUpperCase()}] ${message}`);
        }
        
        function clearResults(section) {
            const results = document.getElementById(section + '-results');
            if (results) results.innerHTML = '';
        }
        
        function updateAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            if (typeof firebase !== 'undefined' && firebase.auth) {
                const currentUser = firebase.auth().currentUser;
                const storedUID = localStorage.getItem('firebaseUID');
                const windowUID = window.currentFirebaseUID;
                
                let status = '';
                if (currentUser) {
                    status = `âœ… Authenticated: ${currentUser.email}\nUID: ${currentUser.uid}`;
                } else if (storedUID) {
                    status = `âš ï¸ Stored UID: ${storedUID}\nNo current user`;
                } else {
                    status = 'âŒ Not authenticated';
                }
                
                status += `\nWindow UID: ${windowUID || 'None'}`;
                statusDiv.textContent = status;
            } else {
                statusDiv.textContent = 'â³ Firebase not loaded';
            }
        }
        
        function checkAuthStatus() {
            addResult('auth-test', 'ðŸ” Checking authentication status...', 'info');
            updateAuthStatus();
            addResult('auth-test', 'âœ… Auth status updated', 'success');
        }
        
        function testAuthService() {
            clearResults('auth-test');
            addResult('auth-test', 'ðŸ” Testing Firebase Authentication service...', 'info');
            
            try {
                if (!firebase.auth) {
                    addResult('auth-test', 'âŒ Firebase Auth not available', 'error');
                    return;
                }
                
                const auth = firebase.auth();
                addResult('auth-test', 'âœ… Firebase Auth service available', 'success');
                
                const currentUser = auth.currentUser;
                if (currentUser) {
                    addResult('auth-test', `âœ… Current user: ${currentUser.email}`, 'success');
                    addResult('auth-test', `âœ… User UID: ${currentUser.uid}`, 'success');
                } else {
                    addResult('auth-test', 'âš ï¸ No current user', 'warning');
                }
                
                // Test Google provider
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    addResult('auth-test', 'âœ… Google Auth Provider created', 'success');
                } catch (e) {
                    addResult('auth-test', `âŒ Google Auth Provider failed: ${e.message}`, 'error');
                }
                
            } catch (error) {
                addResult('auth-test', `âŒ Auth service test failed: ${error.message}`, 'error');
            }
        }
        
        function testDatabaseService() {
            clearResults('db-test');
            addResult('db-test', 'ðŸ“Š Testing Firebase Database service...', 'info');
            
            try {
                if (!firebase.database) {
                    addResult('db-test', 'âŒ Firebase Database not available', 'error');
                    return;
                }
                
                const database = firebase.database();
                addResult('db-test', 'âœ… Firebase Database service available', 'success');
                
                // Test database reference
                const testRef = database.ref('test');
                addResult('db-test', 'âœ… Database reference created', 'success');
                
                // Test if we can read (this will fail if not authenticated)
                testRef.once('value')
                    .then(() => {
                        addResult('db-test', 'âœ… Database read successful', 'success');
                    })
                    .catch((error) => {
                        addResult('db-test', `âš ï¸ Database read failed (expected if not authenticated): ${error.message}`, 'warning');
                    });
                
            } catch (error) {
                addResult('db-test', `âŒ Database service test failed: ${error.message}`, 'error');
            }
        }
        
        function testStorageService() {
            clearResults('storage-test');
            addResult('storage-test', 'ðŸ’¾ Testing Firebase Storage service...', 'info');
            
            try {
                if (!firebase.storage) {
                    addResult('storage-test', 'âŒ Firebase Storage not available', 'error');
                    return;
                }
                
                const storage = firebase.storage();
                addResult('storage-test', 'âœ… Firebase Storage service available', 'success');
                
                // Test storage reference
                const testRef = storage.ref('test');
                addResult('storage-test', 'âœ… Storage reference created', 'success');
                
            } catch (error) {
                addResult('storage-test', `âŒ Storage service test failed: ${error.message}`, 'error');
            }
        }
        
        function testDataFlow() {
            clearResults('data-flow');
            addResult('data-flow', 'ðŸ”„ Testing app data flow...', 'info');
            
            const currentUser = firebase.auth().currentUser;
            const storedUID = localStorage.getItem('firebaseUID');
            const windowUID = window.currentFirebaseUID;
            
            addResult('data-flow', `Current User: ${currentUser ? currentUser.uid : 'None'}`, 'info');
            addResult('data-flow', `Stored UID: ${storedUID || 'None'}`, 'info');
            addResult('data-flow', `Window UID: ${windowUID || 'None'}`, 'info');
            
            // Check consistency
            const uids = [currentUser?.uid, storedUID, windowUID].filter(Boolean);
            const uniqueUIDs = [...new Set(uids)];
            
            if (uniqueUIDs.length === 0) {
                addResult('data-flow', 'âŒ No UID found anywhere', 'error');
            } else if (uniqueUIDs.length === 1) {
                addResult('data-flow', 'âœ… All UIDs are consistent', 'success');
            } else {
                addResult('data-flow', `âš ï¸ UID mismatch: ${uniqueUIDs.join(', ')}`, 'warning');
            }
        }
        
        function testUIDConsistency() {
            clearResults('data-flow');
            addResult('data-flow', 'ðŸ†” Testing UID consistency across app...', 'info');
            
            const sources = [
                {name: 'Firebase Auth', value: firebase.auth().currentUser?.uid},
                {name: 'localStorage', value: localStorage.getItem('firebaseUID')},
                {name: 'window.currentFirebaseUID', value: window.currentFirebaseUID},
                {name: 'window.companyInfoRef', value: window.companyInfoRef?.key},
                {name: 'window.proposalDataRef', value: window.proposalDataRef?.key},
                {name: 'window.qrCodesRef', value: window.qrCodesRef?.key},
                {name: 'window.coverImageRef', value: window.coverImageRef?.key}
            ];
            
            sources.forEach(source => {
                const status = source.value ? 'âœ…' : 'âŒ';
                addResult('data-flow', `${status} ${source.name}: ${source.value || 'None'}`, source.value ? 'success' : 'error');
            });
        }
        
        function testFirebaseRefs() {
            clearResults('data-flow');
            addResult('data-flow', 'ðŸ”— Testing Firebase references...', 'info');
            
            const refs = [
                'window.companyInfoRef',
                'window.proposalDataRef', 
                'window.qrCodesRef',
                'window.coverImageRef'
            ];
            
            refs.forEach(refName => {
                const ref = eval(refName);
                const status = ref ? 'âœ…' : 'âŒ';
                addResult('data-flow', `${status} ${refName}: ${ref ? 'Initialized' : 'Not initialized'}`, ref ? 'success' : 'error');
            });
        }
        
        function testUserData() {
            clearResults('user-data');
            addResult('user-data', 'ðŸ‘¤ Testing user data access...', 'info');
            
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                addResult('user-data', `âœ… User: ${currentUser.displayName || 'No name'}`, 'success');
                addResult('user-data', `âœ… Email: ${currentUser.email}`, 'success');
                addResult('user-data', `âœ… UID: ${currentUser.uid}`, 'success');
                addResult('user-data', `âœ… Photo: ${currentUser.photoURL || 'No photo'}`, 'success');
            } else {
                addResult('user-data', 'âŒ No authenticated user', 'error');
            }
        }
        
        function testCompanyInfo() {
            clearResults('user-data');
            addResult('user-data', 'ðŸ¢ Testing company info access...', 'info');
            
            if (window.companyInfoRef) {
                window.companyInfoRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            addResult('user-data', 'âœ… Company info found', 'success');
                            addResult('user-data', `Data: ${JSON.stringify(data, null, 2)}`, 'info');
                        } else {
                            addResult('user-data', 'âš ï¸ No company info data', 'warning');
                        }
                    })
                    .catch((error) => {
                        addResult('user-data', `âŒ Company info access failed: ${error.message}`, 'error');
                    });
            } else {
                addResult('user-data', 'âŒ Company info reference not initialized', 'error');
            }
        }
        
        function testProposalData() {
            clearResults('user-data');
            addResult('user-data', 'ðŸ“„ Testing proposal data access...', 'info');
            
            if (window.proposalDataRef) {
                window.proposalDataRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            addResult('user-data', 'âœ… Proposal data found', 'success');
                            addResult('user-data', `Data: ${JSON.stringify(data, null, 2)}`, 'info');
                        } else {
                            addResult('user-data', 'âš ï¸ No proposal data', 'warning');
                        }
                    })
                    .catch((error) => {
                        addResult('user-data', `âŒ Proposal data access failed: ${error.message}`, 'error');
                    });
            } else {
                addResult('user-data', 'âŒ Proposal data reference not initialized', 'error');
            }
        }
        
        function testAppIntegration() {
            clearResults('integration');
            addResult('integration', 'ðŸ”— Testing app integration...', 'info');
            
            // Test global variables
            const globalVars = [
                'window.currentFirebaseUID',
                'window.companyInfoRef',
                'window.proposalDataRef',
                'window.qrCodesRef',
                'window.coverImageRef',
                'window.appInitialized'
            ];
            
            globalVars.forEach(varName => {
                const exists = eval(varName) !== undefined;
                addResult('integration', `${exists ? 'âœ…' : 'âŒ'} ${varName}`, exists ? 'success' : 'error');
            });
        }
        
        function testLocalStorage() {
            clearResults('integration');
            addResult('integration', 'ðŸ’¾ Testing localStorage...', 'info');
            
            const keys = Object.keys(localStorage);
            addResult('integration', `Found ${keys.length} localStorage keys`, 'info');
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                addResult('integration', `Key: ${key}, Value: ${value}`, 'info');
            });
        }
        
        function testGlobalVariables() {
            clearResults('integration');
            addResult('integration', 'ðŸŒ Testing global variables...', 'info');
            
            const globals = [
                'firebase',
                'window.currentFirebaseUID',
                'localStorage',
                'document'
            ];
            
            globals.forEach(global => {
                const exists = eval(global) !== undefined;
                addResult('integration', `${exists ? 'âœ…' : 'âŒ'} ${global}`, exists ? 'success' : 'error');
            });
        }
        
        function testRealApp() {
            clearResults('real-app');
            addResult('real-app', 'ðŸš€ Testing real app functionality...', 'info');
            
            // Check if we can access the main app
            const currentUser = firebase.auth().currentUser;
            const storedUID = localStorage.getItem('firebaseUID');
            
            if (currentUser || storedUID) {
                addResult('real-app', 'âœ… User authenticated - app should work', 'success');
                addResult('real-app', 'âœ… Ready to test main app functionality', 'success');
            } else {
                addResult('real-app', 'âŒ User not authenticated - need to login first', 'error');
            }
        }
        
        function openMainApp() {
            addResult('real-app', 'ðŸ”— Opening main app...', 'info');
            window.open('index-product.html', '_blank');
        }
        
        function openLoginPage() {
            addResult('real-app', 'ðŸ”— Opening login page...', 'info');
            window.open('login.html', '_blank');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”§ App functionality test page loaded');
            
            // Wait for Firebase and update status
            const checkFirebase = () => {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    updateAuthStatus();
                    
                    // Listen for auth state changes
                    firebase.auth().onAuthStateChanged((user) => {
                        console.log('ðŸ” Auth state changed:', user ? user.email : 'No user');
                        updateAuthStatus();
                    });
                    
                    // Auto-run basic tests
                    setTimeout(() => {
                        testAuthService();
                        testDatabaseService();
                        testStorageService();
                    }, 1000);
                } else {
                    setTimeout(checkFirebase, 100);
                }
            };
            
            checkFirebase();
        });
    </script>
</body>
</html>
