<!DOCTYPE html>
<!--
    ==================================================
    ðŸ¤– PROPOKIT APPLICATION - MAIN INDEX FILE (AI-FRIENDLY)
    ==================================================

    ðŸŽ¯ PURPOSE: This is a proposal generation application that helps users create
    professional business proposals with customizable themes, QR codes, and images.

    ðŸ—ï¸ ARCHITECTURE OVERVIEW:
    - Single Page Application (SPA) with dynamic page loading
    - Firebase backend for data storage and user management
    - Modular design with external modal files
    - CSS custom properties for theming system

    ðŸ“ FILE STRUCTURE:
    â”œâ”€â”€ HEAD SECTION: External libraries, CSS, and dependencies
    â”œâ”€â”€ CSS SECTION: Organized by component (Global, Themes, Layout, Components)
    â”œâ”€â”€ HTML BODY: Main app structure with header, sidebar, and content area
    â””â”€â”€ JAVASCRIPT: Organized by feature (Templates, Firebase, UI, Routing)

    ðŸ"§ KEY TECHNOLOGIES:
    - Frontend: HTML5, CSS3, JavaScript (ES6+)
    - Backend: Firebase (Database, Storage, Authentication)
    - Libraries: jQuery, Bootstrap 4.5.2, Font Awesome, QR Code generators
    - Build: No build process - pure HTML/CSS/JS

    ðŸŽ¨ THEMING SYSTEM:
    - 6 color themes (Ocean Blue, Forest Green, Royal Purple, etc.)
    - 3 corner styles (Sharp, Curvy, Hybrid)
    - CSS custom properties for easy customization

    ðŸ"± FEATURES:
    - Cover page with company/customer info
    - Company introduction page
    - Image management and cropping
    - QR code generation
    - PDF export
    - Responsive design

    ðŸš€ FOR AI DEVELOPERS:
    - Each function has JSDoc comments explaining purpose and parameters
    - CSS sections are clearly marked with emojis and descriptions
    - JavaScript functions are grouped by functionality
    - All external dependencies are documented
    - Firebase configuration is clearly explained

    ðŸ" LAST UPDATED: [Current Date]
    ==================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropoKit Application</title>

    <!-- ==================================================
         EXTERNAL LIBRARIES & DEPENDENCIES
         ================================================== -->

    <!-- Google Places API (Required for Autocomplete) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB28vXDucuMPk0vFycYglnFHXKzNzqpqRw&libraries=places"></script>

    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

    <!-- PropoKit Shared CSS -->
    <link rel="stylesheet" href="css\shared\global.css">
    <link rel="stylesheet" href="css\shared\utilities.css">
    <link rel="stylesheet" href="css\shared\Hader-Sidebar-Styles.css">
    <link rel="stylesheet" href="css\shared\modals.css">
    <link rel="stylesheet" href="css\shared\theme-styles.css">
    <link rel="stylesheet" href="css\shared\style-menu.css">
    <link rel="stylesheet" href="css\shared\floating-buttons.css">
    <link rel="stylesheet" href="css\shared\notifications.css">
    <link rel="stylesheet" href="css\shared\page-layout.css">
    <link rel="stylesheet" href="css\shared\crop-modal.css">

    <!-- Page Specific CSS -->
    <link rel="stylesheet" href="css/pages/about-page.css">

    <!-- Cover Page Specific CSS -->
    <link rel="stylesheet" href="css/pages/cover-page/cover-page.css">
    <link rel="stylesheet" href="css/pages/cover-page/image-upload.css">
    <link rel="stylesheet" href="css/pages/cover-page/customer-info-modal.css">
    <link rel="stylesheet" href="css/pages/cover-page/image-manager-modal.css">
    <link rel="stylesheet" href="css/pages/cover-page/qr-code-modal.css">
    <link rel="stylesheet" href="css/pages/cover-page/company-info-modal.css">

    <!-- Company Intro Page Specific CSS -->
    <link rel="stylesheet" href="css/pages/company-intro/company-intro-page.css">
    <link rel="stylesheet" href="css/pages/company-intro/company-image-manager-modal.css">
    <link rel="stylesheet" href="css/pages/company-intro/edit-text-modal.css">
    <link rel="stylesheet" href="css/pages/company-intro/edit-footer-modal.css">

    <!-- JavaScript Libraries (in dependency order) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="js/shared/firebase-config.js"></script>
    
    <!-- Propokit Clean Authentication System -->
    <script src="js/shared/clean-auth-system.js"></script>

    <!-- Utility Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.15/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <!-- ==================================================
         GOOGLE PLACES API STYLES
         ================================================== -->
    <style>
        .pac-container {
            z-index: 99999 !important;
            position: fixed !important;
            background: white !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        }

        .pac-item {
            padding: 8px 12px !important;
            cursor: pointer !important;
            border-bottom: 1px solid #eee !important;
        }

        .pac-item:hover {
            background-color: #f5f5f5 !important;
        }

        .pac-item-selected {
            background-color: #e3f2fd !important;
        }
    </style>

    <!-- ==================================================
         MAIN APPLICATION STYLES
         ================================================== -->
   
</head>
<body class="theme-ocean-blue theme-sharp">

    <!-- YOUR SVG ICONS, HEADER, AND SIDEBAR HTML GO HERE -->
  <header id="top-application-header">
    <div class="header-left">
        <a href="https://www.propokit.com/" target="_top" id="propokit-icon-logo">
            <span class="logo-text">Pr
                <svg class="logo-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 7L12 12M12 22V12M22 7L12 12M17 4.5L7 9.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            po</span>
            <span class="logo-text logo-kit">Kit</span>
        </a>
    </div>
<div class="header-document-title-wrapper">
    <i class="fas fa-file-alt document-icon"></i>
    <input type="text" id="header-document-title" placeholder="Untitled Proposal" />
    <!-- Authentication Status Indicator -->
    <div id="auth-status-indicator" class="auth-status-indicator" style="display: none;">
        <i class="fas fa-shield-alt"></i>
        <span class="auth-status-text">Local Mode</span>
    </div>
</div>
    <div class="header-right">
       <a href="#" data-page="product-library" class="header-btn header-btn-tool" title="Product Library"><i class="fas fa-swatchbook"></i><span>Product Library</span></a>
            <a href="#" data-page="pdf-combiner" class="header-btn header-btn-tool" title="PDF Combiner"><i class="fas fa-layer-group"></i><span>PDF Combiner</span></a>
        <div class="header-divider"></div>
        <div class="zoom-controls">
            <button id="zoom-out-btn" class="header-btn header-btn-icon-only" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
            <span id="zoom-level-display">100%</span>
            <button id="zoom-in-btn" class="header-btn header-btn-icon-only" title="Zoom In"><i class="fas fa-search-plus"></i></button>
        </div>
        <div class="header-divider"></div>

        <!-- Unified PropoKit Menu System -->
        <div class="propokit-menu-controls">
            <button id="propokit-menu-btn" class="header-btn header-btn-icon-only" title="PropoKit Menu">
                <i class="fas fa-rocket"></i>
            </button>
            <div class="propokit-style-menu">
                <div class="style-menu-header">
                    <h3>Style Settings</h3>
                </div>

                <!-- Corner Style Section -->
                <div class="style-menu-section">
                    <h4><i class="fas fa-shapes"></i> Corner Styles</h4>
                    <div class="style-options">
                        <div class="style-option" data-style="sharp">
                            <div class="style-preview sharp-preview"></div>
                            <div class="style-info">
                                <span class="style-name">Sharp</span>
                                <span class="style-desc">Professional square corners</span>
                            </div>
                        </div>
                        <div class="style-option" data-style="curvy">
                            <div class="style-preview curvy-preview"></div>
                            <div class="style-info">
                                <span class="style-name">Curvy</span>
                                <span class="style-desc">Friendly rounded corners</span>
                            </div>
                        </div>
                        <div class="style-option" data-style="hybrid">
                            <div class="style-preview hybrid-preview"></div>
                            <div class="style-info">
                                <span class="style-name">Hybrid</span>
                                <span class="style-desc">Sharp top, rounded bottom</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color Themes Section -->
                <div class="style-menu-section">
                    <h4><i class="fas fa-palette"></i> Color Themes</h4>

                    <!-- Color Style Toggle -->
                    <div class="color-style-toggle">
                        <button class="toggle-btn active" data-style="solid">
                            <i class="fas fa-square"></i> Solid Colors
                        </button>
                        <button class="toggle-btn" data-style="rainbow">
                            <i class="fas fa-rainbow"></i> Rainbow QR
                        </button>
                    </div>

                    <!-- Solid Color Themes (Row 1) -->
                    <div class="theme-grid solid-themes active">
                        <div class="theme-option" data-theme="ocean-blue" data-style="solid">
                            <div class="theme-preview ocean-blue"></div>
                            <span>Ocean Blue</span>
                        </div>
                        <div class="theme-option" data-theme="forest-green" data-style="solid">
                            <div class="theme-preview forest-green"></div>
                            <span>Forest Green</span>
                        </div>
                        <div class="theme-option" data-theme="royal-purple" data-style="solid">
                            <div class="theme-preview royal-purple"></div>
                            <span>Royal Purple</span>
                        </div>
                        <div class="theme-option" data-theme="midnight-blue" data-style="solid">
                            <div class="theme-preview midnight-blue"></div>
                            <span>Midnight Blue</span>
                        </div>
                        <div class="theme-option" data-theme="rose-gold" data-style="solid">
                            <div class="theme-preview rose-gold"></div>
                            <span>Rose Gold</span>
                        </div>
                        <div class="theme-option" data-theme="coral-reef" data-style="solid">
                            <div class="theme-preview coral-reef"></div>
                            <span>Coral Reef</span>
                        </div>
                    </div>

                    <!-- Rainbow Color Themes (Row 2) -->
                    <div class="theme-grid rainbow-themes">
                        <div class="theme-option" data-theme="ocean-blue" data-style="rainbow">
                            <div class="theme-preview ocean-blue"></div>
                            <span>Ocean Blue</span>
                        </div>
                        <div class="theme-option" data-theme="forest-green" data-style="rainbow">
                            <div class="theme-preview forest-green"></div>
                            <span>Forest Green</span>
                        </div>
                        <div class="theme-option" data-theme="royal-purple" data-style="rainbow">
                            <div class="theme-preview royal-purple"></div>
                            <span>Royal Purple</span>
                        </div>
                        <div class="theme-option" data-theme="midnight-blue" data-style="mixed">
                            <div class="theme-preview midnight-blue"></div>
                            <span>Midnight Blue</span>
                        </div>
                        <div class="theme-option" data-theme="rose-gold" data-style="mixed">
                            <div class="theme-preview rose-gold"></div>
                            <span>Rose Gold</span>
                        </div>
                        <div class="theme-option" data-theme="coral-reef" data-style="mixed">
                            <div class="theme-preview coral-reef"></div>
                            <span>Coral Reef</span>
                        </div>
                    </div>
                </div>



                <!-- Menu Footer -->
                <div class="style-menu-footer">
                    <div class="current-settings">
                        <span class="current-corner">Corner: <strong id="current-corner-style">Sharp</strong></span>
                        <span class="current-theme">Theme: <strong id="current-color-theme">Ocean Blue</strong></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-divider"></div>
        <button id="header-download-pdf-btn" class="header-btn header-btn-download" title="Download as PDF">
            <i class="fas fa-download"></i>
        </button>
        <button id="header-print-btn" class="header-btn header-btn-print" title="Print Proposal">
            <i class="fas fa-print"></i>
        </button>
        <div class="header-divider"></div>
        
        <!-- Authentication Section - Moved to far right -->
        <div class="auth-section" style="display: flex; align-items: center; margin-left: auto; position: relative;">
            <!-- User Profile (shown when logged in) -->
            <div id="user-profile-menu" style="display: none; position: relative;">
                <div class="user-avatar" id="user-avatar-trigger" style="cursor: pointer;">
                    <span id="user-avatar-text">GU</span>
                    <div class="user-status-indicator online"></div>
                </div>
                
                <!-- User Profile Dropdown -->
                <div class="profile-dropdown" id="user-profile-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 250px; z-index: 1000; margin-top: 8px;">
                    <div class="dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid #eee;">
                        <strong id="profile-user-name" style="display: block; font-size: 14px; color: #333;">Guest User</strong>
                        <span id="profile-user-email" style="display: block; font-size: 12px; color: #666; margin-top: 2px;">Not logged in</span>
                    </div>
                    <a href="https://www.propokit.com/dashboard" target="_top" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-th-large" style="margin-right: 8px;"></i> Dashboard</a>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-user-circle" style="margin-right: 8px;"></i> My Account</a>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-cog" style="margin-right: 8px;"></i> Settings</a>
                    <div class="dropdown-divider" style="height: 1px; background: #eee; margin: 8px 0;"></div>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-life-ring" style="margin-right: 8px;"></i> Help Center</a>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-gift" style="margin-right: 8px;"></i> What's New?</a>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-comment-dots" style="margin-right: 8px;"></i> Give Feedback</a>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-bug" style="margin-right: 8px;"></i> Report a Bug</a>
                    <div class="dropdown-divider" style="height: 1px; background: #eee; margin: 8px 0;"></div>
                    <a href="#" class="dropdown-item" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f5f5f5;"><i class="fas fa-credit-card" style="margin-right: 8px;"></i> Manage Subscription</a>
                    <div class="dropdown-item dropdown-item-toggle" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-bottom: 1px solid #f5f5f5;">
                        <div class="dropdown-item-label" style="display: flex; align-items: center;">
                            <i class="fas fa-adjust" style="margin-right: 8px;"></i>
                            <span>Theme</span>
                        </div>
                        <div id="theme-switcher-dropdown">
                            <input type="checkbox" id="theme-toggle-checkbox" title="Toggle between light and dark theme">
                            <label for="theme-toggle-checkbox" class="theme-toggle-label">
                                <i class="fas fa-moon"></i>
                                <i class="fas fa-sun"></i>
                                <span class="ball"></span>
                            </label>
                        </div>
                    </div>
                    <div class="dropdown-divider" style="height: 1px; background: #eee; margin: 8px 0;"></div>
                    <a href="#" class="dropdown-item" id="logout-btn" style="display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px;">
                        <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Log Out
                    </a>
                </div>
            </div>
        </div>
</header>
 <aside id="main-sidebar">
        <div id="main-nav-wrapper">
            <nav id="main-nav" aria-label="Proposal Sections">
                <div id="nav-link-container">
                    <div id="active-nav-indicator"></div>
                    <div class="nav-section-header">Content</div>
                    <a href="#" data-page="cover-page" class="nav-link" title="Cover Page"><svg class="nav-icon"><use xlink:href="#icon-cover-page"></use></svg><span>Cover Page</span></a>
                    <a href="#" data-page="company-intro" class="nav-link" title="Company Introduction"><svg class="nav-icon"><use xlink:href="#icon-about-us"></use></svg><span>Company Intro</span></a>
                    <a href="#" data-page="products-services" class="nav-link" title="Products & Services"><svg class="nav-icon"><use xlink:href="#icon-product-list"></use></svg><span>Products & Services</span></a>
                    <a href="#" data-page="scope-of-work" class="nav-link" title="Scope of Work"><svg class="nav-icon"><use xlink:href="#icon-scope"></use></svg><span>Scope of Work</span></a>
                    <a href="#" data-page="objectives" class="nav-link" title="Objectives"><svg class="nav-icon"><use xlink:href="#icon-objectives"></use></svg><span>Objectives</span></a>
                    <div class="nav-section-header">Financials</div>
                    <a href="#" data-page="pricing-summary" class="nav-link" title="Pricing Summary"><svg class="nav-icon"><use xlink:href="#icon-pricing"></use></svg><span>Pricing Summary</span></a>
                    <div class="nav-section-header">Closing</div>
                    <a href="#" data-page="terms-and-conditions" class="nav-link" title="Terms & Conditions"><svg class="nav-icon"><use xlink:href="#icon-contract"></use></svg><span>Terms & Conditions</span></a>
                </div>
            </nav>
        </div>
    </aside>


    <!-- MAIN CONTENT AREA -->
    <main id="page-content"></main>



    <!-- ==================================================
         MAIN APPLICATION SCRIPT
         ================================================== -->
    <script>
        (() => {
            // =================================================================
            // === ðŸ"„ VIRTUAL FILE SYSTEM (HTML Templates)
            // =================================================================
            // AI NOTE: This section contains HTML templates stored as JavaScript strings.
            // These templates are loaded dynamically when users navigate between pages.
            // This approach allows for a single-page application experience.

            // ðŸ" COVER PAGE TEMPLATE
            // This is the main landing page with company info, customer details, and QR codes
            const coverPageHTML = `
                <div class="container">
                    <div class="box">
                        <h1 id="companyNameHeader" class="company-header">Denali Tech Custom Proposal</h1>
                        <p>Prepared for: <span id="customerName"></span></p>
                        <p id="addressParent">Address: <span id="customerAddress"></span></p>
                        <p id="emailParent">Email: <span id="customerEmail"></span></p>
                        <p id="phoneParent">Phone: <span id="customerPhone"></span></p>
                        <p>Proposal Info: <span id="proposalInfo"></span></p>
                        <p>Date: <span id="date"></span></p>
                    </div>

                    <div class="image-display-container">
                        <img id="customImage" src="" class="default-image hidden" crossorigin="anonymous"/>
                    </div>


                    <!-- QR Code Display Area -->
                    <div class="qr-code-display-area">
                        <div id="pdfQrCodeContainer">
                            <div class="qr-code-wrapper">
                                <div class="scan-for-pdf-message">Document QR Code</div>
                                <div class="qr-code-container">
                                    <div id="pdfQrcode">
                                        <div class="sample-qr-placeholder">ðŸ"„</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="customQrCodeContainer">
                            <div class="qr-code-wrapper">
                                <div class="scan-for-custom-message" id="customQrMessage">Custom Link</div>
                                <div class="qr-code-container">
                                    <div id="customQrcode">
                                        <div class="sample-qr-placeholder">ðŸ"—</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="websiteQrCodeContainer">
                            <div class="qr-code-wrapper">
                                <div class="scan-for-website-message">Website QR Code</div>
                                <div class="qr-code-container">
                                    <div id="websiteQrcode">
                                        <div class="sample-qr-placeholder">ðŸŒ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Placeholder to maintain spacing when no QR codes are shown -->
                        <div id="qrCodePlaceholder" class="qr-code-placeholder"></div>
                    </div>

                    <div class="company-info">
                        <p>Denali Tech</p>
                        <p>800 W Central Rd Suite 130, Mt Prospect, IL 60056</p>
                        <p>Phone: (312) 500-3053</p>
                        <p>Email: AshBoraki@DenaliTechs.com</p>
                        <p>Website: www.DenaliTechs.com</p>
                    </div>
                </div>

                <!-- Floating Action Buttons -->
                <button type="button" id="enterDetailsBtn" class="action-fab nav-color-scope" data-toggle="modal" data-target="#myModal" title="Enter Details">
                    <i class="fas fa-keyboard"></i><span>Enter Details</span>
                </button>
                <button type="button" id="toggleImageButton" class="action-fab nav-color-about-us" data-toggle="modal" data-target="#combinedImageModal" title="Select & Upload Image">
                    <i class="fas fa-image"></i><span>Select & Upload Image</span>
                </button>
                <button type="button" id="generateQrButton" class="action-fab nav-color-pricing" data-toggle="modal" data-target="#qrModal" title="Generate QR Code">
                    <i class="fas fa-qrcode"></i><span>Generate QR Code</span>
                </button>
                <button type="button" id="editInfoButton" class="action-fab nav-color-cover-page" data-toggle="modal" data-target="#infoModal" title="Edit Company Info">
                    <i class="fas fa-building"></i><span>Edit Company Info</span>
                </button>
            `;
            const companyIntroHTML = `

            <!-- Edit Text Modal -->
<div class="modal fade" id="editTextModal" tabindex="-1" role="dialog" aria-labelledby="editTextModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Enhanced Header with Progress Indicator -->
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="editTextModalLabel">
              <span class="title-main">Edit Text Content</span>
              <span class="title-subtitle">Modify your company introduction text</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Company</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Services</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Proposal</div>
          </div>
        </div>

        <form id="text-edit-form" class="customer-form">
          <!-- Step 1: Company Information -->
          <div class="form-step active" data-step="1">
            <div class="step-header">
              <h6><i class="fas fa-building"></i> Company Information</h6>
            </div>

            <div class="contact-option step1-company-field">
              <div class="option-header">
                <label for="paragraph1Input" class="option-label">
                  <i class="fas fa-paragraph"></i>
                  <span>Company Introduction</span>
                  <span class="required">*</span>
                </label>
              </div>
              <div class="option-description">
                Main company description and overview
              </div>
              <div class="form-group customer-form-group">
                <textarea id="paragraph1Input" class="form-control customer-input" rows="3"
                          placeholder="Enter your company introduction..." required></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-building"></i>
                  This will appear as the main company description
                </small>
              </div>
            </div>

            <div class="contact-option step1-approach-field">
              <div class="option-header">
                <label for="paragraph2Input" class="option-label">
                  <i class="fas fa-handshake"></i>
                  <span>Our Approach</span>
                </label>
              </div>
              <div class="option-description">
                Describe your company's approach and methodology
              </div>
              <div class="form-group customer-form-group">
                <textarea id="paragraph2Input" class="form-control customer-input" rows="3"
                          placeholder="Describe your approach to projects..."></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-lightbulb"></i>
                  Explain how you work with clients
                </small>
              </div>
            </div>
          </div>

          <!-- Step 2: Services Information -->
          <div class="form-step" data-step="2">
            <div class="step-header">
              <h6><i class="fas fa-cogs"></i> Services Overview</h6>
            </div>

            <div class="contact-option step2-services-field">
              <div class="option-header">
                <label for="paragraph3Input" class="option-label">
                  <i class="fas fa-tools"></i>
                  <span>Services Description</span>
                </label>
              </div>
              <div class="option-description">
                Overview of your services and capabilities
              </div>
              <div class="form-group customer-form-group">
                <textarea id="paragraph3Input" class="form-control customer-input" rows="3"
                          placeholder="Describe your services and capabilities..."></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-check-circle"></i>
                  Highlight what makes your services unique
                </small>
              </div>
            </div>

            <div class="contact-option step2-expertise-field">
              <div class="option-header">
                <label for="paragraph4Input" class="option-label">
                  <i class="fas fa-star"></i>
                  <span>Expertise & Experience</span>
                </label>
              </div>
              <div class="option-description">
                Showcase your expertise and experience
              </div>
              <div class="form-group customer-form-group">
                <textarea id="paragraph4Input" class="form-control customer-input" rows="3"
                          placeholder="Highlight your expertise and experience..."></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-award"></i>
                  Share your qualifications and track record
                </small>
              </div>
            </div>
          </div>

          <!-- Step 3: Proposal Introduction -->
          <div class="form-step" data-step="3">
            <div class="step-header">
              <h6><i class="fas fa-file-contract"></i> Proposal Introduction</h6>
            </div>

            <div class="contact-option step3-proposal-field">
              <div class="option-header">
                <label for="proposalIntroInput" class="option-label">
                  <i class="fas fa-info-circle"></i>
                  <span>Proposal Introduction</span>
                </label>
              </div>
              <div class="option-description">
                Introduction text for the proposal
              </div>
              <div class="form-group customer-form-group">
                <textarea id="proposalIntroInput" class="form-control customer-input" rows="2"
                          placeholder="Enter proposal introduction text..."></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-file-alt"></i>
                  This text will appear at the end of the about section
                </small>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Enhanced Footer with Navigation -->
      <div class="modal-footer">
        <div class="footer-left">
          <button type="button" class="btn btn-outline-secondary" id="prevTextStepBtn">
            <i class="fas fa-arrow-left"></i> Previous
          </button>
        </div>

        <div class="footer-center">
          <!-- Step indicator removed for cleaner look -->
        </div>

        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="nextTextStepBtn">
            Next <i class="fas fa-arrow-right"></i>
          </button>
          <button type="button" class="btn btn-success" id="saveTextBtn">
            <i class="fas fa-check"></i> Save Text Changes
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

            <!-- Company Intro Crop Modal -->
<div class="modal fade" id="companyIntroCropModal" tabindex="-1" role="dialog" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-crop-alt"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="cropModalLabel">
              <span class="title-main">Company Image Manager</span>
              <span class="title-subtitle">Upload and crop your company intro image</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="image-manager-container">
          <!-- Left Column: Upload + Controls -->
          <div class="image-sidebar">
            <!-- Upload Section -->
            <div class="upload-section">
              <label for="cropImageInput" class="upload-btn">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Upload New Image</span>
                <small>Click to browse or drag & drop</small>
              </label>
              <input type="file" id="cropImageInput" accept="image/*">
            </div>

            <!-- Controls Section -->
            <div class="crop-controls-section">
              <div class="control-group">
                <h6 class="control-title">
                  <i class="fas fa-arrows-alt"></i>
                  Movement
                </h6>
                <div class="movement-controls">
                  <button type="button" id="moveUpBtn" class="control-btn" disabled>
                    <i class="fas fa-arrow-up"></i>
                  </button>
                  <div class="movement-row">
                    <button type="button" id="moveLeftBtn" class="control-btn" disabled>
                      <i class="fas fa-arrow-left"></i>
                    </button>
                    <button type="button" id="moveRightBtn" class="control-btn" disabled>
                      <i class="fas fa-arrow-right"></i>
                    </button>
                  </div>
                  <button type="button" id="moveDownBtn" class="control-btn" disabled>
                    <i class="fas fa-arrow-down"></i>
                  </button>
                </div>
              </div>

              <div class="control-group">
                <h6 class="control-title">
                  <i class="fas fa-search-plus"></i>
                  Zoom
                </h6>
                <div class="zoom-controls">
                  <button type="button" id="zoomOutBtn" class="control-btn" disabled>
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="range" id="zoomSlider" min="0.1" max="2" step="0.01" value="1" class="control-slider" disabled>
                  <button type="button" id="zoomInBtn" class="control-btn" disabled>
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>

              <div class="control-group">
                <h6 class="control-title">
                  <i class="fas fa-redo"></i>
                  Rotate
                </h6>
                <div class="rotate-controls">
                  <button type="button" id="rotateLeftBtn" class="control-btn" disabled>
                    <i class="fas fa-undo"></i>
                  </button>
                  <input type="range" id="rotateSlider" min="-180" max="180" step="1" value="0" class="control-slider" disabled>
                  <button type="button" id="rotateRightBtn" class="control-btn" disabled>
                    <i class="fas fa-redo"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="crop-status">
              <div class="status-content">
                <span id="cropStatus" class="status-text">Upload an image to get started</span>
                <span id="cropLoadingSpinner" class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i>
                </span>
              </div>
            </div>
          </div>

          <!-- Right Column: Canvas Container -->
          <div class="crop-main-area">
            <div id="cropContainer" class="crop-container">
              <canvas id="imageCanvas"></canvas>
              <div id="cropGrid" class="crop-grid">
                <div id="gridLines" class="grid-lines">
                  <div class="grid-line horizontal"></div>
                  <div class="grid-line horizontal"></div>
                  <div class="grid-line vertical"></div>
                  <div class="grid-line vertical"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button type="button" id="resetCropBtn" class="btn btn-outline-secondary" disabled>
            <i class="fas fa-undo"></i> Reset Crop
          </button>
        </div>
        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Close
          </button>
          <button type="button" id="saveCropBtn" class="btn btn-primary" disabled>
            <i class="fas fa-check"></i> Save Image
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

            <!-- Edit Footer Modal -->
<div class="modal fade" id="editFooterModal" tabindex="-1" role="dialog" aria-labelledby="editFooterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="editFooterModalLabel">
              <span class="title-main">Edit Footer Content</span>
              <span class="title-subtitle">Modify your company footer information</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="footer-editor-container">
          <div class="form-group">
            <label for="footerLine1Input">
              <i class="fas fa-building"></i> Footer Line 1 (Company Name):
            </label>
            <input type="text" id="footerLine1Input" class="form-control" placeholder="Enter company name...">
          </div>

          <div class="form-group">
            <label for="footerLine2Input">
              <i class="fas fa-map-marker-alt"></i> Footer Line 2 (Address):
            </label>
            <input type="text" id="footerLine2Input" class="form-control" placeholder="Enter address...">
          </div>

          <div class="form-group">
            <label for="footerLine3Input">
              <i class="fas fa-phone"></i> Footer Line 3 (Phone & Website):
            </label>
            <input type="text" id="footerLine3Input" class="form-control" placeholder="Enter phone and website...">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="footer-left">
          <button type="button" id="resetFooterBtn" class="btn btn-outline-secondary">
            <i class="fas fa-undo"></i> Reset to Default
          </button>
        </div>
        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" id="saveFooterBtn" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

            <!-- Main Container -->
<div class="a4-page">
  <div class="main-content">
    <div class="blue-strip"></div>
    <div class="text-center">
      <div id="imageFrame">
        <img id="previewImage" crossOrigin="anonymous" alt="Preview Image">
      </div>
      <div id="uploadSpinner">
        <div class="spinner-border" role="status">
          <span class="sr-only">Uploading...</span>
        </div>
      </div>
      <div id="uploadProgressBar" class="progress">
        <div class="progress-bar" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>

    <h2 class="text-center">About Us</h2>
    <div class="about-section" id="aboutSection">
      <p>Denali Tech specializes in advanced audio...</p>
      <p>We take a consultative approach...</p>
      <p>With our comprehensive services...</p>
      <p>Whether you're looking to install ...</p>
      <p id="proposalIntro"></p>
    </div>
  </div>

  <footer>
    <div id="footerContent">
      <p>Denali Tech - Home Automation & Custom AV Solutions</p>
      <p>1234 Main Street, Anytown, USA</p>
      <p>Phone: (603) 387-0129 | www.denalitechstest.com</p>
                </div>
          </footer>
        </div>

             <!-- FLOATING ACTION BUTTONS -->
    <button type="button" id="editTextButton" class="action-fab nav-color-scope" data-toggle="modal" data-target="#editTextModal" title="Edit Text Content">
      <i class="fas fa-edit"></i><span>Edit Text Content</span>
    </button>
    <button type="button" id="editFooterButton" class="action-fab nav-color-cover-page" data-toggle="modal" data-target="#editFooterModal" title="Edit Footer Content">
      <i class="fas fa-pencil-alt"></i><span>Edit Footer Content</span>
    </button>
    <button type="button" id="openCropModalBtn" class="action-fab nav-color-about-us" data-toggle="modal" data-target="#companyIntroCropModal" title="Crop Company Intro Image">
      <i class="fas fa-crop-alt"></i><span>Crop Company Intro Image</span>
    </button>`;

            // Company Intro Page FAB Buttons are now embedded directly in the companyIntroHTML template
            const productsServicesHTML = `<div class="a4-container"><h1>Products & Services</h1><p>Content for this page is loaded here.</p></div>`;
            const scopeOfWorkHTML = `<div class="a4-container"><h1>Scope of Work</h1><p>Content for this page is loaded here.</p></div>`;
            const objectivesHTML = `<div class="a4-container"><h1>Objectives</h1><p>Content for this page is loaded here.</p></div>`;
            const pricingSummaryHTML = `<div class="a4-container"><h1>Pricing Summary</h1><p>Content for this page is loaded here.</p></div>`;
            const termsConditionsHTML = `<div class="a4-container"><h1>Terms & Conditions</h1><p>Content for this page is loaded here.</p></div>`;

            const pageTemplates = {
                'cover-page': { html: coverPageHTML, init: initCoverPage },
                'company-intro': { html: companyIntroHTML, init: initCompanyIntro },
                'products-services': { html: productsServicesHTML, init: () => {} },
                'scope-of-work': { html: scopeOfWorkHTML, init: () => {} },
                'objectives': { html: objectivesHTML, init: () => {} },
                'pricing-summary': { html: pricingSummaryHTML, init: () => {} },
                'terms-and-conditions': { html: termsConditionsHTML, init: () => {} },
            };

            // =================================================================
            // === ðŸ"¥ FIREBASE CONFIGURATION & GLOBAL STATE
            // =================================================================
            // AI NOTE: Firebase configuration has been moved to js/shared/firebase-config.js
            // This provides better organization and makes the config reusable across files.
            // The firebase-config.js file handles initialization and provides global access.

            // Firebase configuration is now handled by firebase-config.js
            // The configuration automatically initializes when the script loads

            // ==================================================
            // ðŸŒ GLOBAL FIREBASE REFERENCE VARIABLES
            // ==================================================
            window.currentFirebaseUID = "";        // Current user's unique identifier
            window.companyInfoRef = null;          // Reference to company information in database
            window.proposalDataRef = null;         // Reference to proposal data in database
            window.qrCodesRef = null;              // Reference to QR code data in database
            window.coverImageRef = null;           // Reference to cover image in storage
            window.appInitialized = false;         // Flag to track if app has been initialized

            // =================================================================
            // === ðŸŽ¨ UI UPDATE & DATA HANDLING FUNCTIONS
            // =================================================================
            // AI NOTE: This section contains functions that update the user interface
            // when data changes. These functions are called whenever:
            // - Firebase data is updated
            // - User input changes
            // - Page navigation occurs
            // - Data is loaded from storage

            // These functions update the user interface when data changes
            // They handle both Firebase data and local data updates

            /**
             * ðŸ¢ Updates company information in the UI
             * This function updates all company-related fields on the page
             * @param {Object} data - Company data object with company details
             */
            function updateCompanyInfoUI(data = {}) {
                const companyName = data.companyName || "Denali Tech";
                $('#companyName').val(companyName);
                $('.company-info p:nth-child(1)').text(companyName);
                $('#companyNameHeader').text(companyName + " Custom Proposal");
                $('#companyAddress').val(data.companyAddress || "800 W Central Rd Suite 130, Mt Prospect, IL 60056");
                $('.company-info p:nth-child(2)').text(data.companyAddress || "800 W Central Rd Suite 130, Mt Prospect, IL 60056");
                $('#companyPhone').val(data.companyPhone || "(312) 500-3053");
                $('.company-info p:nth-child(3)').text("Phone: " + (data.companyPhone || "(312) 500-3053"));
                $('#companyEmail').val(data.companyEmail || "AshBoraki@DenaliTechs.com");
                $('.company-info p:nth-child(4)').text("Email: " + (data.companyEmail || "AshBoraki@DenaliTechs.com"));
                $('#companyWebsite').val(data.companyWebsite || "www.DenaliTechs.com");
                $('.company-info p:nth-child(5)').text("Website: " + (data.companyWebsite || "www.DenaliTechs.com"));
            }

            /**
             * ðŸ"‹ Updates proposal data in the UI
             * This function updates customer information and proposal details
             * It also handles showing/hiding optional fields based on checkbox states
             * @param {Object} data - Proposal data object with customer and proposal details
             */
            function updateProposalDataUI(data = {}) {
                $('#customerName').text(" " + (data.name || ""));
                $('#customerNameInput').val(data.name || "");
                $('#customerAddress').text(data.address || "");
                $('#customerAddressInput').val(data.address || "");

                // Restore checkbox states from Firebase
                const showPhone = data.showPhone !== false; // Default to true if not set
                const showEmail = data.showEmail === true; // Default to false if not set
                const showAddress = data.showAddress !== false; // Default to true if not set

                $('#selectPhone').prop('checked', showPhone);
                $('#selectEmail').prop('checked', showEmail);
                $('#selectAddress').prop('checked', showAddress);

                // Update phone field based on checkbox state
                const phoneData = data.phone || "";
                $('#customerPhoneInput').val(phoneData);
                if (showPhone) {
                    $('#customerPhone').text(phoneData);
                    $('#phoneParent').show();
                } else {
                    $('#customerPhone').text("");
                    $('#phoneParent').hide();
                }

                // Update email field based on checkbox state
                const emailData = data.email || "";
                $('#customerEmailInput').val(emailData);
                if (showEmail) {
                    $('#customerEmail').text(emailData);
                    $('#emailParent').show();
                } else {
                    $('#customerEmail').text("");
                    $('#emailParent').hide();
                }

                // Update address field based on checkbox state
                const addressData = data.address || "";
                $('#customerAddressInput').val(addressData);
                if (showAddress) {
                    $('#customerAddress').text(addressData);
                    $('#addressParent').show();
                } else {
                    $('#customerAddress').text("");
                    $('#addressParent').hide();
                }

                $('#proposalInfo').text(data.proposalInfo || "");
                $('#proposalInfoInput').val(data.proposalInfo || "");
                $('#date').text(data.proposalDate || "");
                if (!$('#proposalDateInput').val()) $('#proposalDateInput').val(data.proposalDate || "");
            }

            // *** MODIFIED FUNCTION ***
            function updateQrCodesUI(data = {}) {
                // Update the modal's input fields
                $('#websiteUrlInput').val(data.websiteUrl || "");
                $('#pdfUrlInput').val(data.pdfUrl || "");
                $('#customUrlInput').val(data.customUrl || "");
                $('#customLabelInput').val(data.customLabel || "");

                // *** CRITICAL FIX ***
                // Set the checkbox state based on the data from Firebase
                $('#websiteUrlCheckbox').prop('checked', data.showWebsiteQr === true);
                $('#pdfCheckbox').prop('checked', data.showPdfQr === true);
                $('#customCheckbox').prop('checked', data.showCustomQr === true);

                // Only redraw QR codes if we have actual data, otherwise keep sample placeholders
                if (data.showWebsiteQr || data.showPdfQr || data.showCustomQr) {
                    generatePageQRCodes(data);
                }
            }

            function updateCoverImageUI(url) {
                if (url) {
                    $('#customImage').attr('src', url).show();
                    $('#image1, #image2').hide();
                } else {
                    $('#customImage').hide();
                    $('#image2').show();
                }
            }

            function updateAboutUI(data = {}) {
                const paragraphs = $('#aboutSection p');
                const paragraph1 = data.paragraph1 || data.paragraph1Content || "Denali Tech specializes in advanced audio and home automation solutions.";
                const paragraph2 = data.paragraph2 || data.paragraph2Content || "We take a consultative approach to understand your unique needs and preferences.";
                const paragraph3 = data.paragraph3 || data.paragraph3Content || "With our comprehensive services, we handle everything from initial consultation to final installation.";
                const paragraph4 = data.paragraph4 || data.paragraph4Content || "Whether you are looking to install a simple sound system or a complex smart home setup, we have the expertise.";
                const proposalIntro = data.proposalIntro || data.proposalIntroContent || "";

                // Update the paragraphs
                if (paragraphs.length >= 1) paragraphs.eq(0).text(paragraph1);
                if (paragraphs.length >= 2) paragraphs.eq(1).text(paragraph2);
                if (paragraphs.length >= 3) paragraphs.eq(2).text(paragraph3);
                if (paragraphs.length >= 4) paragraphs.eq(3).text(paragraph4);
                if (paragraphs.length >= 5) paragraphs.eq(4).text(proposalIntro);
            }

            function updateFooterUI(data = {}) {
                const footerParagraphs = $('#footerContent p');
                const line1 = data.line1 || data.footerLine1 || "Denali Tech - Home Automation & Custom AV Solutions";
                const line2 = data.line2 || data.footerLine2 || "1234 Main Street, Anytown, USA";
                const line3 = data.line3 || data.footerLine3 || "Phone: (603) 387-0129 | www.denalitechstest.com";

                // Update the footer lines
                if (footerParagraphs.length >= 1) footerParagraphs.eq(0).text(line1);
                if (footerParagraphs.length >= 2) footerParagraphs.eq(1).text(line2);
                if (footerParagraphs.length >= 3) footerParagraphs.eq(2).text(line3);
            }

            function getInitials(name) {
                if (!name || typeof name !== 'string') return '?';
                const parts = name.trim().split(' ');
                const first = parts[0] ? parts[0][0] : '';
                const last = parts.length > 1 ? parts[parts.length - 1][0] : '';
                return (first + last).toUpperCase();
            }

            function showNotification(message, type = 'info') {
                // Create a simple notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                    max-width: 300px;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                // Remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 3000);
            }

            // Make showNotification available globally
            window.showNotification = showNotification;

            function updateUserProfileUI(name, email) {
                if (name) {
                    $('#profile-user-name').text(name);
                    $('#user-avatar-trigger span').text(getInitials(name));
                }
                if (email) {
                    $('#profile-user-email').text(email);
                }
            }

            function resetUserProfileUI() {
                $('#profile-user-name').text('Guest User');
                $('#profile-user-email').text('Not logged in');
                $('#user-avatar-trigger span').text('GU');
                updateCompanyInfoUI();
                updateProposalDataUI();
                updateQrCodesUI();
                updateCoverImageUI(null);
            }

            async function reinitializeFirebaseRefs(newUID) {
                if (!newUID) {
                    resetUserProfileUI();
                    return;
                }
                window.currentFirebaseUID = newUID;
                localStorage.setItem("firebaseUID", window.currentFirebaseUID);
                const userRef = firebase.database().ref(`users/${newUID}`);
                window.companyInfoRef = userRef.child("companyInfo");
                window.proposalDataRef = userRef.child("proposalData");
                window.qrCodesRef = userRef.child("qrCodes");
                window.coverImageRef = userRef.child("coverImageUrl");

                window.companyInfoRef.on('value', snap => updateCompanyInfoUI(snap.val()));
                window.proposalDataRef.on('value', snap => updateProposalDataUI(snap.val()));
                window.qrCodesRef.on('value', snap => updateQrCodesUI(snap.val()));
                window.coverImageRef.on('value', snap => updateCoverImageUI(snap.val()));
            }

                        // =================================================================
            // === 🔐 AUTHENTICATION CHECK (USING CLEAN AUTH)
            // =================================================================
            
            // Simple authentication check - redirect to home if not logged in
            // The clean auth system handles all authentication
            document.addEventListener('DOMContentLoaded', () => {
                console.log('🔍 Main app loaded, checking authentication...');
                
                // Wait for Firebase to be ready before checking auth
                const waitForFirebaseAndCheckAuth = () => {
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        console.log('✅ Firebase ready, checking auth state...');
                        
                        // Listen for auth state changes
                        firebase.auth().onAuthStateChanged((user) => {
                            console.log('🔍 Auth state changed:', user ? user.email : 'No user');
                            
                            if (user) {
                                console.log('✅ User authenticated:', user.email);
                                window.currentFirebaseUID = user.uid;
                                localStorage.setItem('firebaseUID', user.uid);
                                reinitializeFirebaseRefs(user.uid);
                            } else {
                                // Check if we have a stored UID as fallback
                                const storedUID = localStorage.getItem('firebaseUID');
                                if (storedUID) {
                                    console.log('⚠️ No current user but found stored UID, using fallback');
                                    window.currentFirebaseUID = storedUID;
                                    reinitializeFirebaseRefs(storedUID);
                                } else {
                                    console.log('❌ No authenticated user found, redirecting to home page...');
                                    window.location.href = '../index.html';
                                }
                            }
                        });
                        
                        // Also check current user immediately
                        const currentUser = firebase.auth().currentUser;
                        const storedUID = localStorage.getItem('firebaseUID');
                        
                        if (currentUser || storedUID) {
                            console.log('✅ User authenticated (immediate check):', currentUser ? currentUser.email : 'Stored UID found');
                            
                            if (currentUser) {
                                window.currentFirebaseUID = currentUser.uid;
                                localStorage.setItem('firebaseUID', currentUser.uid);
                            } else if (storedUID) {
                                window.currentFirebaseUID = storedUID;
                            }
                            
                            if (window.currentFirebaseUID) {
                                reinitializeFirebaseRefs(window.currentFirebaseUID);
                            }
                        } else {
                            console.log('❌ No authenticated user found, redirecting to home page...');
                            window.location.href = '../index.html';
                        }
                    } else {
                        console.log('⏳ Waiting for Firebase...');
                        setTimeout(waitForFirebaseAndCheckAuth, 100);
                    }
                };
                
                waitForFirebaseAndCheckAuth();
            });

            // =================================================================
            // === WIX SESSION CONTROLLER (EVENT LISTENER)
            // =================================================================
            window.addEventListener("message", async function(event) {
                if (!event || !event.data) return;
                if (event.data.clear) {
                    localStorage.removeItem("firebaseUID");
                    await reinitializeFirebaseRefs("");
                    window.appInitialized = true;
                    return;
                }
                let { firebaseUID, userName, userEmail } = event.data;
                if (userName || userEmail) {
                    updateUserProfileUI(userName, userEmail);
                }
                if (firebaseUID && (firebaseUID !== window.currentFirebaseUID || !window.appInitialized)) {
                    await reinitializeFirebaseRefs(firebaseUID);
                    window.appInitialized = true;
                }
            }, false);

            // =================================================================
            // === 🔐 AUTHENTICATION SYSTEM (USING CLEAN AUTH)
            // =================================================================
            
            // The authentication system is now handled by clean-auth-system.js
            // This ensures consistent behavior across marketing page and main application
            
            // Update user profile UI when auth state changes
            function updateMainAppUserProfile(user) {
                if (user) {
                    // Update user avatar in main app header
                    const userAvatarText = document.getElementById('user-avatar-text');
                    if (userAvatarText) {
                        userAvatarText.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                    }
                    
                    // Update profile dropdown info
                    const profileUserName = document.getElementById('profile-user-name');
                    const profileUserEmail = document.getElementById('profile-user-email');
                    if (profileUserName) profileUserName.textContent = user.displayName || 'User';
                    if (profileUserEmail) profileUserEmail.textContent = user.email;
                    
                    // Show user profile
                    const authUserProfile = document.getElementById('user-profile-menu');
                    if (authUserProfile) authUserProfile.style.display = 'flex';
                    
                    // Update user avatar with profile picture or initials
                    const userAvatarTrigger = document.getElementById('user-avatar-trigger');
                    if (userAvatarTrigger) {
                        if (user.photoURL) {
                            // If user has profile picture, show it
                            userAvatarTrigger.innerHTML = `<img src="${user.photoURL}" alt="User Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"><div class="user-status-indicator online"></div>`;
                        } else {
                            // If no profile picture, show initials
                            const initials = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                            userAvatarTrigger.innerHTML = `<span>${initials}</span><div class="user-status-indicator online"></div>`;
                        }
                    }
                    
                    console.log('✅ Main app user profile updated:', user.email);
                } else {
                    // Hide user profile
                    const authUserProfile = document.getElementById('user-profile-menu');
                    if (authUserProfile) authUserProfile.style.display = 'none';
                    
                    // Reset user avatar to guest
                    const userAvatarTrigger = document.getElementById('user-avatar-trigger');
                    if (userAvatarTrigger) {
                        userAvatarTrigger.innerHTML = '<span>GU</span><div class="user-status-indicator online"></div>';
                    }
                    
                    console.log('✅ Main app user profile cleared');
                }
            }
            
            // Listen for auth state changes from clean auth system
            document.addEventListener('DOMContentLoaded', () => {
                // Wait for clean auth system to be ready
                const checkCleanAuth = () => {
                    if (typeof window.updateUIForSignedInUser !== 'undefined') {
                        console.log('✅ Clean auth system ready in main app');
                        
                        // Override the updateUIForSignedInUser function to also update main app UI
                        const originalUpdateUI = window.updateUIForSignedInUser;
                        window.updateUIForSignedInUser = function(user) {
                            originalUpdateUI(user);
                            updateMainAppUserProfile(user);
                        };
                        
                        // Override the updateUIForSignedOutUser function
                        const originalUpdateUISignedOut = window.updateUIForSignedOutUser;
                        window.updateUIForSignedOutUser = function() {
                            originalUpdateUISignedOut();
                            updateMainAppUserProfile(null);
                        };
                        
                        // Check if user is already logged in
                        const currentUser = firebase.auth().currentUser;
                        if (currentUser) {
                            updateMainAppUserProfile(currentUser);
                        }
                    } else {
                        setTimeout(checkCleanAuth, 100);
                    }
                };
                
                checkCleanAuth();
            });
            
            // Also listen for Firebase auth state changes directly
            document.addEventListener('DOMContentLoaded', () => {
                const waitForFirebase = () => {
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        console.log('🔥 Firebase ready, setting up auth listener for main app...');
                        
                        firebase.auth().onAuthStateChanged((user) => {
                            console.log('🔍 Main app auth state changed:', user ? user.email : 'No user');
                            updateMainAppUserProfile(user);
                        });
                        
                        // Also check current user immediately
                        const currentUser = firebase.auth().currentUser;
                        if (currentUser) {
                            console.log('✅ Current user found in main app:', currentUser.email);
                            updateMainAppUserProfile(currentUser);
                        }
                    } else {
                        setTimeout(waitForFirebase, 100);
                    }
                };
                
                waitForFirebase();
            });
            
            // =================================================================
            // === 👤 USER PROFILE DROPDOWN FUNCTIONALITY
            // =================================================================
            
            // Initialize user profile dropdown functionality
            function initUserProfileDropdown() {
                const userAvatarTrigger = document.getElementById('user-avatar-trigger');
                const userProfileDropdown = document.getElementById('user-profile-dropdown');
                const userProfileMenu = document.getElementById('user-profile-menu');
                
                if (userAvatarTrigger && userProfileDropdown && userProfileMenu) {
                    // Toggle dropdown when avatar is clicked
                    userAvatarTrigger.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const isVisible = userProfileDropdown.style.display === 'block';
                        
                        if (isVisible) {
                            userProfileDropdown.style.display = 'none';
                        } else {
                            userProfileDropdown.style.display = 'block';
                        }
                        
                        console.log('👤 User profile dropdown toggled:', isVisible ? 'closed' : 'opened');
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!userAvatarTrigger.contains(e.target) && !userProfileDropdown.contains(e.target)) {
                            userProfileDropdown.style.display = 'none';
                        }
                    });
                    
                    // Close dropdown when pressing Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            userProfileDropdown.style.display = 'none';
                        }
                    });
                    
                    console.log('✅ User profile dropdown functionality initialized');
                }
            }
            
            // Initialize dropdown when DOM is loaded
            document.addEventListener('DOMContentLoaded', () => {
                initUserProfileDropdown();
                initThemeToggle();
            });
            
            // =================================================================
            // === 🌙 THEME TOGGLE FUNCTIONALITY
            // =================================================================
            
            // Initialize theme toggle functionality
            function initThemeToggle() {
                const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');
                
                if (themeToggleCheckbox) {
                    // Set initial state based on current theme
                    const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                    themeToggleCheckbox.checked = currentTheme === 'light';
                    
                    // Handle theme toggle
                    themeToggleCheckbox.addEventListener('change', (e) => {
                        const isLightTheme = e.target.checked;
                        
                        if (isLightTheme) {
                            document.body.classList.add('light-theme');
                            localStorage.setItem('theme', 'light');
                            console.log('🌞 Switched to light theme');
                        } else {
                            document.body.classList.remove('light-theme');
                            localStorage.setItem('theme', 'dark');
                            console.log('🌙 Switched to dark theme');
                        }
                    });
                    
                    console.log('✅ Theme toggle functionality initialized');
                }
            }

            // =================================================================
            // === ðŸš€ PAGE INITIALIZATION FUNCTIONS
            // =================================================================
            // AI NOTE: This section contains functions that initialize each page
            // when it's loaded. Each function:
            // - Sets up event listeners for that specific page
            // - Loads data from Firebase or local storage
            // - Initializes page-specific UI components
            // - Sets up floating action buttons (FABs) if needed

            // These functions set up each page when it's loaded
            // They initialize data, event handlers, and UI elements

            /**
             * ðŸ" Initializes the cover page functionality
             * This function sets up the main landing page with:
             * - Company information display
             * - Customer proposal details
             * - QR code generation
             * - Image management
             */
            function initCoverPage() {
                if (window.companyInfoRef) window.companyInfoRef.once('value', snap => updateCompanyInfoUI(snap.val()));
                if (window.proposalDataRef) window.proposalDataRef.once('value', snap => updateProposalDataUI(snap.val()));
                if (window.qrCodesRef) {
                    window.qrCodesRef.once('value', snap => updateQrCodesUI(snap.val()));
                } else {
                    // If no Firebase login, try to load from localStorage
                    const savedQrData = localStorage.getItem('qrCodesData');
                    if (savedQrData) {
                        try {
                            const qrData = JSON.parse(savedQrData);
                            updateQrCodesUI(qrData);
                        } catch (e) {
                            console.log('Error loading QR data from localStorage:', e);
                        }
                    }
                }
                if (window.coverImageRef) window.coverImageRef.once('value', snap => updateCoverImageUI(snap.val()));

                            // Ensure sample QR codes are visible on first load
            setTimeout(() => {
                if ($('#pdfQrcode').is(':empty') && $('#websiteQrcode').is(':empty') && $('#customQrcode').is(':empty')) {
                    // Show sample QR codes if containers are empty
                    $('#pdfQrCodeContainer, #websiteQrCodeContainer, #customQrCodeContainer').show();
                    console.log('Sample QR codes displayed on first load');
                }
            }, 100);

            // Add error handling for missing elements
            try {
                if (!$('#pdfQrCodeContainer').length || !$('#websiteQrCodeContainer').length || !$('#customQrCodeContainer').length) {
                    console.warn('Some QR code containers are missing from DOM');
                }
            } catch (error) {
                console.error('Error checking QR code containers:', error);
            }

                initAutocomplete();
            }


            /**
             * ðŸ¢ Initializes the company intro page functionality
             * This function sets up the company introduction page with:
             * - Text editing capabilities
             * - Footer editing
             * - Image cropping and management
             * - Floating action buttons (FABs)
             */
            function initCompanyIntro() {
                console.log("Company Intro Page Initializing...");

                // Initialize crop modal functionality
                initCropModal();

                // Initialize text editing functionality
                initTextEditing();

                // Initialize footer editing functionality
                initFooterEditing();

                // Immediately pin FABs with proper positioning
                const pinFABs = () => {
                    ['editTextButton','editFooterButton','openCropModalBtn'].forEach((id) => {
                        const el = document.getElementById(id);
                        if (!el) return;

                        // Force move to body to avoid zoom scaling
                        if (el.parentElement !== document.body) {
                            el.remove();
                            document.body.appendChild(el);
                        }

                        // Force position styles with !important
                        el.style.cssText = `
                            position: fixed !important;
                            right: 20px !important;
                            z-index: 9999 !important;
                            top: ${id === 'openCropModalBtn' ? '150px' : id === 'editTextButton' ? '220px' : '290px'} !important;
                        `;
                    });
                };

                if (!window.currentFirebaseUID) {
                    updateAboutUI();
                    updateFooterUI();
                    // $('#previewImage').attr('src', "https://static.wixstatic.com/media/73be98_3d4e882c397a4c30bff811ffb6646733~mv2.png");
                    pinFABs();
                    return;
                }
                const userRef = firebase.database().ref(`users/${window.currentFirebaseUID}`);
                userRef.child("page2About").once('value', snap => updateAboutUI(snap.val() || {}));
                userRef.child("footerContent").once('value', snap => updateFooterUI(snap.val() || {}));
                userRef.child("page2CoverImageUrl").once('value', snapshot => {
                    const url = snapshot.val() || "";
                    $('#previewImage').attr('src', url);
                });

                pinFABs();
            }

            // Crop Modal Functionality
            function initCropModal() {
                console.log("Initializing crop modal functionality...");

                let currentImage = null;
                let imageX = 0, imageY = 0;
                let imageScale = 1, imageRotation = 0;
                const canvas = document.getElementById('imageCanvas');
                const ctx = canvas ? canvas.getContext('2d') : null;

                if (!canvas || !ctx) {
                    console.error("Canvas not found for crop modal");
                    return;
                }

                // File upload handler
                $('#cropImageInput').on('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = new Image();
                            img.onload = function() {
                                currentImage = img;
                                resetImagePosition();
                                drawImage();
                                enableControls();
                                $('#cropStatus').text('Image loaded successfully');
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Movement controls
                $('#moveUpBtn').on('click', () => {
                    imageY -= 10;
                    drawImage();
                });

                $('#moveDownBtn').on('click', () => {
                    imageY += 10;
                    drawImage();
                });

                $('#moveLeftBtn').on('click', () => {
                    imageX -= 10;
                    drawImage();
                });

                $('#moveRightBtn').on('click', () => {
                    imageX += 10;
                    drawImage();
                });

                // Zoom controls
                $('#zoomSlider').on('input', function() {
                    imageScale = parseFloat($(this).val());
                    drawImage();
                });

                $('#zoomInBtn').on('click', () => {
                    imageScale = Math.min(imageScale + 0.1, 2);
                    $('#zoomSlider').val(imageScale);
                    drawImage();
                });

                $('#zoomOutBtn').on('click', () => {
                    imageScale = Math.max(imageScale - 0.1, 0.1);
                    $('#zoomSlider').val(imageScale);
                    drawImage();
                });

                // Rotate controls
                $('#rotateSlider').on('input', function() {
                    imageRotation = parseInt($(this).val());
                    drawImage();
                });

                $('#rotateLeftBtn').on('click', () => {
                    imageRotation = Math.max(imageRotation - 10, -180);
                    $('#rotateSlider').val(imageRotation);
                    drawImage();
                });

                $('#rotateRightBtn').on('click', () => {
                    imageRotation = Math.min(imageRotation + 10, 180);
                    $('#rotateSlider').val(imageRotation);
                    drawImage();
                });

                // Reset button
                $('#resetCropBtn').on('click', () => {
                    resetImagePosition();
                    drawImage();
                });

                // Save button
                $('#saveCropBtn').on('click', () => {
                    if (!currentImage) return;

                    // Create a new canvas for the cropped image
                    const cropCanvas = document.createElement('canvas');
                    const cropCtx = cropCanvas.getContext('2d');
                    cropCanvas.width = 650;
                    cropCanvas.height = 360;

                    // Apply transformations and draw
                    cropCtx.save();
                    cropCtx.translate(cropCanvas.width / 2, cropCanvas.height / 2);
                    cropCtx.rotate((imageRotation * Math.PI) / 180);
                    cropCtx.scale(imageScale, imageScale);
                    cropCtx.drawImage(currentImage,
                        -currentImage.width / 2 - imageX,
                        -currentImage.height / 2 - imageY);
                    cropCtx.restore();

                    // Convert to blob and save
                    cropCanvas.toBlob(function(blob) {
                        if (blob) {
                            const formData = new FormData();
                            formData.append('image', blob, 'cropped-image.png');

                            $('#cropStatus').text('Saving image...');

                            // Upload to Firebase Storage
                            if (window.currentFirebaseUID && firebase.storage) {
                                const storageRef = firebase.storage().ref();
                                const imageRef = storageRef.child(`users/${window.currentFirebaseUID}/page2CoverImage.jpg`);

                                imageRef.put(blob).then(function(snapshot) {
                                    return snapshot.ref.getDownloadURL();
                                }).then(function(downloadURL) {
                                    // Update the preview image
                                    $('#previewImage').attr('src', downloadURL);

                                    // Save URL to Firebase
                                    const userRef = firebase.database().ref(`users/${window.currentFirebaseUID}`);
                                    userRef.child('page2CoverImageUrl').set(downloadURL);

                                    $('#cropStatus').text('Image saved successfully!');
                                    $('#companyIntroCropModal').modal('hide');

                                    setTimeout(() => {
                                        $('#cropStatus').text('Upload an image to get started');
                                    }, 3000);
                                }).catch(function(error) {
                                    console.error('Error uploading image:', error);
                                    $('#cropStatus').text('Error saving image');
                                });
                            } else {
                                $('#cropStatus').text('Firebase not connected - image not saved');
                            }
                        }
                    }, 'image/jpeg', 0.9);
                });

                // Helper functions
                function resetImagePosition() {
                    imageX = 0;
                    imageY = 0;
                    imageScale = 1;
                    imageRotation = 0;
                    $('#zoomSlider').val(1);
                    $('#rotateSlider').val(0);
                }

                function drawImage() {
                    if (!currentImage) return;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate((imageRotation * Math.PI) / 180);
                    ctx.scale(imageScale, imageScale);
                    ctx.drawImage(currentImage,
                        -currentImage.width / 2 + imageX,
                        -currentImage.height / 2 + imageY);
                    ctx.restore();
                }

                function enableControls() {
                    $('.control-btn, .control-slider').prop('disabled', false);
                    $('#resetCropBtn, #saveCropBtn').prop('disabled', false);
                }
            }

            // Text Editing Functionality
            function initTextEditing() {
                console.log("Initializing text editing functionality...");

                // Load current text content when modal opens
                $('#editTextModal').on('show.bs.modal', function() {
                    loadCurrentTextContent();
                    // Reset to first step when modal opens
                    showStep(1);
                });



                // Save button functionality
                $('#saveTextBtn').on('click', function() {
                    saveTextContent();
                });

                // Step navigation functionality
                $('#nextTextStepBtn').on('click', function() {
                    const currentStep = getCurrentStep();
                    if (currentStep < 3) {
                        showStep(currentStep + 1);
                    }
                });

                $('#prevTextStepBtn').on('click', function() {
                    const currentStep = getCurrentStep();
                    if (currentStep > 1) {
                        showStep(currentStep - 1);
                    }
                });
            }

            // Step navigation functions
            function getCurrentStep() {
                return parseInt($('.form-step.active').data('step'));
            }

            function showStep(stepNumber) {
                // Hide all steps
                $('.form-step').removeClass('active');
                $('.step').removeClass('active completed');

                // Show current step
                $(`.form-step[data-step="${stepNumber}"]`).addClass('active');
                $(`.step[data-step="${stepNumber}"]`).addClass('active');

                // Mark previous steps as completed
                for (let i = 1; i < stepNumber; i++) {
                    $(`.step[data-step="${i}"]`).addClass('completed');
                }

                // Update button visibility
                updateStepButtons(stepNumber);
            }

            function updateStepButtons(stepNumber) {
                if (stepNumber === 1) {
                    $('#prevTextStepBtn').hide();
                    $('#nextTextStepBtn').show();
                    $('#saveTextBtn').hide();
                } else if (stepNumber === 3) {
                    $('#prevTextStepBtn').show();
                    $('#nextTextStepBtn').hide();
                    $('#saveTextBtn').show();
                } else {
                    $('#prevTextStepBtn').show();
                    $('#nextTextStepBtn').show();
                    $('#saveTextBtn').hide();
                }
            }

            // Load current text content from Firebase and UI
            function loadCurrentTextContent() {
                // Get current values from the page
                const paragraph1 = $('#aboutSection p').eq(0).text() || "Denali Tech specializes in advanced audio and home automation solutions.";
                const paragraph2 = $('#aboutSection p').eq(1).text() || "We take a consultative approach to understand your unique needs and preferences.";
                const paragraph3 = $('#aboutSection p').eq(2).text() || "With our comprehensive services, we handle everything from initial consultation to final installation.";
                const paragraph4 = $('#aboutSection p').eq(3).text() || "Whether you are looking to install a simple sound system or a complex smart home setup, we have the expertise.";
                const proposalIntro = $('#aboutSection p').eq(4).text() || "";

                // Set values in the modal inputs
                $('#paragraph1Input').val(paragraph1);
                $('#paragraph2Input').val(paragraph2);
                $('#paragraph3Input').val(paragraph3);
                $('#paragraph4Input').val(paragraph4);
                $('#proposalIntroInput').val(proposalIntro);
            }

            // Reset text content to default values
            function resetTextContent() {
                const defaultContent = {
                    paragraph1: "Denali Tech specializes in advanced audio and home automation solutions.",
                    paragraph2: "We take a consultative approach to understand your unique needs and preferences.",
                    paragraph3: "With our comprehensive services, we handle everything from initial consultation to final installation.",
                    paragraph4: "Whether you are looking to install a simple sound system or a complex smart home setup, we have the expertise.",
                    proposalIntro: ""
                };

                $('#paragraph1Input').val(defaultContent.paragraph1);
                $('#paragraph2Input').val(defaultContent.paragraph2);
                $('#paragraph3Input').val(defaultContent.paragraph3);
                $('#paragraph4Input').val(defaultContent.paragraph4);
                $('#proposalIntroInput').val(defaultContent.proposalIntro);
            }

            // Save text content to Firebase and update UI
            function saveTextContent() {
                const newContent = {
                    paragraph1: $('#paragraph1Input').val().trim(),
                    paragraph2: $('#paragraph2Input').val().trim(),
                    paragraph3: $('#paragraph3Input').val().trim(),
                    paragraph4: $('#paragraph4Input').val().trim(),
                    proposalIntro: $('#proposalIntroInput').val().trim()
                };

                // Update the UI immediately
                updateAboutUI(newContent);

                // Save to Firebase if connected
                if (window.currentFirebaseUID && firebase.database) {
                    const userRef = firebase.database().ref(`users/${window.currentFirebaseUID}`);
                    userRef.child('page2About').set(newContent).then(() => {
                        console.log('Text content saved to Firebase');
                        $('#editTextModal').modal('hide');
                        // Show success message
                        showNotification('Text content saved successfully!', 'success');
                    }).catch((error) => {
                        console.error('Error saving text content:', error);
                        showNotification('Error saving text content', 'error');
                    });
                } else {
                    console.log('Firebase not connected - text changes applied locally only');
                    $('#editTextModal').modal('hide');
                    showNotification('Text changes applied locally (not saved to cloud)', 'warning');
                }
            }

            // Footer Editing Functionality
            function initFooterEditing() {
                console.log("Initializing footer editing functionality...");

                // Load current footer content when modal opens
                $('#editFooterModal').on('show.bs.modal', function() {
                    loadCurrentFooterContent();
                });

                // Reset button functionality
                $('#resetFooterBtn').on('click', function() {
                    resetFooterContent();
                });

                // Save button functionality
                $('#saveFooterBtn').on('click', function() {
                    saveFooterContent();
                });
            }

            // Load current footer content from UI
            function loadCurrentFooterContent() {
                // Get current values from the footer
                const footerParagraphs = $('#footerContent p');
                const line1 = footerParagraphs.length >= 1 ? footerParagraphs.eq(0).text() : "Denali Tech - Home Automation & Custom AV Solutions";
                const line2 = footerParagraphs.length >= 2 ? footerParagraphs.eq(1).text() : "1234 Main Street, Anytown, USA";
                const line3 = footerParagraphs.length >= 3 ? footerParagraphs.eq(2).text() : "Phone: (603) 387-0129 | www.denalitechstest.com";

                // Set values in the modal inputs
                $('#footerLine1Input').val(line1);
                $('#footerLine2Input').val(line2);
                $('#footerLine3Input').val(line3);
            }

            // Reset footer content to default values
            function resetFooterContent() {
                const defaultContent = {
                    line1: "Denali Tech - Home Automation & Custom AV Solutions",
                    line2: "1234 Main Street, Anytown, USA",
                    line3: "Phone: (603) 387-0129 | www.denalitechstest.com"
                };

                $('#footerLine1Input').val(defaultContent.line1);
                $('#footerLine2Input').val(defaultContent.line2);
                $('#footerLine3Input').val(defaultContent.line3);
            }

            // Save footer content to Firebase and update UI
            function saveFooterContent() {
                const newContent = {
                    line1: $('#footerLine1Input').val().trim(),
                    line2: $('#footerLine2Input').val().trim(),
                    line3: $('#footerLine3Input').val().trim()
                };

                // Update the UI immediately
                updateFooterUI(newContent);

                // Save to Firebase if connected
                if (window.currentFirebaseUID && firebase.database) {
                    const userRef = firebase.database().ref(`users/${window.currentFirebaseUID}`);
                    userRef.child('footerContent').set(newContent).then(() => {
                        console.log('Footer content saved to Firebase');
                        $('#editFooterModal').modal('hide');
                        // Show success message
                        showNotification('Footer content saved successfully!', 'success');
                    }).catch((error) => {
                        console.error('Error saving footer content:', error);
                        showNotification('Error saving footer content', 'error');
                    });
                } else {
                    console.log('Firebase not connected - footer changes applied locally only');
                    $('#editFooterModal').modal('hide');
                    showNotification('Footer changes applied locally (not saved to cloud)', 'warning');
                }
            }

            // =================================================================
            // === ðŸ›"ï¸ UTILITY & HELPER FUNCTIONS
            // =================================================================
            // These functions provide common utilities used throughout the application
            // They handle formatting, validation, and other helper tasks

            /**
             * ðŸ"… Formats a date object to MM/DD/YYYY format
             * This function is made global so it can be used in modal dialogs
             * @param {Date} date - Date object to format
             * @returns {string} Formatted date string in MM/DD/YYYY format
             */
            window.formatDate = function(date) {
                if (isNaN(date.getTime())) return "";
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
            };

            function initAutocomplete() {
                console.log('Initializing Google Places Autocomplete...');

                // Check if Google Maps API is loaded
                if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                    console.log('Google Maps API not loaded yet, retrying in 1 second...');
                    setTimeout(initAutocomplete, 1000);
                    return;
                }

                // Initialize autocomplete for customer address
                const customerInput = document.getElementById('customerAddressInput');
                if (customerInput && !$(customerInput).data('autocomplete-initialized')) {
                    try {
                        console.log('Creating Google Places Autocomplete for customer address...');
                        const customerAutocomplete = new google.maps.places.Autocomplete(customerInput, {
                            types: ['address'],
                            componentRestrictions: { country: 'us' }
                        });

                        customerAutocomplete.addListener('place_changed', function() {
                            const place = customerAutocomplete.getPlace();
                            console.log('Customer place selected:', place);

                            if (place.geometry) {
                                console.log('Customer place coordinates:', place.geometry.location.lat(), place.geometry.location.lng());
                            }
                        });

                        $(customerInput).data('autocomplete-initialized', true);
                        console.log('Customer address autocomplete initialized successfully');
                    } catch (error) {
                        console.error('Error initializing customer address autocomplete:', error);
                    }
                }

                // Initialize autocomplete for company address
                const companyInput = document.getElementById('companyAddress');
                if (companyInput && !$(companyInput).data('autocomplete-initialized')) {
                    try {
                        console.log('Creating Google Places Autocomplete for company address...');
                        const companyAutocomplete = new google.maps.places.Autocomplete(companyInput, {
                            types: ['address'],
                            componentRestrictions: { country: 'us' }
                        });

                        companyAutocomplete.addListener('place_changed', function() {
                            const place = companyAutocomplete.getPlace();
                            console.log('Company place selected:', place);

                            if (place.geometry) {
                                console.log('Company place coordinates:', place.geometry.location.lat(), place.geometry.location.lng());
                            }
                        });

                        $(companyInput).data('autocomplete-initialized', true);
                        console.log('Company address autocomplete initialized successfully');
                    } catch (error) {
                        console.error('Error initializing company address autocomplete:', error);
                    }
                }

                console.log('Google Places Autocomplete initialization completed');
            }

            // Corner Style Switcher Function
            function initCornerStyleSwitcher() {
                // Load saved corner style from localStorage
                const savedCornerStyle = localStorage.getItem('propokitCornerStyle') || 'sharp';
                applyCornerStyle(savedCornerStyle);

                // Add click handlers for corner style options
                $(document).on('click', '.corner-style-option', function() {
                    const theme = $(this).data('theme');
                    applyCornerStyle(theme);
                    localStorage.setItem('propokitCornerStyle', theme);

                    // Update button icon to show current style
                    updateCornerStyleButton(theme);
                });

                // Initialize button icon
                updateCornerStyleButton(savedCornerStyle);
            }

            function applyCornerStyle(theme) {
                // Remove all existing theme classes
                $('body').removeClass('theme-sharp theme-curvy theme-hybrid');

                // Add new theme class
                $('body').addClass(`theme-${theme}`);

                console.log(`Corner style changed to: ${theme}`);
            }

            function updateCornerStyleButton(theme) {
                const iconMap = {
                    'sharp': 'fas fa-square',
                    'curvy': 'fas fa-circle',
                    'hybrid': 'fas fa-puzzle-piece'
                };

                $('#corner-style-btn i').removeClass().addClass(iconMap[theme]);
                $('#corner-style-btn').attr('title', `Current: ${theme.charAt(0).toUpperCase() + theme.slice(1)} - Click to change`);
            }

            // ðŸš€ Unified PropoKit Style Menu System
            function initColorThemeSystem() {
                // Load saved settings from localStorage
                const savedTheme = localStorage.getItem('propokitColorTheme') || 'ocean-blue';
                const savedCornerStyle = localStorage.getItem('propokitCornerStyle') || 'sharp';
                const savedColorStyle = localStorage.getItem('propokitColorStyle') || 'solid';

                // Apply saved settings
                applyColorTheme(savedTheme, savedColorStyle);
                applyCornerStyle(savedCornerStyle);

                // Update UI to reflect current settings
                updateStyleMenuUI(savedCornerStyle, savedTheme);

                // Set initial toggle state
                $('.toggle-btn').removeClass('active');
                $(`.toggle-btn[data-style="${savedColorStyle}"]`).addClass('active');

                // Show correct theme grid
                $('.theme-grid').removeClass('active');
                if (savedColorStyle === 'solid') {
                    $('.solid-themes').addClass('active');
                } else {
                    $('.rainbow-themes').addClass('active');
                }

                // Add click handlers for corner style options
                $(document).on('click', '.style-option', function() {
                    const style = $(this).data('style');
                    applyCornerStyle(style);
                    localStorage.setItem('propokitCornerStyle', style);

                    // Update active state
                    $('.style-option').removeClass('active');
                    $(this).addClass('active');

                    // Update UI
                    updateStyleMenuUI(style, savedTheme);
                    updateCornerStyleButton(style);

                    showNotification(`ðŸ"² Applied ${style} corner style!`, 'success');
                });

                // Add click handlers for theme options
                $(document).on('click', '.theme-option', function() {
                    const theme = $(this).data('theme');
                    const style = $(this).data('style');
                    applyColorTheme(theme, style);
                    localStorage.setItem('propokitColorTheme', theme);
                    localStorage.setItem('propokitColorStyle', style);

                    // Update active state
                    $('.theme-option').removeClass('active');
                    $(this).addClass('active');

                    // Update UI
                    updateStyleMenuUI(savedCornerStyle, theme);

                    showNotification(`ðŸŽ¨ Applied ${theme.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} ${style} theme!`, 'success');
                });

                // Add click handlers for color style toggle
                $(document).on('click', '.toggle-btn', function() {
                    const style = $(this).data('style');

                    // Update toggle button states
                    $('.toggle-btn').removeClass('active');
                    $(this).addClass('active');

                    // Show/hide theme grids
                    $('.theme-grid').removeClass('active');
                    if (style === 'solid') {
                        $('.solid-themes').addClass('active');
                    } else {
                        $('.rainbow-themes').addClass('active');
                    }

                    // Apply current theme with new style
                    const currentTheme = localStorage.getItem('propokitColorTheme') || 'ocean-blue';
                    applyColorTheme(currentTheme, style);
                    localStorage.setItem('propokitColorStyle', style);

                    showNotification(`ðŸŒˆ Switched to ${style} color style!`, 'info');
                });

                // Toggle menu on button click and close other menus
                $('#propokit-menu-btn').on('click', function(e) {
                    e.stopPropagation();

                    // Close profile dropdown if open
                    $('#user-profile-menu').removeClass('open');

                    // Toggle style menu
                    $('.propokit-style-menu').toggleClass('show');
                });

                // Close PropoKit style menu when profile menu is opened and toggle profile menu
                $(document).on('click', '#user-avatar-trigger', function(e) {
                    e.stopPropagation();
                    console.log('User avatar clicked!'); // Debug log
                    $('.propokit-style-menu').removeClass('show');
                    $('#user-profile-menu').toggleClass('open');
                });

                // Close menus when clicking outside
                $(document).on('click', function(e) {
                    if (!$(e.target).closest('.propokit-menu-controls').length) {
                        $('.propokit-style-menu').removeClass('show');
                    }
                    if (!$(e.target).closest('#user-profile-menu').length) {
                        $('#user-profile-menu').removeClass('open');
                    }
                });



                // Set initial active states
                $(`.style-option[data-style="${savedCornerStyle}"]`).addClass('active');
                $(`.theme-option[data-theme="${savedTheme}"]`).addClass('active');

                // Sync menu with theme toggle
                $('#theme-toggle-checkbox').on('change', function() {
                    const isDark = $(this).is(':checked');
                    if (isDark) {
                        $('body').addClass('dark-theme');
                    } else {
                        $('body').removeClass('dark-theme');
                    }
                });

                // Check initial theme state
                if ($('#theme-toggle-checkbox').is(':checked')) {
                    $('body').addClass('dark-theme');
                }
            }

            function applyColorTheme(theme, style = 'solid') {
                // Remove all existing theme classes and styles
                $('body').removeClass('theme-ocean-blue theme-forest-green theme-royal-purple theme-midnight-blue theme-rose-gold theme-coral-reef rainbow-style mixed-style');

                // Add new theme class
                $('body').addClass(`theme-${theme}`);

                // Add style class if rainbow or mixed
                if (style === 'rainbow') {
                    $('body').addClass('rainbow-style');
                } else if (style === 'mixed') {
                    $('body').addClass('mixed-style');
                }

                console.log(`Color theme changed to: ${theme} with ${style} style`);
            }

            function updateStyleMenuUI(cornerStyle, colorTheme) {
                // Update current settings display
                $('#current-corner-style').text(cornerStyle.charAt(0).toUpperCase() + cornerStyle.slice(1));
                $('#current-color-theme').text(colorTheme.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()));
            }



            function showNotification(message, type = 'info') {
                const notification = $(`
                    <div class="notification notification-${type}">
                        ${message}
                        <button class="notification-close">&times;</button>
                    </div>
                `);

                $('body').append(notification);

                // Auto-hide after 3 seconds
                setTimeout(() => {
                    notification.fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 3000);

                // Close button
                notification.find('.notification-close').on('click', function() {
                    notification.fadeOut(300, function() {
                        $(this).remove();
                    });
                });
            }

            // *** NEW FUNCTION ***
            // This function's only job is to draw the QR codes on the main page
            function generatePageQRCodes(data = {}) {
                console.log('Generating QR codes with data:', data);

                // Clear all existing QR code containers and hide them
                $('#pdfQrcode, #websiteQrcode, #customQrcode').empty();
                $('#websiteQrCodeContainer, #pdfQrCodeContainer, #customQrCodeContainer').hide();

                // Hide placeholder when generating real QR codes
                $('#qrCodePlaceholder').hide();

                // Add a small delay to ensure DOM is ready before generating new QR codes
                setTimeout(() => {

                // *** CRITICAL FIX ***
                // The decision to show a QR code is now based on the data from Firebase
                if (data.showWebsiteQr && data.websiteUrl) {
                    try {
                        console.log('Creating website QR code for:', data.websiteUrl);
                        const websiteElement = document.getElementById('websiteQrcode');
                        if (!websiteElement) {
                            console.error('Website QR code element not found');
                            return;
                        }

                        // Clear any existing content
                        websiteElement.innerHTML = '';

                        // Check which QRCode library is available and use the correct API
                        if (QRCode.prototype && typeof QRCode.prototype.makeCode === 'function') {
                            new QRCode(websiteElement, {
                                width: 90,
                                height: 90,
                                colorDark: '#000000',
                                colorLight: '#ffffff'
                            }).makeCode(data.websiteUrl);
                        } else {
                            // Fallback to qrcode-generator library
                            const qr = qrcode(0, 'M');
                            qr.addData(data.websiteUrl);
                            qr.make();
                            websiteElement.innerHTML = qr.createImgTag(4, 4);
                        }

                        $('#websiteQrCodeContainer').show();
                        console.log('Website QR code created successfully');
                    } catch (error) {
                        console.error('Error creating website QR code:', error);
                        // Show fallback or error message
                        const websiteElement = document.getElementById('websiteQrcode');
                        if (websiteElement) {
                            websiteElement.innerHTML = '<div class="qr-error">QR Code Error</div>';
                        }
                    }
                }

                if (data.showPdfQr && data.pdfUrl) {
                    try {
                        console.log('Creating PDF QR code for:', data.pdfUrl);
                        const pdfElement = document.getElementById('pdfQrcode');
                        if (!pdfElement) {
                            console.error('PDF QR code element not found');
                            return;
                        }

                        // Clear any existing content
                        pdfElement.innerHTML = '';

                        // Check which QRCode library is available and use the correct API
                        if (QRCode.prototype && typeof QRCode.prototype.makeCode === 'function') {
                            new QRCode(pdfElement, {
                                width: 90,
                                height: 90,
                                colorDark: '#000000',
                                colorLight: '#ffffff'
                            }).makeCode(data.pdfUrl);
                        } else {
                            // Fallback to qrcode-generator library
                            const qr = qrcode(0, 'M');
                            qr.addData(data.pdfUrl);
                            qr.make();
                            pdfElement.innerHTML = qr.createImgTag(4, 4);
                        }

                        $('#pdfQrCodeContainer').show();
                        console.log('PDF QR code created successfully');
                    } catch (error) {
                        console.error('Error creating PDF QR code:', error);
                        // Show fallback or error message
                        const pdfElement = document.getElementById('pdfQrcode');
                        if (pdfElement) {
                            pdfElement.innerHTML = '<div class="qr-error">QR Code Error</div>';
                        }
                    }
                }

                if (data.showCustomQr && data.customUrl) {
                    try {
                        console.log('Creating custom QR code for:', data.customUrl);
                        const customElement = document.getElementById('customQrcode');
                        if (!customElement) {
                            console.error('Custom QR code element not found');
                            return;
                        }

                        // Clear any existing content
                        customElement.innerHTML = '';

                        // Check which QRCode library is available and use the correct API
                        if (QRCode.prototype && typeof QRCode.prototype.makeCode === 'function') {
                            new QRCode(customElement, {
                                width: 90,
                                height: 90,
                                colorDark: '#000000',
                                colorLight: '#ffffff'
                            }).makeCode(data.customUrl);
                        } else {
                            // Fallback to qrcode-generator library
                            const qr = qrcode(0, 'M');
                            qr.addData(data.customUrl);
                            qr.make();
                            customElement.innerHTML = qr.createImgTag(4, 4);
                        }

                        // Update the label for the custom QR code
                        const customLabel = data.customLabel || 'Custom Link';
                        $('#customQrMessage').text(customLabel);

                        $('#customQrCodeContainer').show();
                        console.log('Custom QR code created successfully with label:', customLabel);
                    } catch (error) {
                        console.error('Error creating custom QR code:', error);
                        // Show fallback or error message
                        const customElement = document.getElementById('customQrcode');
                        if (customElement) {
                            customElement.innerHTML = '<div class="qr-error">QR Code Error</div>';
                        }
                    }
                }

                // Show/hide placeholder based on whether any QR codes are visible
                const hasVisibleQrCodes = $('#websiteQrCodeContainer:visible, #pdfQrCodeContainer:visible, #customQrCodeContainer:visible').length > 0;
                if (hasVisibleQrCodes) {
                    $('#qrCodePlaceholder').hide();
                } else {
                    $('#qrCodePlaceholder').show();
                }

                }, 100); // Close the setTimeout
            }
// ****** [F-019] ****** Global Crop Variables Initialization ****************
   // =================================================================
// === IMAGE MODAL LOGIC (ALL IN ONE PLACE) - HIGH RESOLUTION VERSION
// =================================================================
function initAllImageModalFeatures() {
    // ****** Global Crop Variables Initialization ****************
    let combinedSelectedImageUrl = null;
    let combinedCanvas, combinedCtx;
    let combinedCurrentImage = null;
    let combinedIsImageLoaded = false;
    let imageX = 0, imageY = 0, zoomLevel = 1, rotation = 0;
    let isDragging = false, lastMouseX = 0, lastMouseY = 0;
    let cachedImageList = null, isInitialLoad = true;
    let currentImageToDelete = null, currentImageToRename = null;

    // ****** Debounce Function ***********************************
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // ****** Compress Image **************************************
    function compressImage(file, options) {
        return new Promise((resolve, reject) => {
            const maxSizeBytes = options.maxSizeMB * 1024 * 1024;
            const reader = new FileReader();
            $('#progressBar').css('width', '0%').parent().show();
            $('#progressText').text('Preparing image...');
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width, height = img.height, quality = options.quality;
                    if (width > options.maxWidth) {
                        height = (options.maxWidth / width) * height;
                        width = options.maxWidth;
                    }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob( (blob) => {
                            const compressedFile = new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                            $('#progressBar').css('width', '100%');
                            $('#progressText').text('Image ready!');
                            setTimeout(() => $('#progressContainer').hide(), 500);
                            resolve(compressedFile);
                        }, 'image/jpeg', quality);
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // ****** Combined Image Modal Show Handler *******************
    $('#combinedImageModal').on('shown.bs.modal', function () {
        if (isInitialLoad || !cachedImageList) {
            loadCombinedImageList();
            isInitialLoad = false;
        } else {
            renderCachedImageList();
        }

        // Auto-load current cover page image if available
        const currentCoverImage = $('#customImage').attr('src');
        const image1 = $('#image1').attr('src');
        const image2 = $('#image2').attr('src');

        // Check which image is currently visible and load it
        let imageToLoad = null;
        if (currentCoverImage && currentCoverImage !== '' && $('#customImage').is(':visible')) {
            imageToLoad = currentCoverImage;
        } else if (image1 && $('#image1').is(':visible')) {
            imageToLoad = image1;
        } else if (image2 && $('#image2').is(':visible')) {
            imageToLoad = image2;
        }

        if (imageToLoad) {
            loadImageIntoCanvas(imageToLoad);
        } else if (!combinedIsImageLoaded) {
            disableCropControls();
            $('#cropStatusText').text('Pick an image or upload a new one.').addClass('text-muted');
            $('#cropLoadingSpinner').hide();
        } else {
            drawCanvasImage();
        }
    });

    // ****** Load Combined Image List ****************************
    function loadCombinedImageList() {
        const $list = $('#combinedImageList');
        const $status = $('#combinedImageListStatus');
        $list.empty();
        $status.html('Getting your images... <span class="loading-spinner"></span>').removeClass('text-danger text-success').addClass('text-muted');
        const defaultImages = [
            // { name: 'Default 1', url: 'https://static.wixstatic.com/media/d31297_87b0f69623904649a3c8c94dc048f57d~mv2.jpg', isDefault: true },
            // { name: 'Default 2', url: 'https://static.wixstatic.com/media/73be98_8e08babbc35f421bb3ea3111f7d2e6b2~mv2.webp', isDefault: true },
        ];
        cachedImageList = [...defaultImages];
        // defaultImages.forEach((img) => $list.append(createGalleryItem(img.url, img.name, true)));
        if (!currentFirebaseUID) {
            $status.text('Log in to see your personal images.').addClass('text-muted');
            return;
        }
        const storageRef = firebase.storage().ref(`users/${window.currentFirebaseUID}`);
        storageRef.listAll()
            .then(result => Promise.all(result.items.map(itemRef => itemRef.getDownloadURL().then(url => ({ name: itemRef.name, url, isDefault: false })))))
            .then(images => {
                images.forEach(img => {
                    $list.append(createGalleryItem(img.url, img.name, false));
                    cachedImageList.push(img);
                });
                $status.text('Choose an image or upload a new one.').addClass('text-success');
            })
            .catch(err => {
                console.error('Error loading images:', err);
                $status.html('Oops, something went wrong. <button id="retryLoad" class="btn btn-link btn-sm">Try Again</button>').addClass('text-danger');
                $('#retryLoad').on('click', loadCombinedImageList);
            });
    }

    // ****** Render Cached Image List ****************************
    function renderCachedImageList() {
        const $list = $('#combinedImageList');
        $list.empty();
        if (!cachedImageList || cachedImageList.length === 0) return;
        cachedImageList.forEach((img) => $list.append(createGalleryItem(img.url, img.name, img.isDefault)));
        $('#combinedImageListStatus').text('Choose an image or upload a new one.').addClass('text-success');
    }

    // ****** Create Gallery Item *********************************
    function createGalleryItem(imgUrl, displayName, isDefault) {
        const $container = $('<div class="gallery-item">');
        const $img = $(`<img src="${imgUrl}" alt="${displayName}" />`);
        const $name = $(`<div class="gallery-name">${displayName}</div>`);
        const $btnGroup = $(`<div class="action-buttons">${!isDefault ? `<button class="btn-action btn-rename" title="Rename"><i class="fas fa-pencil-alt"></i></button><button class="btn-action btn-delete" title="Delete"><i class="fas fa-trash"></i></button>` : ''}</div>`);
        $container.append($img, $name, $btnGroup);
        $container.on('click', function (e) {
            if ($(e.target).closest('.btn-action').length) return;
            $('#combinedImageList .gallery-item').removeClass('selected');
            $(this).addClass('selected');
            loadImageIntoCanvas(imgUrl);
        });
        if (!isDefault) {
            $container.find('.btn-delete').click(() => { currentImageToDelete = { $container, imgUrl }; $('#deleteModal').modal('show'); });
            $container.find('.btn-rename').click(() => { currentImageToRename = { $container, $name, imgUrl, displayName }; $('#newNameInput').val(displayName); $('#renameModal').modal('show'); });
        }
        return $container;
    }

    // ****** Modal Action Handlers *********************
    $('#confirmDelete').click(async function () {
        const storageRef = firebase.storage().refFromURL(currentImageToDelete.imgUrl);
        await storageRef.delete();
        currentImageToDelete.$container.remove();
        cachedImageList = cachedImageList.filter((img) => img.url !== currentImageToDelete.imgUrl);
        if (combinedSelectedImageUrl === currentImageToDelete.imgUrl) resetCrop();
        $('#deleteModal').modal('hide');
    });
    $('#confirmRename').click(async function () {
        const newName = $('#newNameInput').val().trim();
        if (!newName || newName === currentImageToRename.displayName) { $('#renameModal').modal('hide'); return; }
        const storageRef = firebase.storage().refFromURL(currentImageToRename.imgUrl);
        await storageRef.updateMetadata({ customMetadata: { displayName: newName } });
        currentImageToRename.$name.text(newName);
        const imgIndex = cachedImageList.findIndex((img) => img.url === currentImageToRename.imgUrl);
        if (imgIndex !== -1) cachedImageList[imgIndex].name = newName;
        $('#renameModal').modal('hide');
    });

    // ****** Search Image List Handler ***************************
    $('#combinedImageSearchInput').on('input', debounce(function () {
        const term = $(this).val().toLowerCase();
        $('#combinedImageList .gallery-item').each(function () {
            $(this).toggle($(this).find('.gallery-name').text().toLowerCase().includes(term));
        });
    }, 300));

    // ****** Upload Image Handler ********************************
    $('#combinedUploadInput').on('change', function (e) {
        const file = e.target.files[0];
        if (!file || !currentFirebaseUID) return;
        const $status = $('#combinedImageListStatus');
        $status.text('Preparing image...').addClass('text-muted');
        compressImage(file, { maxSizeMB: 2, maxWidth: 1920, quality: 0.9 })
            .then(compressedFile => {
                const newRef = firebase.storage().ref(`users/${window.currentFirebaseUID}/${file.name}`);
                const uploadTask = newRef.put(compressedFile);
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        $('#progressBar').css('width', `${progress}%`);
                        $('#progressText').text(`Uploading: ${Math.round(progress)}%`);
                    },
                    (err) => { console.error('Upload error:', err); $status.text('Upload failed.').addClass('text-danger'); },
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                            $status.text('Image added!').addClass('text-success');
                            const newImage = { name: file.name, url, isDefault: false };
                            cachedImageList.push(newImage);
                            $('#combinedImageList').append(createGalleryItem(url, file.name, false));
                            loadImageIntoCanvas(url);
                        });
                    }
                );
            });
    });

// ****** [F-031] ****** Crop Canvas Initialization and Handlers *************
// TL;DR: Sets up canvas and crop controls for image editing!
// Hey! This handler:
// 1. Initializes canvas and context
// 2. Adds mouse and button handlers for crop adjustments
// 3. Manages zoom, rotation, reset, and save actions
// 4. Includes keyboard shortcuts for adjustments
// Where? Runs on document ready!
// Pro Tip: Search [F-031] to jump here fast! Enables Cover Page image cropping!
// ****************************************************************************
$(document).ready(function () {
  // Initialize Google Places Autocomplete
  initAutocomplete();

  // Initialize Corner Style Switcher
  initCornerStyleSwitcher();

              // Initialize Color Theme System
            initColorThemeSystem();

  combinedCanvas = document.getElementById('combinedCanvas');
  combinedCtx = combinedCanvas.getContext('2d');

  $(combinedCanvas).on('mousedown', function (e) {
    if (!combinedIsImageLoaded) return;
    isDragging = true;
    const rect = combinedCanvas.getBoundingClientRect();
    lastMouseX = e.clientX - rect.left;
    lastMouseY = e.clientY - rect.top;
  });
  $(combinedCanvas).on('mousemove', function (e) {
    if (!isDragging) return;
    const rect = combinedCanvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const dx = (mouseX - lastMouseX) / zoomLevel;
    const dy = (mouseY - lastMouseY) / zoomLevel;
    imageX += dx;
    imageY += dy;
    lastMouseX = mouseX;
    lastMouseY = mouseY;
    drawCanvasImage();
  });
  $(combinedCanvas).on('mouseup mouseleave', function () {
    isDragging = false;
  });

  $('#combinedMoveUpBtn').on('click', () => {
    imageY -= 10 / zoomLevel;
    drawCanvasImage();
  });
  $('#combinedMoveDownBtn').on('click', () => {
    imageY += 10 / zoomLevel;
    drawCanvasImage();
  });
  $('#combinedMoveLeftBtn').on('click', () => {
    imageX -= 10 / zoomLevel;
    drawCanvasImage();
  });
  $('#combinedMoveRightBtn').on('click', () => {
    imageX += 10 / zoomLevel;
    drawCanvasImage();
  });

  $('#combinedZoomSlider').on('input', function () {
    zoomLevel = parseFloat($(this).val());
    drawCanvasImage();
  });
  $('#combinedZoomInBtn').on('click', function () {
    zoomLevel = Math.min(2, zoomLevel + 0.02);
    $('#combinedZoomSlider').val(zoomLevel);
    drawCanvasImage();
  });
  $('#combinedZoomOutBtn').on('click', function () {
    zoomLevel = Math.max(0.1, zoomLevel - 0.02);
    $('#combinedZoomSlider').val(zoomLevel);
    drawCanvasImage();
  });

  $('#combinedRotateSlider').on('input', function () {
    rotation = parseInt($(this).val());
    drawCanvasImage();
  });
  $('#combinedRotateLeftBtn').on('click', function () {
    rotation = Math.max(-180, rotation - 2);
    $('#combinedRotateSlider').val(rotation);
    drawCanvasImage();
  });
  $('#combinedRotateRightBtn').on('click', function () {
    rotation = Math.min(180, rotation + 2);
    $('#combinedRotateSlider').val(rotation);
    drawCanvasImage();
  });

  $('#combinedResetBtn').on('click', function () {
    resetCrop();
    $('#cropStatusText').text('Image reset. Adjust it as you like!').addClass('text-muted');
    $('#cropLoadingSpinner').hide();
  });

  $('#combinedSetCoverBtn').on('click', function () {
    if (!combinedCurrentImage) {
      $('#cropStatusText').text('Please choose an image first.').addClass('text-danger');
      $('#cropLoadingSpinner').hide();
      return;
    }
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = 700;
    tmpCanvas.height = 450;
    const tmpCtx = tmpCanvas.getContext('2d');

    // Fill canvas with white background first
    tmpCtx.fillStyle = 'white';
    tmpCtx.fillRect(0, 0, tmpCanvas.width, tmpCanvas.height);

    tmpCtx.save();
    tmpCtx.translate(tmpCanvas.width / 2, tmpCanvas.height / 2);
    tmpCtx.rotate((rotation * Math.PI) / 180);

    // Use the same scale as displayed in the modal canvas
    tmpCtx.scale(zoomLevel, zoomLevel);
    const w = combinedCurrentImage.width;
    const h = combinedCurrentImage.height;
    tmpCtx.drawImage(combinedCurrentImage, imageX - w / 2, imageY - h / 2, w, h);
    tmpCtx.restore();

    const dataUrl = tmpCanvas.toDataURL('image/jpeg', 0.9);
    $('#customImage').attr('src', dataUrl).css('display', 'block');
    $('#image1').css('display', 'none');
    $('#image2').css('display', 'none');
    customImageSet = true;
    displayMode = 'custom';

    if (currentFirebaseUID) {
      $('#cropStatusText').text('Saving your cover image...');
      $('#cropLoadingSpinner').show();
      firebase
        .database()
        .ref(`users/${window.currentFirebaseUID}/coverImageUrl`)
        .set(dataUrl)
        .then(() => {
          cachedCoverImageUrl = dataUrl;
          sessionStorage.setItem("cachedCoverImageUrl", dataUrl);
          $('#cropStatusText')
            .text('Your cover image is set!')
            .addClass('text-success');
          $('#cropLoadingSpinner').hide();
          setTimeout(() => $('#combinedImageModal').modal('hide'), 1000);
        })
        .catch((err) => {
          $('#cropStatusText')
            .text("Sorry, we couldn't save your cover image.")
            .addClass('text-danger');
          $('#cropLoadingSpinner').hide();
        });
    } else {
      cachedCoverImageUrl = dataUrl;
      sessionStorage.setItem("cachedCoverImageUrl", dataUrl);
      $('#cropStatusText').text('Your cover image is set!').addClass('text-success');
      $('#cropLoadingSpinner').hide();
      $('#combinedImageModal').modal('hide');
    }
  });

  $(document).on('keydown', function (e) {
    if (!combinedIsImageLoaded || !$('#combinedImageModal').hasClass('show')) return;
    switch (e.key) {
      case 'ArrowUp':
        imageY -= 10 / zoomLevel;
        drawCanvasImage();
        e.preventDefault();
        break;
      case 'ArrowDown':
        imageY += 10 / zoomLevel;
        drawCanvasImage();
        e.preventDefault();
        break;
      case 'ArrowLeft':
        imageX -= 10 / zoomLevel;
        drawCanvasImage();
        e.preventDefault();
        break;
      case 'ArrowRight':
        imageX += 10 / zoomLevel;
        drawCanvasImage();
        e.preventDefault();
        break;
      case '+':
      case '=':
        zoomLevel = Math.min(2, zoomLevel + 0.02);
        $('#combinedZoomSlider').val(zoomLevel);
        drawCanvasImage();
        e.preventDefault();
        break;
      case '-':
        zoomLevel = Math.max(0.1, zoomLevel - 0.02);
        $('#combinedZoomSlider').val(zoomLevel);
        drawCanvasImage();
        e.preventDefault();
        break;
      case 'r':
        rotation = Math.min(180, rotation + 2);
        $('#combinedRotateSlider').val(rotation);
        drawCanvasImage();
        e.preventDefault();
        break;
      case 'l':
        rotation = Math.max(-180, rotation - 2);
        $('#combinedRotateSlider').val(rotation);
        drawCanvasImage();
        e.preventDefault();
        break;
    }
  });
});
// ****** END [F-031] *********************************************************

// ****** [F-032] ****** Load Image Into Canvas ******************************
// TL;DR: Loads an image into the cropping canvas!
// Hey! This function:
// 1. Sets selected image URL and creates new image object
// 2. Shows loading status and sets canvas size on load
// 3. Initializes crop settings and enables controls
// 4. Handles errors with UI feedback
// Where? Called by [F-026] on gallery item click and [F-030] on upload!
// Pro Tip: Search [F-032] to jump here fast! Prepares Cover Page image for cropping!
// ****************************************************************************
function loadImageIntoCanvas(url) {
  combinedSelectedImageUrl = url;
  combinedCurrentImage = new Image();
  combinedCurrentImage.crossOrigin = 'anonymous';
  $('#cropStatusText').text('Loading your image...');
  $('#cropLoadingSpinner').show();
  combinedCurrentImage.onload = function () {
    combinedIsImageLoaded = true;
    combinedCanvas.width = 700;
    combinedCanvas.height = 450;
    const widthRatio = combinedCanvas.width / combinedCurrentImage.width;
    const heightRatio = combinedCanvas.height / combinedCurrentImage.height;
    zoomLevel = Math.min(widthRatio, heightRatio, 1);
    imageX = 0;
    imageY = 0;
    rotation = 0;
    $('#combinedZoomSlider').val(zoomLevel);
    $('#combinedRotateSlider').val(0);
    enableCropControls();
    drawCanvasImage();
    $('#cropStatusText')
      .text('Move, zoom, or rotate your image, then click "Set as Cover".')
      .addClass('text-muted');
    $('#cropLoadingSpinner').hide();
  };
  combinedCurrentImage.onerror = function () {
    $('#cropStatusText').text("Sorry, we couldn't load this image.").addClass('text-danger');
    $('#cropLoadingSpinner').hide();
    disableCropControls();
  };
  combinedCurrentImage.src = url;




}
// ****** END [F-032] *********************************************************
                // --- HEADER DOWNLOAD BUTTON HANDLER ---
                $(document).on('click', '#header-download-pdf-btn', function() {
                    // 1. Find the element to print. This selector targets the main container of the currently active page.
                    const elementToPrint = document.querySelector('#page-content .container, #page-content .a4-page');

                    // 2. Check if there is content to print.
                    if (!elementToPrint) {
                        alert("Could not find any content to download.");
                        return;
                    }

                    // 3. Get the proposal title from the header input for the filename.
                    const proposalTitle = document.getElementById('header-document-title').value || 'Untitled Proposal';
                    const filename = proposalTitle + '.pdf';

                    // 4. Define the options for html2pdf.js for better quality and formatting.
                    const options = {
                        margin: 5, // Margin in mm
                        filename: filename,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 2, // Increases the resolution
                            useCORS: true // Important for loading external images
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        }
                    };

                    // 5. Run the PDF generation and save the file.
                    html2pdf().from(elementToPrint).set(options).save();
                });
// ****** [F-033] ****** Draw Canvas Image ***********************************
// TL;DR: Renders the cropped image on the canvas!
// Hey! This function:
// 1. Clears canvas and applies transformations
// 2. Draws image with current position, zoom, and rotation
// 3. Uses requestAnimationFrame for smooth rendering
// Where? Called by [F-031] controls, [F-032] load, and [F-034] reset!
// Pro Tip: Search [F-033] to jump here fast! Displays Cover Page crop preview!
// ****************************************************************************
function drawCanvasImage() {
  if (!combinedCurrentImage) return;
  requestAnimationFrame(() => {
    combinedCtx.clearRect(0, 0, combinedCanvas.width, combinedCanvas.height);
    combinedCtx.save();
    combinedCtx.translate(combinedCanvas.width / 2, combinedCanvas.height / 2);
    combinedCtx.rotate((rotation * Math.PI) / 180);
    combinedCtx.scale(zoomLevel, zoomLevel);
    const w = combinedCurrentImage.width;
    const h = combinedCurrentImage.height;
    combinedCtx.drawImage(combinedCurrentImage, imageX - w / 2, imageY - h / 2, w, h);
    combinedCtx.restore();
  });
}
// ****** END [F-033] *********************************************************

// ****** [F-034] ****** Reset Crop ******************************************
// TL;DR: Resets crop settings to initial state!
// Hey! This function:
// 1. Recalculates zoom to fit image in canvas
// 2. Resets position and rotation to zero
// 3. Redraws the image with new settings
// Where? Called by [F-027] on delete and [F-031] reset button!
// Pro Tip: Search [F-034] to jump here fast! Resets Cover Page crop adjustments!
// ****************************************************************************
function resetCrop() {
  if (!combinedCurrentImage) return;
  const widthRatio = combinedCanvas.width / combinedCurrentImage.width;
  const heightRatio = combinedCanvas.height / combinedCurrentImage.height;
  zoomLevel = Math.min(widthRatio, heightRatio, 1);
  imageX = 0;
  imageY = 0;
  rotation = 0;
  $('#combinedZoomSlider').val(zoomLevel);
  $('#combinedRotateSlider').val(0);
  drawCanvasImage();
}
// ****** END [F-034] *********************************************************

    // ****** Enable/Disable Crop Controls ****************
    function enableCropControls() { $('.crop-controls button, .crop-controls input, #combinedResetBtn, #combinedSetCoverBtn').prop('disabled', false); }
    function disableCropControls() { $('.crop-controls button, .crop-controls input, #combinedResetBtn, #combinedSetCoverBtn').prop('disabled', true); }
}
            // =================================================================
            // === ðŸš€ APPLICATION ROUTER & MAIN INITIALIZATION
            // =================================================================
            // AI NOTE: This is the main entry point of the application that runs
            // when the DOM is fully loaded. It handles:
            // - Page navigation and routing
            // - Zoom functionality setup
            // - Global event handler registration
            // - Initial page loading
            // - Firebase initialization
            // - External modal loading

            // This is the main entry point of the application
            // It handles page routing, zoom functionality, and global event setup

            /**
             * ðŸŽ¯ Main application initialization and routing
             * This function runs when the DOM is fully loaded and:
             * - Sets up page navigation
             * - Initializes zoom functionality
             * - Sets up global event handlers
             * - Loads the initial page
             */
            $(document).ready(function() {
                const pageContentEl = document.getElementById('page-content');
                const sidebarLinks = document.querySelectorAll('#main-sidebar a.nav-link');
                const activeIndicator = document.getElementById('active-nav-indicator');

                // Make setActiveLink globally available
                window.setActiveLink = (link) => {
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    if (activeIndicator) {
                        activeIndicator.style.transform = `translateY(${link.offsetTop}px)`;
                        activeIndicator.style.height = `${link.offsetHeight}px`;
                        activeIndicator.style.opacity = '1';
                    }
                };

                // =================================================================
                // === ðŸ" PAGE ZOOM FUNCTIONALITY
                // =================================================================
                // AI NOTE: This section implements page zoom functionality that allows
                // users to scale the page content. The zoom level is:
                // - Stored in localStorage for persistence
                // - Applied to the main content container
                // - Limited between 50% and 150%
                // - Updated via zoom in/out buttons and keyboard shortcuts

                // Zoom functionality allows users to scale the page content
                // This is useful for viewing proposals on different screen sizes

                let currentZoom = parseFloat(localStorage.getItem('propokitPageZoom')) || 1.0;

                /**
                 * ðŸ" Applies zoom transformation to the current page
                 * This function scales the page content to the specified zoom level
                 * The zoom is applied to the main content container
                 * @param {number} zoomLevel - Zoom level to apply (0.5 = 50%, 1.0 = 100%, 1.5 = 150%)
                 */
                function applyZoom(zoomLevel) {
                    // Apply zoom to both container types (cover page and company intro page)
                    const a4Container = document.querySelector('#page-content .container, #page-content .a4-page');
                    if (a4Container) {
                        a4Container.style.transform = `scale(${zoomLevel})`;
                        a4Container.style.transformOrigin = 'top center';
                        const zoomDisplay = document.getElementById('zoom-level-display');
                        if (zoomDisplay) zoomDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                        console.log('Zoom applied:', zoomLevel, 'to element:', a4Container.className);
                    } else {
                        // Simple retry with a short delay
                        setTimeout(() => applyZoom(zoomLevel), 50);
                    }
                }

                // Keep company-intro FABs pinned to viewport (not affected by zoom transforms)
                function pinCompanyIntroFABs() {
                    ['editTextButton','editFooterButton','openCropModalBtn'].forEach((id) => {
                        const el = document.getElementById(id);
                        if (!el) return;

                        // Force move to body to avoid zoom scaling
                        if (el.parentElement !== document.body) {
                            el.remove();
                            document.body.appendChild(el);
                        }

                        // Only force position - let CSS classes handle styling
                        el.style.position = 'fixed';
                        el.style.right = '20px';
                        el.style.zIndex = '9999';
                        el.style.top = id === 'openCropModalBtn' ? '150px' : id === 'editTextButton' ? '220px' : '290px';
                    });
                }

                function saveZoomPreference(zoomLevel) {
                    localStorage.setItem('propokitPageZoom', zoomLevel);
                }

                // Initialize zoom controls
                $(document).on('click', '#zoom-in-btn', function() {
                    currentZoom = Math.min(1.5, currentZoom + 0.1);
                    applyZoom(currentZoom);
                    saveZoomPreference(currentZoom);
                    pinCompanyIntroFABs();
                });

                $(document).on('click', '#zoom-out-btn', function() {
                    currentZoom = Math.max(0.5, currentZoom - 0.1);
                    applyZoom(currentZoom);
                    saveZoomPreference(currentZoom);
                    pinCompanyIntroFABs();
                });

                /**
                 * ðŸ"„ Loads a page by name and initializes its functionality
                 * This function handles page navigation and sets up the appropriate
                 * functionality for each page type (cover page, company intro, etc.)
                 * @param {string} pageName - Name of the page to load (e.g., 'cover-page', 'company-intro')
                 */
                const loadPage = (pageName) => {
                    const page = pageTemplates[pageName];
                    if (!page) {
                        pageContentEl.innerHTML = "<div class='a4-container'><h2>Error 404: Page Not Found</h2></div>";
                        return;
                    }

                    // Apply zoom to page-content BEFORE loading new content to prevent jumping
                    if (currentZoom !== 1.0) {
                        pageContentEl.style.transform = `scale(${currentZoom})`;
                        pageContentEl.style.transformOrigin = 'top center';
                    }

                    pageContentEl.innerHTML = page.html;

                    // Ensure company-intro FABs are positioned BEFORE page init
                    if (pageName === 'company-intro') {
                        // Force position buttons immediately after HTML is loaded
                        const forcePin = () => {
                            ['editTextButton','editFooterButton','openCropModalBtn'].forEach((id) => {
                                const el = document.getElementById(id);
                                if (!el) return;

                                // Force move to body to avoid zoom scaling
                                if (el.parentElement !== document.body) {
                                    el.remove();
                                    document.body.appendChild(el);
                                }

                                // Only force position - let CSS classes handle styling
                                el.style.position = 'fixed';
                                el.style.right = '20px';
                                el.style.zIndex = '9999';
                                el.style.top = id === 'openCropModalBtn' ? '150px' : id === 'editTextButton' ? '220px' : '290px';
                            });
                        };

                        // Position immediately after HTML load
                        forcePin();
                        // Also try with small delays to catch any timing issues
                        setTimeout(forcePin, 10);
                        setTimeout(forcePin, 50);
                        setTimeout(forcePin, 200);
                    } else {
                        // Remove company-intro FABs when leaving the page
                        ['editTextButton','editFooterButton','openCropModalBtn'].forEach((id) => {
                            const el = document.getElementById(id);
                            if (el && el.parentElement === document.body) el.remove();
                        });
                    }

                    if (page.init) page.init();

                    console.log('Loading page:', pageName, 'with zoom:', currentZoom);

                    // Apply zoom to the new content and remove the temporary transform
                    requestAnimationFrame(() => {
                        applyZoom(currentZoom);
                        // Remove the temporary transform from page-content
                        pageContentEl.style.transform = '';
                        pageContentEl.style.transformOrigin = '';
                    });
                };



                sidebarLinks.forEach(link => {
                    link.addEventListener('click', (event) => {
                        event.preventDefault();
                        const pageName = event.currentTarget.dataset.page;
                        setActiveLink(event.currentTarget);
                        loadPage(pageName);
                    });
                });

                // =================================================================
                // === ðŸŽ¯ GLOBAL EVENT HANDLERS
                // =================================================================
                // AI NOTE: This section contains global event handlers that respond
                // to user interactions throughout the application. These handlers:
                // - Use jQuery's event delegation for dynamic content
                // - Handle modal actions (save, cancel, etc.)
                // - Process form submissions and data updates
                // - Update Firebase database when changes occur
                // - Provide user feedback and error handling

                // These event handlers respond to user interactions throughout the app
                // They handle modal actions, form submissions, and other user events

                // ðŸ¢ Company info modal save handler
                // Saves company information changes to Firebase database
                $(document).on('click', '#saveChangesBtn', function() {
                    if (!window.companyInfoRef || !window.currentFirebaseUID) return alert("Please log in first.");
                    window.companyInfoRef.set({
                        companyName: $('#companyName').val(),
                        companyAddress: $('#companyAddress').val(),
                        companyPhone: $('#companyPhone').val(),
                        companyEmail: $('#companyEmail').val(),
                        companyWebsite: $('#companyWebsite').val()
                    });
                    $('#infoModal').modal('hide');
                });

                // NOTE: submitBtn handler moved to pages/cover-page-Models.html for better UX with loading states

                // *** MODIFIED BUTTON HANDLER ***
                $(document).on('click', '#generateQR', function() {
                    // Validate at least one QR code is selected
                    const websiteChecked = $('#websiteUrlCheckbox').is(':checked');
                    const pdfChecked = $('#pdfCheckbox').is(':checked');
                    const customChecked = $('#customCheckbox').is(':checked');

                    if (!websiteChecked && !pdfChecked && !customChecked) {
                        alert('Please select at least one QR code type to generate.');
                        return;
                    }

                    // Validate URLs for checked items
                    const websiteUrl = $('#websiteUrlInput').val().trim();
                    const pdfUrl = $('#pdfUrlInput').val().trim();
                    const customUrl = $('#customUrlInput').val().trim();

                    if (websiteChecked && !websiteUrl) {
                        alert('Please enter a website URL or uncheck the website option.');
                        $('#websiteUrlInput').focus();
                        return;
                    }

                    if (pdfChecked && !pdfUrl) {
                        alert('Please enter a document/PDF URL or uncheck the document option.');
                        $('#pdfUrlInput').focus();
                        return;
                    }

                    if (customChecked && !customUrl) {
                        alert('Please enter a custom link URL or uncheck the custom option.');
                        $('#customUrlInput').focus();
                        return;
                    }

                    // Create a complete data object, including the checkbox states
                    const qrData = {
                        websiteUrl: websiteUrl,
                        pdfUrl: pdfUrl,
                        customUrl: customUrl,
                        customLabel: $('#customLabelInput').val().trim() || 'Custom Link',
                        showWebsiteQr: websiteChecked && websiteUrl,
                        showPdfQr: pdfChecked && pdfUrl,
                        showCustomQr: customChecked && customUrl
                    };

                    // If Firebase is available, save to Firebase
                    if (window.qrCodesRef && window.currentFirebaseUID) {
                        window.qrCodesRef.set(qrData);
                        $('#qrModal').modal('hide');
                    } else {
                        // If no Firebase login, save to localStorage and generate QR codes directly
                        localStorage.setItem('qrCodesData', JSON.stringify(qrData));
                        generatePageQRCodes(qrData);
                        $('#qrModal').modal('hide');

                        // Show success message
                        const qrCount = [qrData.showWebsiteQr, qrData.showPdfQr, qrData.showCustomQr].filter(Boolean).length;
                        alert(`âœ… ${qrCount} QR code(s) added to your proposal! They will appear on the cover page.`);
                    }
                });

                // =================================================================
                // === ðŸ"ž CONTACT FIELD TOGGLE FUNCTIONALITY
                // =================================================================
                // AI NOTE: This section implements dynamic contact field visibility
                // that allows users to show/hide optional customer information:
                // - Phone number field (optional)
                // - Email address field (optional)
                // - Physical address field (optional)
                // - Fields are controlled by checkboxes in the customer details modal
                // - Hidden fields are cleared to maintain data integrity

                // This functionality allows users to show/hide optional contact fields
                // Users can choose which customer information to display on proposals

                /**
                 * ðŸ" Global function for toggling contact field visibility
                 * This function shows or hides contact fields based on checkbox selections
                 * It also clears the field content when hiding to maintain data integrity
                 * @param {string} type - Type of contact field ('phone', 'email', 'address')
                 */
                window.toggleContact = function(type) {
                    if (type === 'phone') {
                        const isChecked = $('#selectPhone').is(':checked');
                        $('#phoneInputGroup').toggle(isChecked);
                        $('#phoneParent').toggle(isChecked);

                        // Clear phone field if unchecked
                        if (!isChecked) {
                            $('#customerPhoneInput').val('');
                            $('#customerPhone').text('');
                        }
                    } else if (type === 'email') {
                        const isChecked = $('#selectEmail').is(':checked');
                        $('#emailInputGroup').toggle(isChecked);
                        $('#emailParent').toggle(isChecked);

                        // Clear email field if unchecked
                        if (!isChecked) {
                            $('#customerEmailInput').val('');
                            $('#customerEmail').text('');
                        }
                    } else if (type === 'address') {
                        const isChecked = $('#selectAddress').is(':checked');
                        $('#addressInputGroup').toggle(isChecked);
                        $('#addressParent').toggle(isChecked);

                        // Clear address field if unchecked
                        if (!isChecked) {
                            $('#customerAddressInput').val('');
                            $('#customerAddress').text('');
                        }
                    }
                };

                // Initialize contact field visibility on modal show
                $(document).on('shown.bs.modal', '#myModal', function() {
                    // Set initial state based on checkboxes
                    $('#phoneInputGroup').toggle($('#selectPhone').is(':checked'));
                    $('#phoneParent').toggle($('#selectPhone').is(':checked'));
                    $('#emailInputGroup').toggle($('#selectEmail').is(':checked'));
                    $('#emailParent').toggle($('#selectEmail').is(':checked'));
                    $('#addressInputGroup').toggle($('#selectAddress').is(':checked'));
                    $('#addressParent').toggle($('#selectAddress').is(':checked'));
                });

                $('#customerPhoneInput').mask('(000) 000-0000');

                // =================================================================
                // === ðŸš€ APPLICATION INITIALIZATION
                // =================================================================
                // AI NOTE: This section handles the startup sequence when the app
                // first loads. The initialization process:
                // - Notifies parent window (for Wix integration)
                // - Loads saved Firebase user ID from localStorage
                // - Sets up initial page (cover page by default)
                // - Applies saved zoom preferences
                // - Tests QR code library availability
                // - Prepares the app for user interaction

                // This section handles the startup sequence when the app first loads
                // It sets up initial state, loads saved preferences, and starts the app

                // ðŸŒ Notify parent window that iframe is ready (for Wix integration)
                window.parent.postMessage("iframeReady", "*");

                // ðŸ"¥ Load stored Firebase UID if available (for returning users)
                const storedUID = localStorage.getItem("firebaseUID");
                if (storedUID) {
                    reinitializeFirebaseRefs(storedUID);
                }

                // ðŸ"„ Load initial page (cover page) as the default landing page
                const initialActiveLink = document.querySelector('#main-sidebar a.nav-link[data-page="cover-page"]');
                if (initialActiveLink) {
                    setActiveLink(initialActiveLink);
                    loadPage(initialActiveLink.dataset.page);
                }

                // ðŸ" Apply initial zoom after page loads (restore user's zoom preference)
                setTimeout(() => applyZoom(currentZoom), 200);

                // ðŸ"± Test QR code library availability (ensure QR functionality works)
                setTimeout(() => {
                    if (typeof QRCode === 'undefined') {
                        console.error('QRCode library not loaded! QR functionality will not work.');
                    } else {
                        console.log('QRCode library loaded successfully');
                    }
                }, 500);


                // =================================================================
                // === ðŸ" EXTERNAL MODAL LOADING
                // =================================================================
                // AI NOTE: This section loads modal dialogs from external HTML files
                // to keep the main file modular and maintainable. The approach:
                // - Uses jQuery's $.get() to fetch external HTML files
                // - Appends modal HTML to the document body
                // - Initializes modal-specific functionality after loading
                // - Provides error handling if modals fail to load
                // - Keeps the main file focused on core functionality

                // This section loads modal dialogs from external HTML files
                // This keeps the main file cleaner and allows for modular modal management

                // ðŸ" Load cover page modals (image management, QR codes, customer details)
                $.get('pages/cover-page-Models.html')
                    .done(modalHtml => {
                        $('body').append(modalHtml);
                        // Initialize image modal features after HTML is loaded
                        initAllImageModalFeatures();
                    })
                    .fail(() => console.error("Failed to load external modals for the cover page."));

                // ðŸ"¢ Load company intro modals (text editing, footer editing, image cropping)
                $.get('pages/Company-intro-Models.html')
                    .done(modalHtml => {
                        $('body').append(modalHtml);
                        // Any JavaScript needed to initialize these new modals will go here.
                    })
                    .fail(() => console.error("Failed to load external modals for the company intro page."));


            });
        })();
    </script>


    <!-- ==================================================
         ðŸ" EXTERNAL SCRIPTS & FINAL INITIALIZATION
         ================================================== -->

    <!-- ðŸ"§ Local Firebase Testing (only works locally, not on Wix) -->
    <!-- This script provides local testing capabilities for Firebase functionality -->
    <script>
        // ðŸš€ Initialize local Firebase testing environment
        // const localTest = new LocalFirebaseTest();
        // localTest.init();

        // ðŸ"¥ Set the Firebase UID from localStorage if it exists (for returning users)
        const savedUID = localStorage.getItem("firebaseUID");
        if (savedUID && !window.currentFirebaseUID) {
            window.currentFirebaseUID = savedUID;
            console.log("Loaded Firebase UID from localStorage:", window.currentFirebaseUID);
        }
    </script>

    <!-- ðŸŽ¯ Main Application Controller -->
    <!-- This script handles additional routing and UI functionality -->
    <script src="js\shared\app-router.js"></script>

    <!-- ==================================================
         ðŸ¤– AI DEVELOPER QUICK REFERENCE
         ================================================== -->
    <!--
        ðŸš€ QUICK START FOR AI DEVELOPERS:

        ðŸ" KEY SECTIONS TO MODIFY:
        - CSS THEMES: Lines ~150-300 (color variables and theme classes)
        - HTML TEMPLATES: Lines ~2750-2850 (page content templates)
        - FIREBASE CONFIG: Lines ~3320-3350 (backend configuration)
        - UI FUNCTIONS: Lines ~3360-3500 (interface update functions)
        - PAGE INIT: Lines ~3560-3650 (page setup functions)
        - EVENT HANDLERS: Lines ~4200-4300 (user interaction handling)

        ðŸ"§ COMMON MODIFICATIONS:
        - Add new color theme: Copy existing theme class and modify colors
        - Add new page: Create HTML template + add to pageTemplates object
        - Add new feature: Create function + add to appropriate section
        - Modify styling: Find CSS section and update properties

        ðŸ"± FEATURE LOCATIONS:
        - QR Code generation: Lines ~4000-4100
        - Image management: Lines ~4100-4200
        - PDF export: Lines ~4200-4300
        - Zoom functionality: Lines ~4300-4400

        ðŸŽ¯ REMEMBER: All functions have JSDoc comments explaining their purpose!
    -->

<!-- ========================================================
     CUSTOMER INFO MODAL - Complete HTML Structure
     ======================================================== -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Enhanced Header with Progress Indicator -->
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title" id="myModalLabel">
              <span class="title-main">Customer Info</span>
              <span class="title-subtitle">Enter customer details</span>
            </h5>
          </div>
        </div>
        <button type="button" class="close customer-close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Customer</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Phone/Email</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Proposal</div>
          </div>
        </div>

        <form id="proposal-form" class="customer-form">
          <!-- Step 1: Basic Information -->
          <div class="form-step active" data-step="1">
            <div class="step-header">
              <h6><i class="fas fa-user"></i> Customer Information</h6>
            </div>

            <div class="contact-option step1-customer-field">
              <div class="option-header">
                <label for="customerNameInput" class="option-label">
                  <i class="fas fa-user-tag"></i>
                  <span>Customer's Full Name</span>
                  <span class="required">*</span>
                </label>
              </div>
              <div class="option-description">
                Customer name for the proposal
              </div>
              <div class="form-group customer-form-group">
                <input type="text" class="form-control customer-input" id="customerNameInput"
                       placeholder="Enter customer's full name" required>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-user-check"></i>
                  This will appear as the main customer name on the cover page
                </small>
              </div>
            </div>

            <div class="contact-option step1-address-field">
              <div class="option-header">
                <input type="checkbox" id="selectAddress" name="contact" value="Address"
                       onclick="toggleContact('address')" checked>
                <label for="selectAddress" class="option-label">
                  <i class="fas fa-map-marker-alt"></i>
                  <span>Include Address</span>
                </label>
              </div>
              <div class="option-description">
                Include address on cover page
              </div>
              <div class="form-group customer-form-group" id="addressInputGroup">
                <input type="text" class="form-control customer-input" id="customerAddressInput"
                       placeholder="Enter complete address (street, city, state, zip)">
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-info-circle"></i>
                  Address autocomplete available - start typing to see suggestions
                </small>
              </div>
            </div>
          </div>

          <!-- Step 2: Contact Information -->
          <div class="form-step" data-step="2">
            <div class="step-header">
              <h6><i class="fas fa-address-book"></i> Contact Options</h6>
            </div>

            <div class="contact-options">
              <div class="contact-option">
                <div class="option-header">
                  <input type="checkbox" id="selectPhone" name="contact" value="Phone"
                         onclick="toggleContact('phone')" checked>
                  <label for="selectPhone" class="option-label">
                    <i class="fas fa-phone"></i>
                    <span>Include Phone Number</span>
                  </label>
                </div>
                <div class="option-description">
                  Include phone on cover page
                </div>
                <div class="form-group customer-form-group" id="phoneInputGroup">
                  <input type="text" class="form-control customer-input" id="customerPhoneInput"
                         placeholder="(123) 456-7890">
                  <div class="input-focus-border"></div>
                  <small class="form-text">
                    <i class="fas fa-check-circle"></i>
                    Format will be automatically applied
                  </small>
                </div>
              </div>

              <div class="contact-option">
                <div class="option-header">
                  <input type="checkbox" id="selectEmail" name="contact" value="Email"
                         onclick="toggleContact('email')">
                  <label for="selectEmail" class="option-label">
                    <i class="fas fa-envelope"></i>
                    <span>Include Email Address</span>
                  </label>
                </div>
                <div class="option-description">
                  Include email on cover page
                </div>
                <div class="form-group customer-form-group" id="emailInputGroup">
                  <input type="email" class="form-control customer-input" id="customerEmailInput"
                         placeholder="customer@email.com">
                  <div class="input-focus-border"></div>
                  <small class="form-text">
                    <i class="fas fa-shield-alt"></i>
                    Email will be displayed securely
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Proposal Details -->
          <div class="form-step" data-step="3">
            <div class="step-header">
              <h6><i class="fas fa-file-contract"></i> Proposal Details</h6>
            </div>

            <div class="contact-option step3-proposal-field">
              <div class="option-header">
                <label for="proposalInfoInput" class="option-label">
                  <i class="fas fa-info-circle"></i>
                  <span>Proposal Description</span>
                </label>
              </div>
              <div class="option-description">
                Add context about what this proposal covers
              </div>
              <div class="form-group customer-form-group">
                <textarea class="form-control customer-input" id="proposalInfoInput" rows="3"
                          placeholder="Brief description of the proposal or project scope"></textarea>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-lightbulb"></i>
                  Optional: This helps provide context for the proposal
                </small>
              </div>
            </div>

            <div class="contact-option step3-date-field">
              <div class="option-header">
                <label for="proposalDateInput" class="option-label">
                  <i class="fas fa-calendar-alt"></i>
                  <span>Proposal Date</span>
                  <span class="required">*</span>
                </label>
              </div>
              <div class="option-description">
                Set the date for when this proposal is prepared
              </div>
              <div class="form-group customer-form-group">
                <input type="date" class="form-control customer-input" id="proposalDateInput" required>
                <div class="input-focus-border"></div>
                <small class="form-text">
                  <i class="fas fa-clock"></i>
                  Today's date will be used if not specified
                </small>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Enhanced Footer with Navigation -->
      <div class="modal-footer">
        <div class="footer-left">
          <button type="button" class="btn btn-outline-secondary" id="prevStepBtn">
            <i class="fas fa-arrow-left"></i> Previous
          </button>
        </div>

        <div class="footer-center">
          <!-- Step indicator removed for cleaner look -->
        </div>

        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="nextStepBtn">
            Next <i class="fas fa-arrow-right"></i>
          </button>
          <button type="button" class="btn btn-success" id="submitBtn">
            <i class="fas fa-check"></i> Save Customer Info
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
