<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Authentication Test - Propokit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3367d6; }
        button.success { background: #10b981; }
        button.danger { background: #ef4444; }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.authenticated { background: #d4edda; color: #155724; }
        .status.not-authenticated { background: #f8d7da; color: #721c24; }
        .flow-diagram {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .step {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4285f4;
            padding-left: 10px;
        }
        .step.success { border-left-color: #10b981; }
        .step.error { border-left-color: #ef4444; }
        .step.pending { border-left-color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Real Authentication Flow Test</h1>
        <p>This test simulates the actual authentication flow used in your Propokit app.</p>
        
        <div class="test-section">
            <h3>Current Status</h3>
            <div id="auth-status" class="status not-authenticated">
                Checking authentication status...
            </div>
        </div>
        
        <div class="test-section">
            <h3>Authentication Flow Test</h3>
            <div id="flow-results"></div>
            <button onclick="testFullAuthFlow()">Test Full Authentication Flow</button>
            <button onclick="testLoginPage()" class="success">Test Login Page</button>
            <button onclick="testMainApp()" class="success">Test Main App</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div class="test-section">
            <h3>Firebase Configuration Test</h3>
            <div id="firebase-results"></div>
            <button onclick="testFirebaseConfig()">Test Firebase Config</button>
            <button onclick="testDomainAuth()">Test Domain Authorization</button>
        </div>
        
        <div class="test-section">
            <h3>App Integration Test</h3>
            <div id="integration-results"></div>
            <button onclick="testAppIntegration()">Test App Integration</button>
            <button onclick="testUIDManagement()">Test UID Management</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="js/shared/firebase-config.js"></script>

    <script>
        let testResults = [];
        
        function addResult(section, message, type = 'info') {
            const results = document.getElementById(section + '-results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(`[${section.toUpperCase()}] ${message}`);
            testResults.push({section, message, type, timestamp: new Date()});
        }
        
        function clearResults() {
            document.querySelectorAll('[id$="-results"]').forEach(el => el.innerHTML = '');
            testResults = [];
        }
        
        function updateAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            if (typeof firebase !== 'undefined' && firebase.auth) {
                const currentUser = firebase.auth().currentUser;
                const storedUID = localStorage.getItem('firebaseUID');
                
                if (currentUser || storedUID) {
                    statusDiv.className = 'status authenticated';
                    statusDiv.textContent = `‚úÖ Authenticated: ${currentUser ? currentUser.email : 'Stored UID found'}`;
                } else {
                    statusDiv.className = 'status not-authenticated';
                    statusDiv.textContent = '‚ùå Not authenticated';
                }
            } else {
                statusDiv.className = 'status not-authenticated';
                statusDiv.textContent = '‚è≥ Firebase not loaded';
            }
        }
        
        function testFullAuthFlow() {
            addResult('flow', 'üöÄ Starting full authentication flow test...', 'info');
            
            const steps = [
                {name: 'Firebase Loaded', test: () => typeof firebase !== 'undefined'},
                {name: 'Auth Available', test: () => firebase.auth !== undefined},
                {name: 'Domain Authorized', test: () => {
                    const currentDomain = window.location.hostname;
                    const authDomain = firebase.app().options.authDomain;
                    return authDomain && authDomain.includes(currentDomain);
                }},
                {name: 'Google Provider', test: () => {
                    try {
                        new firebase.auth.GoogleAuthProvider();
                        return true;
                    } catch (e) {
                        return false;
                    }
                }},
                {name: 'Current User', test: () => firebase.auth().currentUser !== null},
                {name: 'Stored UID', test: () => localStorage.getItem('firebaseUID') !== null},
                {name: 'App Ready', test: () => window.currentFirebaseUID !== undefined}
            ];
            
            let flowHTML = '<div class="flow-diagram">';
            flowHTML += '<h4>Authentication Flow Steps:</h4>';
            
            steps.forEach((step, index) => {
                const result = step.test();
                const status = result ? 'success' : 'error';
                const icon = result ? '‚úÖ' : '‚ùå';
                
                flowHTML += `<div class="step ${status}">${icon} Step ${index + 1}: ${step.name}</div>`;
                addResult('flow', `${icon} Step ${index + 1}: ${step.name}`, result ? 'success' : 'error');
            });
            
            flowHTML += '</div>';
            document.getElementById('flow-results').innerHTML = flowHTML;
        }
        
        function testFirebaseConfig() {
            addResult('firebase', 'üîß Testing Firebase configuration...', 'info');
            
            try {
                if (typeof firebase === 'undefined') {
                    addResult('firebase', '‚ùå Firebase SDK not loaded', 'error');
                    return;
                }
                addResult('firebase', '‚úÖ Firebase SDK loaded', 'success');
                
                const app = firebase.app();
                addResult('firebase', `‚úÖ Firebase app: ${app.options.projectId}`, 'success');
                
                if (!firebase.auth) {
                    addResult('firebase', '‚ùå Firebase Auth not available', 'error');
                    return;
                }
                addResult('firebase', '‚úÖ Firebase Auth available', 'success');
                
                const currentUser = firebase.auth().currentUser;
                const storedUID = localStorage.getItem('firebaseUID');
                
                if (currentUser) {
                    addResult('firebase', `‚úÖ Current user: ${currentUser.email}`, 'success');
                } else if (storedUID) {
                    addResult('firebase', `‚úÖ Stored UID: ${storedUID}`, 'success');
                } else {
                    addResult('firebase', '‚ùå No authenticated user', 'error');
                }
                
                // Test Google provider
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    addResult('firebase', '‚úÖ Google Auth Provider created', 'success');
                } catch (e) {
                    addResult('firebase', `‚ùå Google Auth Provider failed: ${e.message}`, 'error');
                }
                
            } catch (error) {
                addResult('firebase', `‚ùå Firebase check failed: ${error.message}`, 'error');
            }
        }
        
        function testDomainAuth() {
            addResult('firebase', 'üåê Testing domain authorization...', 'info');
            
            const currentDomain = window.location.hostname;
            const authDomain = firebase.app().options.authDomain;
            
            addResult('firebase', `Current domain: ${currentDomain}`, 'info');
            addResult('firebase', `Auth domain: ${authDomain}`, 'info');
            
            if (authDomain && authDomain.includes(currentDomain)) {
                addResult('firebase', '‚úÖ Domain is authorized', 'success');
            } else {
                addResult('firebase', '‚ùå Domain NOT authorized - This is the issue!', 'error');
                addResult('firebase', 'üí° Fix: Add your domain to Firebase Console > Authentication > Settings > Authorized domains', 'warning');
            }
        }
        
        function testAppIntegration() {
            addResult('integration', 'üîó Testing app integration...', 'info');
            
            // Test if app-specific variables exist
            const appVars = [
                'window.currentFirebaseUID',
                'window.companyInfoRef',
                'window.proposalDataRef',
                'window.qrCodesRef',
                'window.coverImageRef'
            ];
            
            appVars.forEach(varName => {
                const exists = eval(varName) !== undefined;
                addResult('integration', `${exists ? '‚úÖ' : '‚ùå'} ${varName}`, exists ? 'success' : 'error');
            });
            
            // Test localStorage integration
            const storedUID = localStorage.getItem('firebaseUID');
            addResult('integration', `localStorage firebaseUID: ${storedUID || 'None'}`, storedUID ? 'success' : 'warning');
        }
        
        function testUIDManagement() {
            addResult('integration', 'üÜî Testing UID management...', 'info');
            
            const currentUser = firebase.auth().currentUser;
            const storedUID = localStorage.getItem('firebaseUID');
            const windowUID = window.currentFirebaseUID;
            
            addResult('integration', `Firebase currentUser: ${currentUser ? currentUser.uid : 'None'}`, currentUser ? 'success' : 'warning');
            addResult('integration', `localStorage UID: ${storedUID || 'None'}`, storedUID ? 'success' : 'warning');
            addResult('integration', `window.currentFirebaseUID: ${windowUID || 'None'}`, windowUID ? 'success' : 'warning');
            
            // Check consistency
            const uids = [currentUser?.uid, storedUID, windowUID].filter(Boolean);
            const uniqueUIDs = [...new Set(uids)];
            
            if (uniqueUIDs.length === 0) {
                addResult('integration', '‚ùå No UID found anywhere', 'error');
            } else if (uniqueUIDs.length === 1) {
                addResult('integration', '‚úÖ All UIDs are consistent', 'success');
            } else {
                addResult('integration', `‚ö†Ô∏è UID mismatch: ${uniqueUIDs.join(', ')}`, 'warning');
            }
        }
        
        function testLoginPage() {
            addResult('flow', 'üîó Opening login page...', 'info');
            window.open('login.html', '_blank');
        }
        
        function testMainApp() {
            addResult('flow', 'üîó Opening main app...', 'info');
            window.open('index-product.html', '_blank');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addResult('flow', 'üîß Page loaded, checking authentication...', 'info');
            
            // Wait for Firebase and update status
            const checkFirebase = () => {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    updateAuthStatus();
                    
                    // Listen for auth state changes
                    firebase.auth().onAuthStateChanged((user) => {
                        addResult('flow', `üîç Auth state changed: ${user ? user.email : 'No user'}`, 'info');
                        updateAuthStatus();
                    });
                    
                    // Auto-run basic tests
                    setTimeout(() => {
                        testFirebaseConfig();
                        testDomainAuth();
                        testAppIntegration();
                    }, 1000);
                } else {
                    setTimeout(checkFirebase, 100);
                }
            };
            
            checkFirebase();
        });
    </script>
</body>
</html>
